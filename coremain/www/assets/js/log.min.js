let savedScrollY=0;function lockScroll(){savedScrollY=window.scrollY,document.body.style.position="fixed",document.body.style.top=`-${savedScrollY}px`,document.body.style.width="100%",document.body.style.overflowY="scroll"}function unlockScroll(){document.body.style.position="",document.body.style.top="",document.body.style.width="",document.body.style.overflowY="";const e=document.documentElement,t=e.style.scrollBehavior;e.style.scrollBehavior="auto",window.scrollTo(0,savedScrollY),e.style.scrollBehavior=t}function closeAndUnlock(e){e&&e.open&&(unlockScroll(),e.close())}document.addEventListener("DOMContentLoaded",()=>{const e="",t=50,a=60,n=15,s=1e3,o=1024,l=3e3,i=200,r=250,d=1440;let c={isUpdating:!1,isCapturing:!1,isMobile:!1,isTouchDevice:!1,currentLogPage:1,isLogLoading:!1,logPaginationInfo:null,displayedLogs:[],currentLogSearchTerm:"",clientAliases:{},topDomains:[],topClients:[],slowestQueries:[],domainSetRank:[],shuntColors:{},logSort:{key:"query_time",order:"desc"},autoRefresh:{enabled:!1,intervalId:null,intervalSeconds:n},data:{totalQueries:{current:null,previous:null},avgDuration:{current:null,previous:null}},history:{totalQueries:[],avgDuration:[],timestamps:[]},lastUpdateTime:null,adguardRules:[],diversionRules:[],requery:{status:null,config:null,pollId:null},dataView:{rawEntries:[],filteredEntries:[],viewType:"domain",currentOffset:0,currentLimit:100,currentQuery:"",currentConfig:null,hasMore:!0,totalCount:0},coreMode:"A",cacheStats:{},listManagerInitialized:!1,featureSwitches:{},systemInfo:{},update:{status:null,loading:!1,auto:{enabled:!0,intervalMinutes:d,timerId:null}}};const u={html:document.documentElement,body:document.body,container:document.querySelector(".container"),initialLoader:document.getElementById("initial-loader"),colorSwatches:document.querySelectorAll(".color-swatch"),themeSwitcher:document.getElementById("theme-switcher-select"),layoutSwitcher:document.getElementById("layout-density-select"),mainNav:document.querySelector(".main-nav"),navSlider:document.querySelector(".main-nav-slider"),tabLinks:document.querySelectorAll(".tab-link"),tabContents:document.querySelectorAll(".tab-content"),globalRefreshBtn:document.getElementById("global-refresh-btn"),overviewChartModeToggle:document.getElementById("overview-chart-mode-toggle"),independentChartPanel:document.getElementById("independent-chart-panel"),bigSparklineMerged:document.getElementById("big-sparkline-merged"),lastUpdated:document.getElementById("last-updated"),autoRefreshToggle:document.getElementById("auto-refresh-toggle"),autoRefreshIntervalInput:document.getElementById("auto-refresh-interval"),autoRefreshForm:document.getElementById("auto-refresh-form"),totalQueries:document.getElementById("total-queries"),avgDuration:document.getElementById("avg-duration"),totalQueriesChange:document.getElementById("total-queries-change"),avgDurationChange:document.getElementById("avg-duration-change"),sparklineTotal:document.getElementById("sparkline-total"),sparklineAvg:document.getElementById("sparkline-avg"),auditStatus:document.getElementById("audit-status"),toggleAuditBtn:document.getElementById("toggle-audit-btn"),clearAuditBtn:document.getElementById("clear-audit-btn"),auditCapacity:document.getElementById("audit-capacity"),capacityForm:document.getElementById("capacity-form"),newCapacityInput:document.getElementById("new-capacity"),cacheStatsTbody:document.getElementById("cache-stats-tbody"),topDomainsBody:document.getElementById("top-domains-body"),topClientsBody:document.getElementById("top-clients-body"),slowestQueriesBody:document.getElementById("slowest-queries-body"),shuntResultsBody:document.getElementById("shunt-results-body"),overridesModule:document.getElementById("overrides-module"),overrideSocks5Input:document.getElementById("override-socks5-log"),overrideEcsInput:document.getElementById("override-ecs-log"),overridesLoadBtn:document.getElementById("overrides-load-btn-log"),overridesSaveBtn:document.getElementById("overrides-save-btn-log"),logTable:document.getElementById("log-table"),logTableHead:document.getElementById("log-table-head"),logTableBody:document.getElementById("log-table-body"),logQueryTab:document.getElementById("log-query-tab"),logSearch:document.getElementById("log-search"),logQueryTableContainer:document.getElementById("log-query-table-container"),logLoader:document.getElementById("log-loader"),searchResultsInfo:document.getElementById("search-results-info"),toast:document.getElementById("toast"),tooltip:document.getElementById("answers-tooltip"),aliasModal:document.getElementById("alias-modal"),manageAliasesBtn:document.getElementById("manage-aliases-btn"),manageAliasesBtnMobile:document.getElementById("manage-aliases-btn-mobile"),manualAliasForm:document.getElementById("manual-alias-form"),aliasListContainer:document.getElementById("alias-list-container"),importAliasInput:document.getElementById("import-alias-file-input"),saveAllAliasesBtn:document.getElementById("save-all-aliases-btn"),systemControlTabIndicator:document.querySelector('a[data-tab="system-control"] .status-indicator'),addAdguardRuleBtn:document.getElementById("add-adguard-rule-btn"),checkAdguardUpdatesBtn:document.getElementById("check-adguard-updates-btn"),adguardRulesTbody:document.getElementById("adguard-rules-tbody"),addDiversionRuleBtn:document.getElementById("add-diversion-rule-btn"),diversionRulesTbody:document.getElementById("diversion-rules-tbody"),ruleModal:document.getElementById("rule-modal"),modalTitle:document.getElementById("modal-title"),ruleForm:document.getElementById("rule-form"),closeRuleModalBtn:document.getElementById("close-rule-modal"),cancelRuleModalBtn:document.getElementById("cancel-rule-modal-btn"),saveRuleBtn:document.getElementById("save-rule-btn"),ruleMode:document.getElementById("rule-mode"),ruleTypeWrapper:document.getElementById("rule-type-wrapper"),ruleFilesWrapper:document.getElementById("rule-files-wrapper"),rulesSubNavLinks:document.querySelectorAll(".sub-nav-link"),rulesSubTabContents:document.querySelectorAll(".sub-tab-content"),logDetailModal:document.getElementById("log-detail-modal"),logDetailModalBody:document.getElementById("log-detail-modal-body"),closeLogDetailModalBtn:document.getElementById("close-log-detail-modal"),requeryModule:document.getElementById("requery-module"),requeryStatusText:document.getElementById("requery-status-text"),requeryProgressContainer:document.getElementById("requery-progress-container"),requeryProgressBarFill:document.getElementById("requery-progress-bar-fill"),requeryProgressBarText:document.getElementById("requery-progress-bar-text"),requeryLastRun:document.getElementById("requery-last-run"),requeryTriggerBtn:document.getElementById("requery-trigger-btn"),requeryCancelBtn:document.getElementById("requery-cancel-btn"),requerySchedulerForm:document.getElementById("requery-scheduler-form"),requerySchedulerToggle:document.getElementById("requery-scheduler-toggle"),requeryIntervalInput:document.getElementById("requery-interval-input"),requeryDateRangeInput:document.getElementById("requery-date-range-input"),requeryStartDatetimeInput:document.getElementById("requery-start-datetime-input"),requeryDomainStatsTbody:document.getElementById("requery-domain-stats-tbody"),requeryRefreshStatsBtn:document.getElementById("requery-refresh-stats-btn"),updateModule:document.getElementById("update-module"),updateCurrentVersion:document.getElementById("update-current-version"),updateLatestVersion:document.getElementById("update-latest-version"),updateInlineBadge:document.getElementById("update-inline-badge"),updateStatusBanner:document.getElementById("update-status-banner"),updateStatusText:document.getElementById("update-status-text"),updateLastChecked:document.getElementById("update-last-checked"),updateTargetInfo:document.getElementById("update-target-info"),updateCheckBtn:document.getElementById("update-check-btn"),updateApplyBtn:document.getElementById("update-apply-btn"),updateForceBtn:document.getElementById("update-force-btn"),updateV3Callout:document.getElementById("update-v3-callout"),updateV3Btn:document.getElementById("update-v3-btn"),updateAutoToggle:document.getElementById("update-auto-toggle"),updateIntervalInput:document.getElementById("update-interval-input"),updateHintText:document.getElementById("update-hint-text"),fakeipDomainCount:document.getElementById("fakeip-domain-count"),realipDomainCount:document.getElementById("realip-domain-count"),nov4DomainCount:document.getElementById("nov4-domain-count"),nov6DomainCount:document.getElementById("nov6-domain-count"),totalDomainCount:document.getElementById("total-domain-count"),backupDomainCount:document.getElementById("backup-domain-count"),saveShuntRulesBtn:document.getElementById("save-shunt-rules-btn"),clearShuntRulesBtn:document.getElementById("clear-shunt-rules-btn"),dataViewModal:document.getElementById("data-view-modal"),closeDataViewModalBtn:document.getElementById("close-data-view-modal"),dataViewModalTitle:document.getElementById("data-view-modal-title"),dataViewModalBody:document.getElementById("data-view-modal-body"),dataViewSearch:document.getElementById("data-view-search"),dataViewModalInfo:document.getElementById("data-view-modal-info"),dataViewTableContainer:document.getElementById("data-view-table-container"),listMgmtNav:document.querySelector(".list-mgmt-nav"),listContentLoader:document.getElementById("list-content-loader"),listContentTextArea:document.getElementById("list-content-textarea"),listContentInfo:document.getElementById("list-content-info"),listSaveBtn:document.getElementById("list-save-btn"),listMgmtRealIPHint:document.getElementById("list-mgmt-realip-hint"),listMgmtCnFakeipFilterHint:document.getElementById("list-mgmt-cnfakeipfilter-hint"),listMgmtClientIpHint:document.getElementById("list-mgmt-client-ip-hint"),listMgmtDirectIpHint:document.getElementById("list-mgmt-direct-ip-hint"),listMgmtNFTIpHint:document.getElementById("list-mgmt-nft-ip-hint"),listMgmtRewriteHint:document.getElementById("list-mgmt-rewrite-hint"),featureSwitchesModule:document.getElementById("feature-switches-module"),coreModeSwitchGroup:document.getElementById("core-mode-switch-group"),secondarySwitchesContainer:document.getElementById("secondary-switches-container"),systemInfoContainer:document.getElementById("system-info-container")};let m;const p=["top_domains/save","my_fakeiplist/save","my_nodenov4list/save","my_nodenov6list/save","my_notinlist/save","my_nov4list/save","my_nov6list/save","my_realiplist/save"],g=["top_domains/flush","my_fakeiplist/flush","my_nodenov4list/flush","my_nodenov6list/flush","my_notinlist/flush","my_nov4list/flush","my_nov6list/flush","my_realiplist/flush"],h=(e,t)=>{let a;return function(...n){clearTimeout(a),a=setTimeout(()=>{clearTimeout(a),e(...n)},t)}};let y=null,v=0;const f={fetch:async(e,t={})=>{try{const a=await fetch(e,{...t,signal:t.signal});if(!a.ok){let e=`API Error: ${a.status} ${a.statusText}`;try{const t=await a.json();t&&t.error&&(e=t.error)}catch(t){try{e=await a.text()||e}catch(e){}}throw 404!==a.status&&_.showToast(e,"error"),new Error(e)}const n=a.headers.get("X-Total-Count"),s=a.headers.get("content-type"),o=s&&s.includes("application/json")?await a.json():await a.text();return null!==n?{body:o,totalCount:parseInt(n,10)}:o}catch(e){throw"AbortError"!==e.name&&console.error(e),e}},getStatus:t=>f.fetch(`${e}/api/v1/audit/status`,{signal:t}),getCapacity:t=>f.fetch(`${e}/api/v1/audit/capacity`,{signal:t}),start:()=>f.fetch(`${e}/api/v1/audit/start`,{method:"POST"}),stop:()=>f.fetch(`${e}/api/v1/audit/stop`,{method:"POST"}),clear:()=>f.fetch(`${e}/api/v1/audit/clear`,{method:"POST"}),setCapacity:t=>f.fetch(`${e}/api/v1/audit/capacity`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({capacity:parseInt(t,10)})}),getMetrics:e=>{const t=Date.now();return y&&t-v<3e3||(y=f.fetch("/metrics",{signal:e}),v=t),y},getCoreMode:e=>f.fetch("/plugins/switch3/show",{signal:e}),clearCache:e=>f.fetch(`/plugins/${e}/flush`),getCacheContents:(e,t)=>f.fetch(`/plugins/${e}/show`,{signal:t}),v2:{getStats:t=>f.fetch(`${e}/api/v2/audit/stats`,{signal:t}),getTopDomains:(t,a=50)=>f.fetch(`${e}/api/v2/audit/rank/domain?limit=${a}`,{signal:t}),getTopClients:(t,a=50)=>f.fetch(`${e}/api/v2/audit/rank/client?limit=${a}`,{signal:t}),getSlowest:(t,a=50)=>f.fetch(`${e}/api/v2/audit/rank/slowest?limit=${a}`,{signal:t}),getDomainSetRank:(t,a=50)=>f.fetch(`${e}/api/v2/audit/rank/domain_set?limit=${a}`,{signal:t}),getLogs:(a,n={})=>{const s=new URLSearchParams({page:1,limit:t,...n});for(let[e,t]of s.entries())t||s.delete(e);return f.fetch(`${e}/api/v2/audit/logs?${s}`,{signal:a})}}},b={getConfig:e=>f.fetch("/plugins/requery",{signal:e}),getStatus:e=>f.fetch("/plugins/requery/status",{signal:e}),trigger:()=>f.fetch("/plugins/requery/trigger",{method:"POST"}),cancel:()=>f.fetch("/plugins/requery/cancel",{method:"POST"}),updateSchedulerConfig:e=>f.fetch("/plugins/requery/scheduler/config",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})},w=e=>f.fetch("/api/v1/update/status",{signal:e}),S=()=>f.fetch("/api/v1/update/check",{method:"POST"}),T=(e=!1,t=!1)=>f.fetch("/api/v1/update/apply",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({force:e,prefer_v3:t})}),L=e=>"string"==typeof e&&e.startsWith("::ffff:")?e.substring(7):e,I=()=>f.fetch("/plugins/clientname"),E=e=>f.fetch("/plugins/clientname",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),_={showToast(e,t="success"){if(!u.toast)return;clearTimeout(m);const a="success"===t?'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path></svg>':'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"></path></svg>';u.toast.innerHTML=`${a}<span>${e}</span>`,u.toast.className=`show ${t}`;const n=()=>{u.toast.className=u.toast.className.replace("show","")};u.toast.onmouseenter=()=>clearTimeout(m),u.toast.onmouseleave=()=>m=setTimeout(n,l),m=setTimeout(n,l)},setLoading(e,t){if(!e)return;const a=e.querySelector("span");e.disabled=t,e.setAttribute("aria-busy",String(t)),a&&(t?(e.dataset.defaultText||(e.dataset.defaultText=a.textContent),a.textContent="处理中..."):e.dataset.defaultText&&(a.textContent=e.dataset.defaultText))},updateStatus(e){if(!u.toggleAuditBtn||!u.auditStatus)return;this.setLoading(u.toggleAuditBtn,!1);const t=u.systemControlTabIndicator;if(t&&(t.className="status-indicator"),"boolean"==typeof e){c.isCapturing=e,u.auditStatus.textContent=e?"运行中":"已停止",u.auditStatus.style.color=e?"var(--color-success)":"var(--color-danger)";const a=e?"关闭审计":"开启审计";u.toggleAuditBtn.querySelector("span").textContent=a,u.toggleAuditBtn.dataset.defaultText=a,u.toggleAuditBtn.className="button "+(e?"danger":"primary"),t&&t.classList.add(e?"running":"stopped")}else u.auditStatus.textContent="未知",u.auditStatus.style.color="var(--color-text-secondary)",u.toggleAuditBtn.querySelector("span").textContent="刷新状态",u.toggleAuditBtn.dataset.defaultText="刷新状态"},updateCapacity(e){u.auditCapacity&&(u.auditCapacity.textContent=null!=e?`${e.toLocaleString()} 条`:"查询失败")},updateOverviewStats(){const{totalQueries:e,avgDuration:t}=c.data;D(u.totalQueries,e.previous,e.current,s),D(u.avgDuration,t.previous,t.current,s,2),H(u.totalQueriesChange,e.previous,e.current),H(u.avgDurationChange,t.previous,t.current,!0),u.sparklineTotal&&(u.sparklineTotal.innerHTML=V(c.history.totalQueries)),u.sparklineAvg&&(u.sparklineAvg.innerHTML=V(c.history.avgDuration,!0));const a=document.querySelector(".stats-grid")?.classList.contains("independent-mode");if(a&&u.bigSparklineMerged){const e=c.isMobile?400:1e3,t=c.isMobile?220:260;u.bigSparklineMerged.innerHTML=P(c.history.totalQueries,c.history.avgDuration,c.history.timestamps,e,t)}},renderLogTable(e,t=!1){const a=u.logTableBody;if(!a)return;if(t||(a.innerHTML="",c.displayedLogs=[]),0===e.length&&!t)return void F(a,[],()=>{},"log-query");const n=c.displayedLogs.length;c.displayedLogs.push(...e);let s=0;const o=()=>{if(s>=e.length)return;const t=document.createDocumentFragment();for(let a=0;a<50&&s<e.length;a++,s++){const a=ce(e[s],n+s);n+s<20&&a.classList.add("animate-in"),t.appendChild(a)}a.appendChild(t),"undefined"!=typeof window&&"requestIdleCallback"in window?requestIdleCallback(o,{timeout:300}):setTimeout(o,0)};o()},updateSearchResultsInfo(e){u.searchResultsInfo&&(c.currentLogSearchTerm?.query&&e?u.searchResultsInfo.innerHTML=`为您找到 <strong>${e.total_items.toLocaleString()}</strong> 条相关结果`:u.searchResultsInfo.innerHTML="")},openLogDetailModal(e){const t=e.dataset.logIndex?parseInt(e.dataset.logIndex,10):null;let a;"slowest"===(e.dataset.logSource||"log")&&null!==t?a=c.slowestQueries[t]:null!==t&&(a=c.displayedLogs[t]),a&&(u.logDetailModalBody.innerHTML=function(e){if(!e)return"";const t={},a={};let n=[];const{ra:s,aa:o,tc:l}=e.response_flags||{},i=[s&&"RA",o&&"AA",l&&"TC"].filter(Boolean);t["域名"]=ne(e.query_name,e.query_name,e.query_name,!1),t["时间"]=`<span>${ee(e.query_time)}</span>`,t["客户端"]=ne(M.getDisplayName(e.client_ip)+` (${e.client_ip})`,e.client_ip,e.client_ip,!0),t["类型"]=`<span>${e.query_type||"N/A"}</span>`,e.query_class&&(t["类别"]=`<span>${e.query_class}</span>`);e.domain_set&&(t["分流规则"]=ne(e.domain_set,e.domain_set,e.domain_set,!0));e.trace_id&&(t["Trace ID"]=ne(e.trace_id,e.trace_id,e.trace_id,!0));a["耗时"]=`<span>${e.duration_ms.toFixed(2)} ms</span>`;let r=e.response_code||"N/A";e.is_blocked&&(r+=" (已拦截)");a["状态"]=`<span>${r}</span>`,i.length&&(a["标志"]=`<span>${i.join(", ")}</span>`);n=e.answers||[];const d=e=>Object.entries(e).map(([e,t])=>`<li><strong>${e}</strong> ${t}</li>`).join("");let c="<h5>查询信息</h5><ul>"+d(t)+"</ul>";c+="<h5>响应信息</h5><ul>"+d(a)+"</ul>",n.length&&(c+=`<h5>应答记录 (${n.length})</h5><ul>${n.map(e=>`<li><strong>${e.type}</strong> <span>${e.data}<br><small>(TTL: ${e.ttl}s)</small></span></li>`).join("")}</ul>`);return c}(a),lockScroll(),u.logDetailModal.showModal())},openRuleModal(e,t=null){const a=u.ruleForm;a.reset(),u.ruleMode.value=e;const n="diversion"===e;u.modalTitle.textContent=t?`修改${n?"分流":"拦截"}规则`:`添加${n?"分流":"拦截"}规则`,u.ruleTypeWrapper.style.display=n?"block":"none",u.ruleFilesWrapper.style.display=n?"block":"none";const s=document.getElementById("rule-enable-regexp-wrapper");s&&(s.style.display=n?"flex":"none"),a.elements.type.required=n,a.elements.files.required=n,t?(a.elements.id.value=t.id??t.name,a.elements.name.value=t.name,a.elements.url.value=t.url,a.elements.auto_update.checked=t.auto_update,a.elements.update_interval_hours.value=t.update_interval_hours||24,a.elements.enable_regexp&&(a.elements.enable_regexp.checked=t.enable_regexp||!1),n&&(a.elements.type.value=t.type,a.elements.files.value=t.files)):(a.elements.id.value="",a.elements.auto_update.checked=!0,a.elements.enable_regexp&&(a.elements.enable_regexp.checked=!1),a.elements.update_interval_hours.value=24,n&&(a.elements.type.value="")),lockScroll(),u.ruleModal.showModal()},closeRuleModal(){closeAndUnlock(u.ruleModal)}};function x(e){if(!u.navSlider||!u.mainNav)return;const t=u.mainNav.getBoundingClientRect(),a=e.getBoundingClientRect(),n=a.left-t.left;u.navSlider.style.width=`${a.width}px`,u.navSlider.style.transform=`translateX(${n}px)`}const $={init(){const e=h(this.handleUpdateSchedulerConfig.bind(this),1500);u.requeryTriggerBtn.addEventListener("click",this.handleTrigger.bind(this)),u.requeryCancelBtn.addEventListener("click",this.handleCancel.bind(this)),u.requerySchedulerToggle.addEventListener("change",this.handleUpdateSchedulerConfig.bind(this)),u.requeryIntervalInput.addEventListener("change",e),u.requeryDateRangeInput&&u.requeryDateRangeInput.addEventListener("change",e),u.requeryStartDatetimeInput.addEventListener("change",e)},async updateStatus(e){this.updateDomainCounts(e);try{const[t,a]=await Promise.all([b.getStatus(e),b.getConfig(e)]);c.requery.status=t,c.requery.config=a,this.render()}catch(e){"AbortError"!==e.name&&this.render(null,null)}},render(){const e=c.requery.status,t=c.requery.config;if(!e||!t)return u.requeryStatusText.textContent="获取状态失败",u.requeryStatusText.style.color="var(--color-danger)",void(u.requeryTriggerBtn.disabled=!0);const a="running"===e.task_state;let n="空闲",s="var(--color-success)";switch(e.task_state){case"running":n="正在执行...",s="var(--color-warning)",this.startPolling();break;case"failed":n="上次执行失败",s="var(--color-danger)",this.stopPolling();break;case"cancelled":n="上次任务已取消",s="var(--color-text-secondary)",this.stopPolling();break;default:this.stopPolling()}if(u.requeryStatusText.textContent=n,u.requeryStatusText.style.color=s,u.requeryProgressContainer.hidden=!a,a){const t=e.progress.total>0?e.progress.processed/e.progress.total*100:0;u.requeryProgressBarFill.style.width=`${t}%`,u.requeryProgressBarText.textContent=`${Math.floor(t)}% (${e.progress.processed.toLocaleString()} / ${e.progress.total.toLocaleString()})`}if(e.last_run_start_time&&!e.last_run_start_time.startsWith("0001-01-01")){let t=`开始于 ${te(e.last_run_start_time)}`;if(e.last_run_end_time&&!e.last_run_end_time.startsWith("0001-01-01")){const a=new Date(e.last_run_start_time),n=new Date(e.last_run_end_time),s=Math.round((n-a)/1e3);t=`完成于 ${te(e.last_run_end_time)} (耗时 ${s}秒)`}u.requeryLastRun.textContent=t}else u.requeryLastRun.textContent="从未执行";t.execution_settings&&u.requeryDateRangeInput&&(u.requeryDateRangeInput.value=t.execution_settings.date_range_days||30),u.requerySchedulerToggle.checked=t.scheduler.enabled,u.requeryIntervalInput.value=t.scheduler.interval_minutes,u.requeryStartDatetimeInput.value=function(e){if(!e||e.startsWith("0001-01-01"))return"";try{const t=new Date(e);if(isNaN(t.getTime()))return"";const a=t.getFullYear(),n=(t.getMonth()+1).toString().padStart(2,"0"),s=t.getDate().toString().padStart(2,"0");return`${a}-${n}-${s}T${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`}catch(e){return console.error("Error formatting date:",e),""}}(t.scheduler.start_datetime);const o=!t.scheduler.enabled;u.requeryIntervalInput.disabled=o,u.requeryStartDatetimeInput.disabled=o,u.requeryTriggerBtn.hidden=a,u.requeryCancelBtn.hidden=!a,u.requeryTriggerBtn.disabled=a,u.requeryClearBackupBtn.disabled=a},startPolling(){c.requery.pollId||(c.requery.pollId=setInterval(()=>{this.updateStatus()},5e3))},stopPolling(){clearInterval(c.requery.pollId),c.requery.pollId=null},async handleTrigger(e,t=!1){if(!!t||confirm("确定要开始一个全新的刷新任务吗？\n这将完整执行所有步骤，可能需要一些时间。")){const t=e?e.currentTarget:u.requeryTriggerBtn;_.setLoading(t,!0);try{await b.trigger(),_.showToast("刷新任务已开始","success"),await this.updateStatus()}catch(e){}finally{_.setLoading(t,!1)}}},async handleCancel(e){if(confirm("确定要取消当前正在执行的任务吗？")){const t=e.currentTarget;_.setLoading(t,!0);try{await b.cancel(),_.showToast("已发送取消请求","success"),u.requeryCancelBtn.hidden=!0,u.requeryTriggerBtn.hidden=!1}catch(e){}finally{_.setLoading(t,!1)}}},async handleUpdateSchedulerConfig(){const e=u.requerySchedulerToggle.checked,t=parseInt(u.requeryIntervalInput.value,10),a=u.requeryStartDatetimeInput.value,n=parseInt(u.requeryDateRangeInput.value,10);if(e&&(!t||t<=0))return void _.showToast("启用定时任务时，必须设置一个有效的间隔分钟数","error");let s="";if(a)try{s=new Date(a).toISOString()}catch(e){return void _.showToast("输入的首次执行时间格式无效","error")}if(!n||n<1)return void _.showToast("域名刷新天数必须大于 0","error");const o={enabled:e,interval_minutes:t||0,start_datetime:s,date_range_days:n};try{await b.updateSchedulerConfig(o),_.showToast("定时任务配置已更新","success"),c.requery.config&&(c.requery.config.scheduler=o,c.requery.config.execution_settings||(c.requery.config.execution_settings={}),c.requery.config.execution_settings.date_range_days=n,this.render())}catch(e){}},async updateDomainCounts(e){const t=u.requeryRefreshStatsBtn;if(t){const e=t.querySelector("svg");e&&(e.style.animation="spin 1s linear infinite"),t.disabled=!0}const a=u.requeryDomainStatsTbody;if(a){a.innerHTML='<tr><td colspan="2">正在加载统计数据...</td></tr>';try{const[t,n]=await Promise.allSettled([b.getCounts(e),b.getBackupCount(e)]);let s="",o=!1;if("fulfilled"===t.status&&"success"===t.value.status&&Array.isArray(t.value.data)){const e=t.value.data;e.length>0&&(o=!0,e.forEach(e=>{let t=e.count.toLocaleString(),a=null,n=e.alias;e.alias.includes("fakeip")?a="fakeip":e.alias.includes("realip")?a="realip":e.alias.includes("nov4")?a="nov4":e.alias.includes("nov6")?a="nov6":e.alias.includes("notin")&&(a="notin"),a&&(t=`<a href="#" class="control-item-link" data-list-type="${a}" data-list-title="${n}">${e.count.toLocaleString()}</a>`),s+=`\n                                <tr>\n                                    <td>${e.alias}</td>\n                                    <td class="text-right">${t}</td>\n                                </tr>\n                            `}))}o||(s+='<tr><td colspan="2" style="color: var(--color-danger);">获取源文件条目失败</td></tr>'),"fulfilled"===n.status&&"success"===n.value.status?s+=`\n                        <tr>\n                            <td style="border-top: 1px solid var(--color-border); padding-top: 0.8rem; font-weight: 700;">全部域名 (备份总表)</td>\n                            <td class="text-right" style="border-top: 1px solid var(--color-border); padding-top: 0.8rem; font-weight: 700; color: var(--color-accent-primary);">${n.value.count.toLocaleString()}</td>\n                        </tr>\n                    `:s+='<tr><td colspan="2" style="color: var(--color-danger);">获取备份总数失败</td></tr>',a.innerHTML=s}catch(e){"AbortError"!==e.name&&(a.innerHTML='<tr><td colspan="2" style="padding: 1rem; text-align: center; color: var(--color-danger);">加载统计数据时发生错误</td></tr>')}finally{if(t){const e=t.querySelector("svg");e&&(e.style.animation=""),t.disabled=!1}}}}},k={profiles:[{tag:"switch3",name:"核心运行模式",tip:"切换后将执行一次“全新任务”刷新分流缓存。兼容模式性能更高，安全模式防泄露和劫持能力更强。",modes:{A:{name:"兼容模式",icon:"fa-globe-americas"},B:{name:"安全模式",icon:"fa-shield-alt"}}},{tag:"switch1",name:"请求屏蔽",desc:"对无解析结果的请求进行屏蔽",tip:"建议开启，避免无ipv4及ipv6结果的非必要DNS解析。",valueForOn:"A"},{tag:"switch5",name:"类型屏蔽",desc:"屏蔽 SOA、PTR、HTTPS 等请求",tip:"建议开启，可减少不必要的网络请求，提高效率。",valueForOn:"A"},{tag:"switch4",name:"过期缓存1",desc:"启用国内缓存、国外缓存 (兼容)、国外缓存 (安全)、国内域名fakeip缓存",tip:"建议开启，可以提升重复查询的响应速度，即使缓存已过期。",valueForOn:"A"},{tag:"switch13",name:"过期缓存2",desc:"启用全部缓存 (兼容)、全部缓存 (安全)，缓存fakeip，直面客户端",tip:"建议开启，折腾时可临时关闭，排除干扰。",valueForOn:"A"},{tag:"switch7",name:"广告屏蔽",desc:"启用Adguard在线规则支持",tip:"此开关开启后，“广告拦截”页签中已启用的在线列表才会生效。",valueForOn:"A"},{tag:"switch9",name:"CNFakeIP",desc:"国内域名返回fakeip",tip:"请在上游dns中配置cnfake组的mihomo条目",valueForOn:"B"},{tag:"switch2",name:"指定 Client fakeip",desc:"只允许指定的客户端科学",tip:"按需开启。需要 MosDNS 监听53端口，并正确配置 client_ip 名单。",valueForOn:"A"},{tag:"switch12",name:"指定 Client realip",desc:"指定客户端不允许科学",tip:"按需开启。需要 MosDNS 监听53端口，并正确配置 client_ip 名单。",valueForOn:"A"},{tag:"switch6",name:"IPV6屏蔽",desc:"屏蔽AAAA请求类型",tip:"无IPV6网络环境建议开启",valueForOn:"A"},{tag:"switch8",name:"IPV4优先",desc:"Prefer IPV4（不建议开启）",tip:"当一个域名有IPV4解析记录时，不返回IPV6解析结果。",valueForOn:"A"},{tag:"switch10",name:"IPV6优先",desc:"Prefer IPV6（不建议开启）",tip:"当一个域名有IPV6解析记录时，不返回IPV4解析结果。",valueForOn:"A"}],init(){u.coreModeSwitchGroup.addEventListener("click",e=>{const t=e.target.closest("button");t&&!t.classList.contains("active")&&this.handleCoreSwitch(t)}),u.secondarySwitchesContainer.addEventListener("change",e=>{const t=e.target.closest('input[type="checkbox"]');t&&this.handleSecondarySwitch(t)})},async loadStatus(e){try{const t=this.profiles.map(t=>f.fetch(`/plugins/${t.tag}/show`,{signal:e}));(await Promise.allSettled(t)).forEach((e,t)=>{const a=this.profiles[t];"fulfilled"===e.status?c.featureSwitches[a.tag]=e.value.trim():(c.featureSwitches[a.tag]="error",console.error(`获取 ${a.tag} 状态失败:`,e.reason))}),this.render()}catch(e){"AbortError"!==e.name&&(u.featureSwitchesModule.innerHTML='<h3>功能开关</h3><p style="color:var(--color-danger)">加载开关状态失败。</p>')}},render(){const e=c.featureSwitches.switch3;u.coreModeSwitchGroup.querySelectorAll("button").forEach(t=>{t.classList.toggle("active",t.dataset.mode===e),t.disabled="error"===e});const t=this.profiles.filter(e=>!e.modes);let a="";t.forEach(e=>{const t=c.featureSwitches[e.tag],n=t===e.valueForOn,s="error"===t;a+=`\n                    <div class="control-item">\n                        <strong class="switch-label">\n                            <span class="title-line">\n                                <span>${e.name}</span>\n                                <span class="info-icon" title="${e.tip}">\n                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v2h-2V7zm0 4h2v6h-2v-6z"></path></svg>\n                                </span>\n                            </span>\n                            ${e.desc?`<span class="switch-desc">${e.desc}</span>`:""}\n                        </strong>\n                        <label class="switch">\n                            <input type="checkbox" data-switch-tag="${e.tag}" ${n?"checked":""} ${s?"disabled":""}>\n                            <span class="slider"></span>\n                        </label>\n                    </div>`}),u.secondarySwitchesContainer.innerHTML=a,oe()},async handleCoreSwitch(e){const t="switch3",a=e.dataset.mode;_.setLoading(e,!0),e.parentElement.querySelectorAll("button").forEach(e=>e.disabled=!0);try{await f.fetch(`/plugins/${t}/post`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({value:a})}),c.featureSwitches[t]=a,this.render(),_.showToast("核心模式已切换，即将开始刷新分流缓存...","success"),await $.handleTrigger(null,!0)}catch(e){_.showToast("切换核心模式失败!","error"),this.render()}finally{_.setLoading(e,!1),e.parentElement.querySelectorAll("button").forEach(e=>e.disabled=!1),this.render()}},async handleSecondarySwitch(e){const t=e.dataset.switchTag,a=this.profiles.find(e=>e.tag===t);if(!a)return;e.disabled=!0;const n=e.checked?a.valueForOn:"A"===a.valueForOn?"B":"A";try{await f.fetch(`/plugins/${t}/post`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({value:n})}),c.featureSwitches[t]=n,_.showToast(`“${a.name}” 已${e.checked?"启用":"禁用"}`),"switch9"===t&&(async()=>{_.showToast("附加操作：正在清空核心缓存...","info");const e=(await Promise.allSettled([f.fetch("/plugins/cache_all/flush"),f.fetch("/plugins/cache_all_noleak/flush")])).filter(e=>"rejected"===e.status).length;e>0?_.showToast(`附加操作：核心缓存清空完成，有 ${e} 个失败。`,"error"):_.showToast("附加操作：核心缓存已成功清空！","success")})()}catch(t){_.showToast(`切换“${a.name}”失败`,"error"),e.checked=!e.checked}finally{e.disabled=!1}}},B={init(){if(!u.updateModule)return;const e=this.loadAutoConfig();c.update.auto.enabled=e.enabled,c.update.auto.intervalMinutes=e.interval,u.updateAutoToggle.checked=e.enabled,u.updateIntervalInput.value=e.interval,u.updateAutoToggle.addEventListener("change",()=>{c.update.auto.enabled=u.updateAutoToggle.checked,this.persistAutoConfig(),this.applyAutoSchedule(!0)}),u.updateIntervalInput.addEventListener("change",()=>{const e=parseInt(u.updateIntervalInput.value,10);if(!Number.isFinite(e)||e<5)return u.updateIntervalInput.value=c.update.auto.intervalMinutes,void _.showToast("自动检查间隔至少为 5 分钟","error");c.update.auto.intervalMinutes=Math.min(e,720),this.persistAutoConfig(),this.applyAutoSchedule(!0)}),u.updateCheckBtn?.addEventListener("click",()=>this.forceCheck()),u.updateApplyBtn?.addEventListener("click",()=>this.applyUpdate()),this.applyAutoSchedule(!1),u.updateForceBtn?.addEventListener("click",()=>this.applyUpdate(!0,u.updateForceBtn)),u.updateV3Btn?.addEventListener("click",()=>this.applyUpdate(!0,u.updateV3Btn,!0))},loadAutoConfig(){try{const e=localStorage.getItem("mosdns-update-auto");if(!e)throw new Error("empty");const t=JSON.parse(e);return{enabled:Boolean(t.enabled),interval:Number.isFinite(t.interval)?t.interval:d}}catch(e){return{enabled:!0,interval:d}}},persistAutoConfig(){const e={enabled:c.update.auto.enabled,interval:c.update.auto.intervalMinutes};try{localStorage.setItem("mosdns-update-auto",JSON.stringify(e))}catch(e){console.warn("无法保存自动更新配置:",e)}},applyAutoSchedule(e){if(e&&c.update.auto.timerId&&(clearInterval(c.update.auto.timerId),c.update.auto.timerId=null),u.updateIntervalInput&&(u.updateIntervalInput.disabled=!c.update.auto.enabled),!c.update.auto.enabled)return void this.setHint("自动检查已关闭。您可以随时手动检查更新。");const t=60*Math.max(c.update.auto.intervalMinutes,5)*1e3;this.setHint(`自动检查已启用，每 ${c.update.auto.intervalMinutes} 分钟检查一次。`),c.update.auto.timerId||(c.update.auto.timerId=setInterval(()=>{this.refreshStatus()},t))},setHint(e){u.updateHintText&&(u.updateHintText.textContent=e)},restartProbeTimerId:null,restartProbeActive:!1,startRestartWatch(e){if(this.restartProbeActive)return;this.restartProbeActive=!0;const t=Date.now()+9e4,a=async()=>{if(Date.now()>t)return clearInterval(this.restartProbeTimerId),this.restartProbeActive=!1,void _.showToast("重启超时，请手动刷新页面","error");try{const e=new AbortController,t=setTimeout(()=>e.abort(),1500),a=await fetch("/api/v1/update/status",{cache:"no-store",signal:e.signal});if(clearTimeout(t),!a.ok)throw new Error(String(a.status));const n=await a.json();n&&!n.pending_restart&&n.current_version&&(clearInterval(this.restartProbeTimerId),this.restartProbeActive=!1,_.showToast("重启完成","success"),setTimeout(()=>location.reload(),800))}catch(e){}};setTimeout(()=>{a(),this.restartProbeTimerId=setInterval(a,1e3)},1e3)},setUpdateLoading(e,t){c.update.loading=e,t&&_.setLoading(t,e),this.refreshButtons()},canApply(){const e=c.update.status;if(!e)return!1;if(e.pending_restart)return!1;const t=e.current_version||"",a=e.latest_version||"",n=""!==this.normalizeVer(t)&&this.normalizeVer(t)===this.normalizeVer(a);return Boolean(e.update_available&&!n&&e.download_url)},refreshButtons(){if(u.updateApplyBtn&&(u.updateApplyBtn.disabled=c.update.loading||!this.canApply()),u.updateForceBtn){const e=Boolean(c.update.status?.download_url);u.updateForceBtn.disabled=c.update.loading||!e}},normalizeVer:e=>e?String(e).trim().toLowerCase().replace(/^v/,""):"",updateStatusUI(e){if(c.update.status=e,!u.updateModule||!e)return;const t=e.current_version||"",a=e.latest_version||"",n=""!==this.normalizeVer(t)&&this.normalizeVer(t)===this.normalizeVer(a);u.updateCurrentVersion.textContent=t||"未知",u.updateLatestVersion.textContent=a||"--",u.updateTargetInfo.textContent=e.asset_name?`${e.asset_name} (${e.architecture||"未知"})`:e.architecture||"未知",u.updateInlineBadge&&(u.updateInlineBadge.style.display="none",u.updateInlineBadge.className="badge"),u.updateStatusBanner&&(u.updateStatusBanner.style.display="");const s=e.update_available&&!n;u.updateStatusText.textContent=e.message||(s?"发现新版本，可立即更新。":"当前已是最新版本");const o=e.checked_at?new Date(e.checked_at):null;if(u.updateLastChecked.textContent=o?o.toLocaleString():"--",u.updateApplyBtn){const t=u.updateApplyBtn.querySelector("span");let a="立即更新";if(e.pending_restart){a=(e.architecture||"").startsWith("windows/")?"等待重启":"重启中…"}else this.canApply()&&!n||(a="已是最新");t&&(t.textContent=a),u.updateApplyBtn.dataset.defaultText=a}if(u.updateForceBtn){const e=u.updateForceBtn.querySelector("span");e&&(e.textContent="强制更新"),u.updateForceBtn.dataset.defaultText="强制更新"}if(u.updateCheckBtn){const e=u.updateCheckBtn.querySelector("span");e&&(e.textContent="强制检查",u.updateCheckBtn.dataset.defaultText="强制检查")}if(e.pending_restart){const t=(e.architecture||"").startsWith("windows/")?"更新已安装，等待手动重启生效。":"更新已安装，正在自重启…";u.updateStatusText.textContent=t,this.setHint(t)}else if(s){if(e.message){const t=(e.message||"").toString();u.updateStatusText.textContent=t.length>120?t.slice(0,117)+"…":t,u.updateApplyBtn&&(u.updateApplyBtn.style.display="")}}else u.updateInlineBadge&&(u.updateInlineBadge.textContent="已是最新",u.updateInlineBadge.classList.add("success"),u.updateInlineBadge.style.display="inline-flex"),u.updateApplyBtn&&(u.updateApplyBtn.style.display="none"),u.updateStatusBanner&&(u.updateStatusBanner.style.display="none");this.refreshButtons();const l=e.architecture||"",i=("linux/amd64"===l||"windows/amd64"===l)&&e.amd64_v3_capable&&!e.current_is_v3;u.updateV3Callout&&(u.updateV3Callout.style.display=i?"grid":"none")},async refreshStatus(e=!1){if(u.updateModule)try{const t=e?await S():await w();this.updateStatusUI(t)}catch(e){console.error("检查更新失败:",e),_.showToast("检查更新失败，请稍后重试","error")}},async forceCheck(){if(!c.update.loading){this.setUpdateLoading(!0,u.updateCheckBtn);try{const e=await S();_.showToast("已刷新最新版本信息","success"),this.updateStatusUI(e)}catch(e){console.error("强制检查更新失败:",e),_.showToast("强制检查失败","error")}finally{this.setUpdateLoading(!1,u.updateCheckBtn),this.applyAutoSchedule(!0)}}},async applyUpdate(e=!1,t=u.updateApplyBtn,a=!1){if(!c.update.loading&&(e||this.canApply())){this.setUpdateLoading(!0,t||u.updateApplyBtn);try{const t=c.update.status?.current_version||"",n=await T(e,a);n.installed?_.showToast(n.status?.message||"更新已安装，正在自重启…","success"):_.showToast(n.status?.message||"更新已处理","info"),n.status&&this.updateStatusUI(n.status);!(n.status?.architecture||"").startsWith("windows/")&&n.status?.pending_restart&&this.startRestartWatch(t)}catch(e){console.error("执行更新失败:",e),_.showToast("更新失败，请检查日志","error")}finally{this.setUpdateLoading(!1,t||u.updateApplyBtn),this.applyAutoSchedule(!0);const e=c.update.status;u.updateApplyBtn&&e&&!e.update_available&&(u.updateApplyBtn.style.display="none")}}}},C={parseMetrics(e){const t=e.split("\n"),a={startTime:0,cpuTime:0,residentMemory:0,heapIdleMemory:0,threads:0,openFds:0,grs:0,goVersion:"N/A"};return t.forEach(e=>{if(e.startsWith("process_start_time_seconds"))a.startTime=parseFloat(e.split(" ")[1])||0;else if(e.startsWith("process_cpu_seconds_total"))a.cpuTime=parseFloat(e.split(" ")[1])||0;else if(e.startsWith("process_resident_memory_bytes"))a.residentMemory=parseFloat(e.split(" ")[1])||0;else if(e.startsWith("go_memstats_heap_idle_bytes"))a.heapIdleMemory=parseFloat(e.split(" ")[1])||0;else if(e.startsWith("go_threads"))a.threads=parseInt(e.split(" ")[1])||0;else if(e.startsWith("process_open_fds"))a.openFds=parseInt(e.split(" ")[1])||0;else if(e.startsWith("go_goroutines"))a.grs=parseInt(e.split(" ")[1])||0;else if(e.startsWith('go_info{version="')){const t=e.match(/go_info{version="([^"]+)"}/);t&&t[1]&&(a.goVersion=t[1])}}),a},update(){const e=c.systemInfo,t=u.systemInfoContainer;if(!t||0===Object.keys(e).length)return void(t.innerHTML="<p>暂无系统信息</p>");const a=[{label:"启动时间",value:e.startTime?new Date(1e3*e.startTime).toLocaleString():"N/A"},{label:"CPU 时间",value:`${e.cpuTime.toFixed(2)} 秒`},{label:"常驻内存 (RSS)",value:`${(e.residentMemory/1024/1024).toFixed(2)} MB`},{label:"待用堆内存 (Idle)",value:`${(e.heapIdleMemory/1024/1024).toFixed(2)} MB`},{label:"Go 版本",value:e.goVersion,accent:!0},{label:"线程数",value:e.threads.toLocaleString()},{label:"打开文件描述符",value:e.openFds.toLocaleString()},{label:"go_goroutines",value:e.grs.toLocaleString()}];t.innerHTML=a.map(e=>`\n                <div class="info-item">\n                    <span class="info-item-label">${e.label}</span>\n                    <span class="info-item-value ${e.accent?"accent":""}">${e.value}</span>\n                </div>\n            `).join("")},async load(e){try{const t=await f.getMetrics(e);c.systemInfo=this.parseMetrics(t),this.update()}catch(e){"AbortError"!==e.name&&(console.error("Failed to load system info:",e),u.systemInfoContainer.innerHTML='<p style="color:var(--color-danger)">系统信息加载失败</p>')}}},M={async load(){try{const e=await I(),t={};if("object"==typeof e&&null!==e)for(const a in e)t[L(a)]=e[a];c.clientAliases=t}catch(e){_.showToast("加载客户端别名失败","error"),c.clientAliases={}}},async save(){try{await E(c.clientAliases)}catch(e){throw e}},getDisplayName:e=>{const t=L(e);return c.clientAliases[t]||e},getAliasedClientHTML:e=>{const t=L(e);return c.clientAliases[t]?`<span class="client-alias" title="IP: ${e}">${c.clientAliases[t]}</span>`:e},getIpByAlias:e=>{const t=e.toLowerCase();for(const e in c.clientAliases)if(c.clientAliases[e].toLowerCase()===t)return e;return null},set(e,t){const a=L(e);t?c.clientAliases[a]=t:delete c.clientAliases[a]},async saveAll(){const e=u.aliasListContainer.querySelectorAll(".alias-item");let t=!1;if(e.forEach(e=>{const a=e.dataset.ip,n=e.querySelector("input"),s=n.value.trim();s!==n.dataset.originalValue&&(this.set(a,s),t=!0)}),t)try{await this.save(),_.showToast("所有别名更改已保存","success"),await Y(!1),await this.renderEditableList()}catch(e){_.showToast("保存别名失败","error")}else _.showToast("没有检测到任何更改")},async renderEditableList(){if(u.aliasListContainer){u.aliasListContainer.innerHTML="<p>正在加载客户端列表...</p>";try{const e=await f.v2.getTopClients(null,200),t=[...new Set(e.map(e=>e.key))].sort();if(0===t.length)return void(u.aliasListContainer.innerHTML="<p>日志中暂无客户端 IP 记录。</p>");u.aliasListContainer.innerHTML="",t.forEach(e=>{const t=document.createElement("div");t.className="alias-item",t.dataset.ip=e;const a=L(e),n=c.clientAliases[a]||"";t.innerHTML=`<span style="font-weight:600;">${e}</span> <input type="text" placeholder="设置别名..." value="${n}" data-original-value="${n}">`,u.aliasListContainer.appendChild(t)})}catch(e){u.aliasListContainer.innerHTML="<p>加载客户端列表失败。</p>"}}},async export(){try{_.showToast("正在从服务器获取最新配置...");const e=await I(),t={};if("object"!=typeof e||null===e)throw new Error("从服务器返回的数据格式无效");for(const a in e)t[L(a)]=e[a];const a=JSON.stringify(t,null,2),n=new Blob([a],{type:"application/json"}),s=URL.createObjectURL(n),o=document.createElement("a");o.href=s,o.download=`mosdns-aliases-${(new Date).toISOString().split("T")[0]}.json`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(s),_.showToast("配置已导出","success")}catch(e){}},import(e){const t=new FileReader;t.onload=async e=>{try{const t=JSON.parse(e.target.result);if("object"!=typeof t||null===t||Array.isArray(t))throw new Error("无效的JSON对象格式");for(const e in t)this.set(e,t[e]);_.showToast("正在上传配置到服务器..."),await this.save(),await this.renderEditableList(),await Y(!1),_.showToast("配置已成功导入并上传","success")}catch(e){_.showToast(`导入失败: ${e.message}`,"error")}},t.readAsText(e)}},q={load:()=>{const e=JSON.parse(localStorage.getItem("mosdnsHistory"));e&&(c.history.totalQueries=e.totalQueries||[],c.history.avgDuration=e.avgDuration||[],c.history.timestamps=e.timestamps||[])},add(e,t){c.history.totalQueries.push(e??0),c.history.avgDuration.push(t??0),c.history.timestamps.push(Date.now());const n=a;c.history.totalQueries.length>n&&c.history.totalQueries.shift(),c.history.avgDuration.length>n&&c.history.avgDuration.shift(),c.history.timestamps.length>n&&c.history.timestamps.shift(),this.save()},save:()=>{localStorage.setItem("mosdnsHistory",JSON.stringify(c.history))}},A=()=>{const e=document.getElementById("log-search"),t=document.getElementById("log-search-container-original"),a=document.getElementById("log-header-actions"),n=u.logQueryTab;if(!(e&&t&&a&&n))return;const s="comfortable"===document.documentElement.dataset.layout,l=window.innerWidth<=1440&&window.innerWidth>o;s&&l?a.contains(e)||(a.prepend(e),n.classList.add("search-moved-to-header")):t.contains(e)||(t.prepend(e),n.classList.remove("search-moved-to-header"))},R={init(){const e=localStorage.getItem("mosdns-theme")||"dark",t=localStorage.getItem("mosdns-color")||"indigo",a=localStorage.getItem("mosdns-layout")||"comfortable",n=localStorage.getItem("mosdns-chart-mode")||"integrated";this.setTheme(e,!1),this.setColor(t,!1),this.setLayout(a,!1),this.setChartMode(n,!1),u.themeSwitcher?.addEventListener("change",e=>this.setTheme(e.target.value)),u.layoutSwitcher?.addEventListener("change",e=>this.setLayout(e.target.value)),u.overviewChartModeToggle?.addEventListener("change",e=>this.setChartMode(e.target.checked?"independent":"integrated")),u.colorSwatches.forEach(e=>{e.addEventListener("click",()=>this.setColor(e.dataset.color))})},setTheme(e,t=!0){u.html.setAttribute("data-theme",e),u.themeSwitcher&&(u.themeSwitcher.value=e),t&&localStorage.setItem("mosdns-theme",e)},setColor(e,t=!0){u.html.setAttribute("data-color-scheme",e),document.querySelectorAll(".color-swatch").forEach(e=>e.classList.remove("active")),document.querySelectorAll(`.color-swatch[data-color="${e}"]`).forEach(e=>e.classList.add("active")),t&&localStorage.setItem("mosdns-color",e)},setLayout(e,t=!0){u.html.setAttribute("data-layout",e),u.layoutSwitcher&&(u.layoutSwitcher.value=e),t&&localStorage.setItem("mosdns-layout",e),A()},setChartMode(e,t=!0){const a=document.querySelector(".stats-grid");a&&("independent"===e?(a.classList.add("independent-mode"),u.independentChartPanel&&(u.independentChartPanel.style.display="block")):(a.classList.remove("independent-mode"),u.independentChartPanel&&(u.independentChartPanel.style.display="none"))),u.overviewChartModeToggle&&(u.overviewChartModeToggle.checked="independent"===e),t&&localStorage.setItem("mosdns-chart-mode",e),void 0!==_&&_.updateOverviewStats&&requestAnimationFrame(()=>_.updateOverviewStats())}},D=(e,t,a,n,s=0)=>{if(!e||null===t||null===a)return;if(t===a)return void(e.textContent=s>0?parseFloat(a).toFixed(s):Math.floor(a).toLocaleString());let o=null;const l=i=>{o||(o=i);const r=Math.min((i-o)/n,1),d=t+r*(a-t);e.textContent=s>0?parseFloat(d).toFixed(s):Math.floor(d).toLocaleString(),r<1&&window.requestAnimationFrame(l)};window.requestAnimationFrame(l)},H=(e,t,a,n=!1)=>{if(null===t||null===a||0===t)return void(e.style.visibility="hidden");const s=a-t,o=s/t*100;if(Math.abs(o)<.1)return void(e.style.visibility="hidden");const l=n?s<0?"up":"down":s>0?"up":"down",i="up"===l?'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8L18 14H6L12 8Z"></path></svg>':'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 16L6 10H18L12 16Z"></path></svg>';e.className=`stat-change ${l}`,e.innerHTML=`${i} ${Math.abs(o).toFixed(1)}%`,e.style.visibility="visible"},N=(e,t=.4)=>{if(!e||e.length<2)return e;const a=[e[0]];for(let n=1;n<e.length;n++)a[n]=t*e[n]+(1-t)*a[n-1];return a},P=(e,t,a,n=800,s=200)=>{if(!e||e.length<2||!t||t.length<2)return"";const o=n<500?{top:20,right:35,bottom:25,left:35}:{top:25,right:55,bottom:30,left:55},l=n-o.left-o.right,i=s-o.top-o.bottom,r=(e,t)=>{const a=0===t?1:t;return e.map((t,n)=>{const s=o.left+n/(e.length-1)*l,r=o.top+i-t/a*i;return`${s.toFixed(1)},${r.toFixed(1)}`})},d=N(e,.4),c=N(t,.3),u=Math.max(...d),m=Math.max(...c),p=r(e,u),g=r(t,m),h=`M ${p.join(" L ")}`,y=`M ${g.join(" L ")}`,v=r(d,u),f=r(c,m),b=`M ${v.join(" L ")}`,w=`M ${f.join(" L ")}`,S=`${b} L ${o.left+l},${o.top+i} L ${o.left},${o.top+i} Z`,T=`${w} L ${o.left+l},${o.top+i} L ${o.left},${o.top+i} Z`,L=a&&a[0]?new Date(a[0]).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"",I=a&&a[a.length-1]?new Date(a[a.length-1]).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"";return`<svg viewBox="0 0 ${n} ${s}" preserveAspectRatio="none" style="overflow:visible; font-family: sans-serif; font-size: 10px;">\n                <defs>\n                    <linearGradient id="grad-primary" x1="0" y1="0" x2="0" y2="1"><stop offset="0" stop-color="var(--color-accent-primary)" stop-opacity="0.15"/><stop offset="1" stop-color="var(--color-accent-primary)" stop-opacity="0"/></linearGradient>\n                    <linearGradient id="grad-amber" x1="0" y1="0" x2="0" y2="1"><stop offset="0" stop-color="#f59e0b" stop-opacity="0.15"/><stop offset="1" stop-color="#f59e0b" stop-opacity="0"/></linearGradient>\n                </defs>\n                <g stroke="var(--color-border)" stroke-width="1" stroke-dasharray="4 4" opacity="0.4">\n                    <line x1="${o.left}" y1="${o.top}" x2="${n-o.right}" y2="${o.top}"/>\n                    <line x1="${o.left}" y1="${o.top+i/2}" x2="${n-o.right}" y2="${o.top+i/2}"/>\n                    <line x1="${o.left}" y1="${o.top+i}" x2="${n-o.right}" y2="${o.top+i}"/>\n                </g>\n                <path d="${S}" fill="url(#grad-primary)" />\n                <path d="${T}" fill="url(#grad-amber)" />\n                \x3c!-- 原始数据（虚线，半透明） --\x3e\n                <path d="${h}" fill="none" stroke="var(--color-accent-primary)" stroke-width="1" stroke-opacity="0.3" stroke-dasharray="3,3" vector-effect="non-scaling-stroke"/>\n                <path d="${y}" fill="none" stroke="#f59e0b" stroke-width="1" stroke-opacity="0.3" stroke-dasharray="3,3" vector-effect="non-scaling-stroke"/>\n                \x3c!-- 平滑数据（实线，粗） --\x3e\n                <path d="${b}" fill="none" stroke="var(--color-accent-primary)" stroke-width="2" stroke-linecap="round" vector-effect="non-scaling-stroke"/>\n                <path d="${w}" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" vector-effect="non-scaling-stroke"/>\n                <g fill="var(--color-text-secondary)" text-anchor="end" style="font-weight:500; font-size:11px;">\n                    <text x="${o.left-6}" y="${o.top+4}" fill="var(--color-accent-primary)">${Math.round(u)}</text>\n                    <text x="${o.left-6}" y="${o.top+i+4}" fill="var(--color-accent-primary)">0</text>\n                </g>\n                <g fill="var(--color-text-secondary)" text-anchor="start" style="font-weight:500; font-size:11px;">\n                    <text x="${n-o.right+6}" y="${o.top+4}" fill="#f59e0b">${Math.round(m)}</text>\n                    <text x="${n-o.right+6}" y="${o.top+i+4}" fill="#f59e0b">0</text>\n                </g>\n                <g fill="var(--color-text-secondary)" style="font-size:11px;">\n                    <text x="${o.left}" y="${s-5}" text-anchor="start">${L}</text>\n                    <text x="${n-o.right}" y="${s-5}" text-anchor="end">${I}</text>\n                </g>\n            </svg>`},V=(e,t=!1,a=300,n=60)=>{if(!e||e.length<2)return"";const s=N(e.map(Number),t?.3:.4),o=Math.max(...s),l=Math.min(...s),i=o-l===0?1:o-l,r=`M ${s.map((e,t)=>{const o=t/(s.length-1)*a,r=n-(e-l)/i*n;return`${o.toFixed(2)},${r.toFixed(2)}`}).join(" L ")}`;return`<svg viewBox="0 0 ${a} ${n}" preserveAspectRatio="none"><defs><linearGradient id="sparkline-gradient" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="var(--color-accent-primary)" stop-opacity="0.5" /><stop offset="100%" stop-color="var(--color-accent-primary)" stop-opacity="0" /></linearGradient></defs><path d="${`${r} L ${a},${n} L 0,${n} Z`}" fill="url(#sparkline-gradient)" /><path d="${r}" class="sparkline-path" fill="none" /></svg>`},F=(e,t,a,n)=>{if(!e)return;const s=e.closest(".card")?.querySelector(".lazy-placeholder");if(s&&(s.style.display="none"),e.innerHTML="",!t||0===t.length){let t="请确保审计功能已开启。",a='<button class="button primary tab-link-action" data-tab="system-control">前往系统控制</button>';"log-query"===n&&c.currentLogSearchTerm?.query?(t=`没有找到与 "<strong>${c.currentLogSearchTerm.query}</strong>" 匹配的记录。`,a=""):c.isCapturing||"adguard"===n||"diversion"===n?"adguard"===n||"diversion"===n?(t='暂无规则，请点击 "添加规则" 按钮新建一个。',a=""):"lazy"===n&&(t="没有可显示的数据。",a=""):t="审计功能当前已停止。";let s=e.closest("table").querySelectorAll("thead th").length||2;"adguard"!==n&&"diversion"!==n||(s=6);const o=document.createElement("tr");return o.className="empty-state-row",o.innerHTML=`<td colspan="${s}"><div class="empty-state-content"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.71,3.29C21.32,2.9,20.69,2.9,20.3,3.29L3.29,20.3c-0.39,0.39-0.39,1.02,0,1.41C3.48,21.9,3.74,22,4,22s0.52-0.1,0.71-0.29L21.71,4.7C22.1,4.31,22.1,3.68,21.71,3.29z M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10,10-4.48 10-10S17.52,2,12,2z M12,20c-4.41,0-8-3.59-8-8c0-2.33,1-4.45,2.65-5.92l11.27,11.27C16.45,19,14.33,20,12,20z"></path></svg><strong>暂无数据</strong><p>${t}</p>${a}</div></td>`,void e.appendChild(o)}const o=document.createDocumentFragment();t.forEach((e,t)=>{const n=a(e,t);n.classList.add("animate-in"),n.style.animationDelay=20*t+"ms",o.appendChild(n)}),e.appendChild(o)};function O(e,t,a){e.innerHTML="";const n=document.createDocumentFragment();for(let e=0;e<t;e++){const e=document.createElement("tr");e.className="skeleton-row";let t="";for(let e=0;e<a;e++)t+='<td><div class="skeleton"></div></td>';e.innerHTML=t,n.appendChild(e)}e.appendChild(n)}const z=e=>F(u.topDomainsBody,e,(e,t)=>{const a=document.createElement("tr");return a.dataset.rankIndex=t,a.dataset.rankSource="domain",c.isMobile?a.innerHTML=`\n                <td>\n                    <div class="mobile-log-row" style="grid-template-areas: 'domain time'; gap: 0.5rem 1rem;">\n                        <div class="domain" title="${e.key}">${e.key}</div>\n                        <div class="time" style="font-size: 1rem; font-weight: 600;">\n                            <a href="#log-query" class="clickable-link" data-filter-value="${e.key}">${e.count.toLocaleString()}</a>\n                        </div>\n                    </div>\n                </td>`:a.innerHTML=`\n                <td><span class="truncate-text" title="${e.key}">${e.key}</span></td>\n                <td class="text-right"><a href="#log-query" class="clickable-link" data-filter-value="${e.key}">${e.count.toLocaleString()}</a></td>`,a},"lazy"),U=e=>F(u.topClientsBody,e,(e,t)=>{const a=document.createElement("tr");return a.dataset.rankIndex=t,a.dataset.rankSource="client",c.isMobile?a.innerHTML=`\n                 <td>\n                    <div class="mobile-log-row" style="grid-template-areas: 'domain time'; gap: 0.5rem 1rem;">\n                        <div class="domain">${M.getAliasedClientHTML(e.key)}</div>\n                        <div class="time" style="font-size: 1rem; font-weight: 600;">\n                           <a href="#log-query" class="clickable-link" data-exact-search="true" data-filter-value="${e.key}">${e.count.toLocaleString()}</a>\n                        </div>\n                    </div>\n                </td>`:a.innerHTML=`\n                <td>${M.getAliasedClientHTML(e.key)}</td>\n                <td class="text-right"><a href="#log-query" class="clickable-link" data-exact-search="true" data-filter-value="${e.key}">${e.count.toLocaleString()}</a></td>`,a},"lazy"),j=e=>F(u.slowestQueriesBody,e,ue,"lazy"),Q=["#6d9dff","#f778ba","#2dd4bf","#fb923c","#a78bfa","#fde047","#ff8c8c","#ef4444","#f97316","#f59e0b","#84cc16","#10b981","#06b6d4","#3b82f6","#6366f1","#8b5cf6","#d946ef","#f43f5e","#64748b"],W=e=>{const t=u.shuntResultsBody.querySelector(".lazy-placeholder");if(t&&(t.style.display="none"),!e||0===e.length)return void(u.shuntResultsBody.innerHTML='<div class="empty-state-content" style="padding: 2rem 0;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.71,3.29C21.32,2.9,20.69,2.9,20.3,3.29L3.29,20.3c-0.39,0.39-0.39,1.02,0,1.41C3.48,21.9,3.74,22,4,22s0.52-0.1,0.71-0.29L21.71,4.7C22.1,4.31,22.1,3.68,21.71,3.29z M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10,10-4.48 10-10S17.52,2,12,2z M12,20c-4.41,0-8-3.59-8-8c0-2.33,1-4.45,2.65-5.92l11.27,11.27C16.45,19,14.33,20,12,20z"></path></svg><strong>暂无数据</strong><p>没有检测到分流结果。</p></div>');const a=e.reduce((e,t)=>e+t.count,0),n=2*Math.PI*72;let s=0;c.shuntColors={};const o=e.map((e,t)=>{const o=e.count/a,l=n-o*n,i=Q[t%Q.length];c.shuntColors[e.key]=i;const r=`<circle cx="80" cy="80" r="72" fill="transparent" stroke="${i}" stroke-width="16" stroke-dasharray="${n}" stroke-dashoffset="${l}" transform="rotate(${360*s} 80 80)"></circle>`;return s+=o,r}).join(""),l=e.map((e,t)=>{const n=(e.count/a*100).toFixed(1);return`<li class="donut-legend-item"><span class="legend-color-box" style="background-color: ${Q[t%Q.length]};"></span><span class="legend-label truncate-text" title="${e.key}">${e.key}</span><span class="legend-value">${e.count.toLocaleString()} (${n}%)</span></li>`}).join("");u.shuntResultsBody.innerHTML=`<div class="donut-chart-wrapper"><div class="donut-chart"><svg viewBox="0 0 160 160">${o}</svg><div class="donut-chart-center-text"><div class="total">${a.toLocaleString()}</div><div class="label">总计</div></div></div><ul class="donut-legend">${l}</ul></div>`};let J,G;async function Y(e=!1){if(c.isUpdating)return;c.isUpdating=!0,J&&J.abort(),J=new AbortController;const{signal:t}=J;_.setLoading(u.globalRefreshBtn,!0);const a=document.querySelector(".tab-link.active")?.dataset.tab;try{const n="overview"===a&&!e,s=[f.getStatus(t),f.getCapacity(t),f.v2.getStats(t)];n||s.push(f.v2.getDomainSetRank(t,100));const o=await Promise.allSettled(s),l=o[0],i=o[1],r=o[2],d=o[3];if(_.updateStatus("fulfilled"===l.status?l.value?.capturing:null),_.updateCapacity("fulfilled"===i.status?i.value?.capacity:null),"fulfilled"===r.status&&r.value){const e=r.value;c.data.totalQueries.previous=null===c.data.totalQueries.current?e.total_queries:c.data.totalQueries.current,c.data.avgDuration.previous=null===c.data.avgDuration.current?e.average_duration_ms:c.data.avgDuration.current,c.data.totalQueries.current=e.total_queries,c.data.avgDuration.current=e.average_duration_ms,_.updateOverviewStats(),q.add(e.total_queries,e.average_duration_ms)}if(d&&"fulfilled"===d.status&&(c.domainSetRank=d.value||[],W(c.domainSetRank)),"system-control"===a){const a=[];void 0!==Be&&a.push(Be.loadData()),e&&(a.push(c.requery.pollId?Promise.resolve():$.updateStatus(t)),a.push(Te(t)),a.push(_e.updateStats(t)),a.push(k.loadStatus(t)),a.push(C.load(t)),a.push(B.refreshStatus(!1))),a.length>0&&await Promise.allSettled(a)}if(e){const[e,a,n]=await Promise.allSettled([f.v2.getTopDomains(t,100),f.v2.getTopClients(t,100),f.v2.getSlowest(t,100)]);"fulfilled"===e.status&&(c.topDomains=e.value||[],z(c.topDomains)),"fulfilled"===a.status&&(c.topClients=a.value||[],U(c.topClients)),"fulfilled"===n.status&&(c.slowestQueries=n.value||[],j(c.slowestQueries))}if(c.lastUpdateTime=new Date,ae(),"log-query"===a)await X(1,!1);else if("rules"===a){const e=document.querySelector("#rules-tab .sub-nav-link.active").dataset.subTab;"list-mgmt"!==e||c.listManagerInitialized?"adguard"===e&&0===c.adguardRules.length?await be.load():"diversion"===e&&0===c.diversionRules.length&&await we.load():xe.init()}}catch(e){"AbortError"!==e.name&&console.error("Page update failed:",e)}finally{_.setLoading(u.globalRefreshBtn,!1),c.isUpdating=!1}}async function X(e=1,a=!1){if(c.isLogLoading&&!a)return;c.isLogLoading=!0,u.logLoader&&(u.logLoader.style.display="block"),a||O(u.logTableBody,Math.min(20,t),c.isMobile?1:5),!a&&G&&G.abort(),G=new AbortController;const n={page:e,limit:t,q:c.currentLogSearchTerm.query,exact:c.currentLogSearchTerm.exact};try{const e=await f.v2.getLogs(G.signal,n);if(!e?.pagination)throw new Error("Invalid response from logs API");const{pagination:t,logs:s}=e;c.logPaginationInfo=t,c.currentLogPage=t.current_page,a||_.updateSearchResultsInfo(t),_.renderLogTable(s||[],a)}catch(e){"AbortError"!==e.name&&(console.error("Failed to fetch logs:",e),_.showToast("获取日志失败","error"))}finally{c.isLogLoading=!1,u.logLoader&&(u.logLoader.style.display="none")}}const Z={init(){u.logTableHead&&u.logTableHead.addEventListener("click",this.handleSort.bind(this)),this.updateHeaders()},handleSort(e){const t=e.target.closest("th[data-sortable]");if(!t)return;const a=t.dataset.sortKey;c.logSort.key===a?c.logSort.order="asc"===c.logSort.order?"desc":"asc":(c.logSort.key=a,c.logSort.order="desc"),this.sortLogs(),this.updateHeaders()},sortLogs(){const{key:e,order:t}=c.logSort,a=u.logTableBody,n=Array.from(a.querySelectorAll("tr[data-log-index]"));if(0===n.length)return;n.sort((a,n)=>{const s=c.displayedLogs[parseInt(a.dataset.logIndex,10)],o=c.displayedLogs[parseInt(n.dataset.logIndex,10)];if(!s||!o)return 0;let l=s[e],i=o[e];"string"==typeof l&&(l=l.toLowerCase(),i=i.toLowerCase());const r=l<i?-1:l>i?1:0;return"asc"===t?r:-r});const s=document.createDocumentFragment();n.forEach(e=>s.appendChild(e)),a.appendChild(s)},updateHeaders(){document.querySelectorAll("#log-table-head th[data-sortable]").forEach(e=>{e.classList.remove("sorted");const t=e.querySelector(".sort-indicator");t&&(e.dataset.sortKey===c.logSort.key?(e.classList.add("sorted"),t.textContent="asc"===c.logSort.order?"▲":"▼"):t.textContent=" ")})}};function K(){if(!u.logSearch)return;const e=u.logSearch.value.trim();let t=e,a=!1;if(e.startsWith('"')&&e.endsWith('"'))t=e.slice(1,-1),a=!0;else if(!a){const e=M.getIpByAlias(t);e&&(t=e)}c.currentLogSearchTerm={query:t,exact:a},X(1,!1)}function ee(e){return e?new Date(e).toLocaleString("zh-CN",{hour12:!1,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).replace(/\//g,"-"):"N/A"}function te(e){if(!e)return"N/A";const t=Math.max(0,Math.round((new Date-new Date(e))/1e3));return t<5?"刚刚":t<60?`${t}秒前`:t<3600?`${Math.floor(t/60)}分钟前`:t<86400?`${Math.floor(t/3600)}小时前`:t<172800?"昨天":new Date(e).toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})}function ae(){if(u.lastUpdated)if(c.lastUpdateTime){const e=te(c.lastUpdateTime.toISOString());u.lastUpdated.textContent=c.isMobile?e:`上次更新于 ${e}`}else u.lastUpdated.textContent=""}function ne(e,t,a,n=!1,s=!1){return`\n            ${s?`<small>${e}</small>`:`<span>${e}</span>`}\n            <span class="interactive-btn-container">\n                <button class="copy-btn" data-copy-value="${t}" title="复制"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></button>\n                <button class="filter-btn" data-filter-value="${a}" data-exact-search="${n}" title="过滤此项"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"></path></svg></button>\n            </span>`}const se=(()=>{const e=u.tooltip;let t,a;const n=(t,a)=>{e.innerHTML=a,e.style.visibility="hidden",e.classList.add("visible"),requestAnimationFrame(()=>{const a=t.getBoundingClientRect(),n=e.getBoundingClientRect();let s=a.bottom+10,o=a.left+a.width/2-n.width/2;s+n.height>window.innerHeight-10&&(s=a.top-n.height-10),o<10?o=10:o+n.width>window.innerWidth-10&&(o=window.innerWidth-n.width-10),e.style.top=`${s}px`,e.style.left=`${o}px`,e.style.visibility="visible"})},s=e=>{const t=e.dataset.logIndex?parseInt(e.dataset.logIndex,10):null,a=e.dataset.rankIndex?parseInt(e.dataset.rankIndex,10):null,s=e.dataset.logSource||e.dataset.rankSource;let o;"slowest"===s&&null!==t?o=c.slowestQueries[t]:"domain"===s&&null!==a?o=c.topDomains[a]:"client"===s&&null!==a?o=c.topClients[a]:"domain_set"===s&&null!==a?o=c.domainSetRank[a]:null!==t&&(o=c.displayedLogs[t]),o&&n(e,function(e,t){if(!e)return"";const a={},n={};let s=[];if(["domain","client","domain_set"].includes(t))a["请求数"]=e.count.toLocaleString();else{const{ra:t,aa:o,tc:l}=e.response_flags||{},i=[t&&"RA",o&&"AA",l&&"TC"].filter(Boolean);a["完整域名"]=ne(e.query_name,e.query_name,e.query_name,!1,!0),a["精确时间"]=`<small>${ee(e.query_time)}</small>`,a["客户端"]=ne(M.getDisplayName(e.client_ip),e.client_ip,e.client_ip,!0,!0),a["类型"]=`<small>${e.query_type||"N/A"}</small>`,e.query_class&&(a["类别"]=`<small>${e.query_class}</small>`),e.domain_set&&(a["规则"]=ne(e.domain_set,e.domain_set,e.domain_set,!0,!0)),n["耗时"]=`<small>${e.duration_ms.toFixed(2)} ms</small>`,n["状态"]=`<small>${e.response_code||"N/A"}${e.is_blocked?" (Blocked)":""}</small>`,i.length&&(n["标志"]=`<small>${i.join(", ")}</small>`),e.trace_id&&(a["Trace ID"]=ne(e.trace_id,e.trace_id,e.trace_id,!0,!0)),s=e.answers||[]}const o=e=>Object.entries(e).map(([e,t])=>`<li><strong>${e}:</strong> ${t}</li>`).join("");let l="";Object.keys(a).length&&(l+=`<h5>查询信息</h5><ul>${o(a)}</ul>`);Object.keys(n).length&&(l+=`<h5 style="margin-top:0.75rem;">响应信息</h5><ul>${o(n)}</ul>`);s.length&&(l+=`<h5 style="margin-top:0.75rem;">应答记录 (${s.length})</h5><ul>${s.map(e=>`<li>[${e.type}] ${e.data} <small>(TTL: ${e.ttl}s)</small></li>`).join("")}</ul>`);return l}(o,s))},o=()=>{e.classList.remove("visible"),e.addEventListener("transitionend",()=>{e.classList.contains("visible")||(e.style.visibility="hidden")},{once:!0})};return{handleTriggerEnter(e){clearTimeout(a),t=setTimeout(()=>s(e),i)},handleTriggerLeave(){clearTimeout(t),a=setTimeout(o,r)},handleTooltipEnter(){clearTimeout(a)},handleTooltipLeave(){a=setTimeout(o,r)},show(e){s(e)},hide(){o()},showText(e,s){s&&(clearTimeout(a),t=setTimeout(()=>{const t=String(s).replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>");n(e,`<div style="max-width: 40ch; line-height: 1.5;">${t}</div>`)},i))}}})();function oe(){(u.featureSwitchesModule||document).querySelectorAll(".info-icon").forEach(e=>{if(e.dataset.tooltipBound)return;e.dataset.tooltipBound="1";const t=e.getAttribute("title")||e.dataset.tip||"";e.setAttribute("aria-label",t),e.addEventListener("mouseenter",()=>se.showText(e,t)),e.addEventListener("mouseleave",()=>se.hide()),e.addEventListener("focus",()=>se.showText(e,t)),e.addEventListener("blur",()=>se.hide())})}function le(e){if(!e||!e.domain_set)return"";const t=e.domain_set;let a=c.shuntColors[t];if(!a){let e=0;for(let a=0;a<t.length;a++)e=t.charCodeAt(a)+((e<<5)-e);a=`hsl(${Math.abs(e%360)}, 70%, 45%)`}return`<span class="rule-tag" style="background-color: ${a}; color: #ffffff;" title="分流规则: ${t}">${t}</span>`}function ie(e){if(!e)return"";const t=e.response_code||"UNKNOWN";let a="other";return"NOERROR"===t?a="noerror":"NXDOMAIN"===t?a="nxdomain":"SERVFAIL"===t?a="servfail":"REFUSED"===t&&(a="refused"),`<span class="response-tag ${a}">${t}</span>`}function re(e,t="log"){const a=le(e);return`<div class="domain-response-cell"><span class="domain-name truncate-text" title="${e.query_name}">${e.query_name}</span><div class="response-meta"><span class="response-summary">${function(e){if(!e)return"";if("NOERROR"!==e.response_code)return ie(e);if(e.answers?.length>0){const t=e.answers.find(e=>"A"===e.type||"AAAA"===e.type),a=e.answers.find(e=>"CNAME"===e.type);let n=t?.data??a?.data??e.answers[0].data;return n.length>25&&(n=n.substring(0,22)+"..."),e.answers.length>1&&(n+=` (+${e.answers.length-1})`),`<span class="truncate-text">${n}</span>`}return"<span>(empty)</span>"}(e)}</span>${a}</div></div>`}function de(e){return e.is_blocked?"is-blocked":["SERVFAIL","NXDOMAIN","REFUSED"].includes(e.response_code)?"is-fail":""}function ce(e,t){const a=document.createElement("tr");return a.dataset.logIndex=t,a.className=de(e),c.isMobile?a.innerHTML=`\n                <td>\n                    <div class="mobile-log-row">\n                        <div class="domain" title="${e.query_name}">${e.query_name}</div>\n                        <div class="time">${te(e.query_time)}</div>\n                        <div class="meta">\n                            <span class="client">${M.getDisplayName(e.client_ip)}</span>\n                            <span class="duration">${e.duration_ms.toFixed(0)}ms</span>\n                            ${ie(e)}\n                            ${le(e)}\n                        </div>\n                    </div>\n                </td>`:a.innerHTML=`\n                <td>${te(e.query_time)}</td>\n                <td>${re(e)}</td>\n                <td>${e.query_type}</td>\n                <td class="text-center numeric duration-cell">${e.duration_ms.toFixed(2)}</td>\n                <td>${M.getAliasedClientHTML(e.client_ip)}</td>`,a}function ue(e,t){const a=document.createElement("tr");return a.dataset.logIndex=t,a.dataset.logSource="slowest",a.className=de(e),c.isMobile?a.innerHTML=`\n                <td>\n                    <div class="mobile-log-row">\n                        <div class="domain" title="${e.query_name}">${e.query_name}</div>\n                        <div class="time">${te(e.query_time)}</div>\n                        <div class="meta">\n                            <span class="client">${M.getDisplayName(e.client_ip)}</span>\n                            <span class="duration">${e.duration_ms.toFixed(0)}ms</span>\n                            ${ie(e)}\n                            ${le(e)}\n                        </div>\n                    </div>\n                </td>`:a.innerHTML=`\n                <td>${re(e,"slowest")}</td>\n                <td>${M.getAliasedClientHTML(e.client_ip)}</td>\n                <td class="text-right numeric duration-cell">${e.duration_ms.toFixed(2)}</td>`,a}const me={start(){this.stop(),c.autoRefresh.enabled&&c.autoRefresh.intervalSeconds>=5&&(c.autoRefresh.intervalId=setInterval(()=>Y(!1),1e3*c.autoRefresh.intervalSeconds))},stop(){clearInterval(c.autoRefresh.intervalId),c.autoRefresh.intervalId=null},updateSettings(e,t){c.autoRefresh.enabled=e,c.autoRefresh.intervalSeconds=Math.max(t,5),localStorage.setItem("mosdnsAutoRefresh",JSON.stringify({enabled:e,intervalSeconds:c.autoRefresh.intervalSeconds})),_.showToast("自动刷新已"+(e?`开启, 频率: ${c.autoRefresh.intervalSeconds}秒`:"关闭"),"success"),this.start()},loadSettings(){const e=JSON.parse(localStorage.getItem("mosdnsAutoRefresh"));e?(c.autoRefresh.enabled=e.enabled??!1,c.autoRefresh.intervalSeconds=e.intervalSeconds||n):(c.autoRefresh.enabled=!1,c.autoRefresh.intervalSeconds=n),u.autoRefreshToggle.checked=c.autoRefresh.enabled,u.autoRefreshIntervalInput.value=c.autoRefresh.intervalSeconds,u.autoRefreshIntervalInput.disabled=!c.autoRefresh.enabled}};function pe(e){u.tabLinks.forEach(e=>e.classList.remove("active")),e.classList.add("active"),requestAnimationFrame(()=>x(e));const t=e.getAttribute("href");window.location.hash!==t&&history.pushState(null,"",t);const a=e.dataset.tab;if(u.tabContents.forEach(e=>e.classList.toggle("active",e.id===`${a}-tab`)),"log-query"===a&&0===c.displayedLogs.length)K();else if("rules"===a){const e=document.querySelector("#rules-tab .sub-nav-link.active").dataset.subTab;"list-mgmt"!==e||c.listManagerInitialized?"adguard"===e&&0===c.adguardRules.length?(O(u.adguardRulesTbody,5,c.isMobile?1:6),be.load()):"diversion"===e&&0===c.diversionRules.length&&(O(u.diversionRulesTbody,5,c.isMobile?1:7),we.load()):xe.init()}}function ge(){const e=c.isMobile;if(c.isMobile=window.innerWidth<=o,e!==c.isMobile){const e=document.querySelector(".tab-link.active")?.dataset.tab;"log-query"===e?_.renderLogTable(c.displayedLogs):"overview"===e?(j(c.slowestQueries),z(c.topDomains),U(c.topClients)):"rules"===e?(be.render(),we.render()):"system-control"===e&&_e.renderTable(),ae()}c.isTouchDevice?u.body.classList.add("touch"):u.body.classList.remove("touch"),requestAnimationFrame(()=>{const e=document.querySelector(".tab-link.active");e&&x(e)}),A();const t=document.getElementById("domain-stats-module");if(t){const e=t.parentElement;e&&"grid"===window.getComputedStyle(e).display&&window.innerWidth>1200?e.style.gridTemplateColumns="1.3fr 1fr 0.8fr":e&&(e.style.gridTemplateColumns="")}}function he(e,t,a){e.closest("table").classList.toggle("mobile-card-view",c.isMobile);const n=[...t].sort((e,t)=>(e.name||"").localeCompare(t.name||""));F(e,n,(e,t)=>{if(c.isMobile){const t=document.createElement("tr");t.dataset.ruleId="adguard"===a?e.id:e.name,e.type&&(t.dataset.ruleType=e.type);const n=e.last_updated&&!e.last_updated.startsWith("0001-01-01")?te(e.last_updated):"从未";return t.innerHTML=`\n                    <td>\n                        <div class="mobile-system-card">\n                            <div class="card-header">\n                                <div style="display:flex; flex-direction:column; max-width:70%;">\n                                    <span class="card-title">${e.name}</span>\n                                    <small style="color:var(--color-text-secondary); margin-top:4px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${e.url}</small>\n                                </div>\n                                <label class="switch">\n                                    <input type="checkbox" class="rule-enabled-toggle" ${e.enabled?"checked":""}>\n                                    <span class="slider"></span>\n                                </label>\n                            </div>\n                            <div class="mobile-stats-grid">\n                                <div class="mobile-stat-item">\n                                    <span class="mobile-stat-label">规则数</span>\n                                    <span class="mobile-stat-value">${(e.rule_count||0).toLocaleString()}</span>\n                                </div>\n                                <div class="mobile-stat-item">\n                                    <span class="mobile-stat-label">上次更新</span>\n                                    <span class="mobile-stat-value">${n}</span>\n                                </div>\n                                ${"diversion"===a?`\n                                <div class="mobile-stat-item" style="grid-column: 1 / -1;">\n                                    <span class="mobile-stat-label">类型</span>\n                                    <span class="mobile-stat-value"><span class="response-tag other">${e.type}</span></span>\n                                </div>`:""}\n                            </div>\n                            <div class="mobile-card-actions">\n                                ${"diversion"===a&&e.url?'<button class="button secondary small rule-update-btn" style="flex:1;">更新</button>':""}\n                                <button class="button secondary small rule-edit-btn" style="flex:1;">编辑</button>\n                                <button class="button danger small rule-delete-btn" style="flex:1;">删除</button>\n                            </div>\n                        </div>\n                    </td>\n                `,t}{const t=function(e,t){const a=document.createElement("tr"),n=e.last_updated&&!e.last_updated.startsWith("0001-01-01")?new Date(e.last_updated).toLocaleString("zh-CN",{hour12:!1}).replace(/\//g,"-"):"—";let s=`<td class="text-center"><label class="switch"><input type="checkbox" class="rule-enabled-toggle" ${e.enabled?"checked":""}><span class="slider"></span></label></td><td>${e.name}</td>`;"diversion"===t&&(s+=`<td><span class="response-tag other">${e.type}</span></td>`);s+=`<td><span class="truncate-text" title="${e.url}">${e.url}</span></td><td class="text-right">${(e.rule_count||0).toLocaleString()}</td><td>${n}</td><td class="text-center"><div style="display: inline-flex; gap: 0.5rem; white-space: nowrap;">`,"diversion"===t&&e.url&&(s+='<button class="button secondary rule-update-btn" style="padding: 0.4rem 0.8rem;" title="更新此规则"><span>更新</span></button>');return s+='<button class="button secondary rule-edit-btn" style="padding: 0.4rem 0.8rem;"><span>编辑</span></button><button class="button danger rule-delete-btn" style="padding: 0.4rem 0.8rem;"><span>删除</span></button></div></td>',a.innerHTML=s,a}(e,a);return t.dataset.ruleId="adguard"===a?e.id:e.name,e.type&&(t.dataset.ruleType=e.type),t}},a)}async function ye(){_.setLoading(u.checkAdguardUpdatesBtn,!0),_.showToast("已开始在后台更新所有启用的拦截规则...");try{await f.fetch("/plugins/adguard/update",{method:"POST"}),_.showToast("更新请求已发送，5秒后自动刷新列表...","success"),await new Promise(e=>setTimeout(e,5e3)),await be.load(),_.showToast("拦截规则列表已刷新！","success")}catch(e){}finally{_.setLoading(u.checkAdguardUpdatesBtn,!1)}}async function ve(e,t){const a=e.target.closest("button, input.rule-enabled-toggle");if(!a)return;const n=a.closest("[data-rule-id]");if(!n)return;const s=n.dataset.ruleId,o=("adguard"===t?c.adguardRules:c.diversionRules).find(e=>("adguard"===t?e.id:e.name)===s);if(o)if(a.matches(".rule-edit-btn"))_.openRuleModal(t,o);else if(a.matches(".rule-delete-btn")){if(confirm(`确定要删除规则 "${o.name}" 吗？此操作不可恢复。`)){_.setLoading(a,!0);try{"adguard"===t?await f.fetch(`/plugins/adguard/rules/${s}`,{method:"DELETE"}):await f.fetch(`/plugins/${we.sdSetInstanceMap[o.type]}/config/${s}`,{method:"DELETE"}),_.showToast(`规则 "${o.name}" 已删除`),await("adguard"===t?be.load():we.load())}catch(e){console.error(`Failed to delete rule ${s}:`,e)}finally{_.setLoading(a,!1)}}}else if(a.matches(".rule-update-btn")){_.setLoading(a,!0),_.showToast(`正在后台更新规则 "${o.name}"...`);try{await f.fetch(`/plugins/${we.sdSetInstanceMap[o.type]}/update/${s}`,{method:"POST"}),_.showToast("更新请求已发送, 5秒后自动刷新","success"),setTimeout(()=>we.load(),5e3)}catch(e){}finally{_.setLoading(a,!1)}}else if(a.matches(".rule-enabled-toggle")){const e={...o,enabled:a.checked};a.disabled=!0;try{"adguard"===t?await f.fetch(`/plugins/adguard/rules/${s}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}):await f.fetch(`/plugins/${we.sdSetInstanceMap[o.type]}/config/${s}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),o.enabled=a.checked,_.showToast(`规则 "${o.name}" 已${a.checked?"启用":"禁用"}`)}catch(e){a.checked=!a.checked}finally{a.disabled=!1}}}async function fe(e){e.preventDefault(),_.setLoading(u.saveRuleBtn,!0);const t=u.ruleForm,a=t.elements.mode.value,n=t.elements.id.value;try{if("adguard"===a){const e={name:t.elements.name.value,url:t.elements.url.value,auto_update:t.elements.auto_update.checked,update_interval_hours:parseInt(t.elements.update_interval_hours.value,10)||24};if(n){const t=c.adguardRules.find(e=>e.id===n);await f.fetch(`/plugins/adguard/rules/${n}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({...t,...e})})}else await f.fetch("/plugins/adguard/rules",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...e,enabled:!0})});_.showToast(`广告拦截规则${n?"更新":"添加"}成功`),await be.load()}else{const e={name:t.elements.name.value,url:t.elements.url.value,type:t.elements.type.value,files:t.elements.files.value,auto_update:t.elements.auto_update.checked,enable_regexp:!!t.elements.enable_regexp&&t.elements.enable_regexp.checked,update_interval_hours:parseInt(t.elements.update_interval_hours.value,10)||24},a=we.sdSetInstanceMap[e.type];if(!a)throw new Error("无效的分流规则类型");if(n){const t=c.diversionRules.find(e=>e.name===n);if(e.name!==n){if(!confirm(`规则名称已从 "${n}" 更改为 "${e.name}"。\n\n这将删除旧规则并创建一个新规则，确定要继续吗？`))throw new Error("User cancelled name change.");await f.fetch(`/plugins/${we.sdSetInstanceMap[t.type]}/config/${n}`,{method:"DELETE"}),await f.fetch(`/plugins/${a}/config/${e.name}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({...e,enabled:t.enabled})})}else await f.fetch(`/plugins/${a}/config/${n}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({...t,...e})})}else await f.fetch(`/plugins/${a}/config/${e.name}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({...e,enabled:!0})});_.showToast(`分流规则${n?"更新":"添加"}成功`),await we.load(),(!n||n&&e.name!==n)&&(_.showToast("正在后台获取规则详情..."),setTimeout(()=>we.load(),5e3))}_.closeRuleModal()}catch(e){console.error(`${a} form submission failed:`,e)}finally{_.setLoading(u.saveRuleBtn,!1)}}const be={async load(){try{c.adguardRules=await f.fetch("/plugins/adguard/rules")||[]}catch(e){c.adguardRules=[]}this.render()},render(){he(u.adguardRulesTbody,c.adguardRules,"adguard")}},we={sdSetInstanceMap:{geositecn:"geosite_cn",geositenocn:"geosite_no_cn",geoipcn:"geoip_cn",cuscn:"cuscn",cusnocn:"cusnocn",nft_add:"nft_add"},async load(){try{const e=Object.values(this.sdSetInstanceMap).map(e=>f.fetch(`/plugins/${e}/config`)),t=await Promise.allSettled(e);c.diversionRules=t.filter(e=>"fulfilled"===e.status&&Array.isArray(e.value)).flatMap(e=>e.value)}catch(e){c.diversionRules=[]}this.render()},render(){he(u.diversionRulesTbody,c.diversionRules,"diversion")}};async function Se(e,t){const a=await fetch(e,{signal:t});if(!a.ok)throw new Error(`HTTP ${a.status}`);const n=a.body?.getReader();if(!n){const e=await a.text();if(!e)return 0;let t=0;for(let a=0;a<e.length;a++)10===e.charCodeAt(a)&&t++;return e.length>0&&10!==e.charCodeAt(e.length-1)&&t++,t}const s=new TextDecoder;let{value:o,done:l}=await n.read(),i="",r=0;for(;!l;){const e=i+s.decode(o,{stream:!0});for(let t=0;t<e.length;t++)10===e.charCodeAt(t)&&r++;const t=e.lastIndexOf("\n");i=-1===t?e:e.slice(t+1),({value:o,done:l}=await n.read())}return(i+s.decode()).length>0&&r++,r}async function Te(e){const t={fakeip:{element:u.fakeipDomainCount,endpoint:"/plugins/my_fakeiplist/show"},realip:{element:u.realipDomainCount,endpoint:"/plugins/my_realiplist/show"},nov4:{element:u.nov4DomainCount,endpoint:"/plugins/my_nov4list/show"},nov6:{element:u.nov6DomainCount,endpoint:"/plugins/my_nov6list/show"},total:{element:u.totalDomainCount,endpoint:"/plugins/top_domains/show"}};for(const a of Object.keys(t)){const{element:n,endpoint:s}=t[a];try{const t=await f.fetch(s+"?limit=1",{signal:e});if(t&&"object"==typeof t&&void 0!==t.totalCount)n.textContent=t.totalCount.toLocaleString();else{const t=await Se(s,e);n.textContent=t.toLocaleString()}}catch(e){"AbortError"!==e.name&&(n.textContent="获取失败")}}try{const e=c.requery.status;e&&"number"==typeof e.last_run_domain_count?(u.backupDomainCount.textContent=`${e.last_run_domain_count.toLocaleString()} 条`,u.backupDomainCount.style.color="var(--color-accent-primary)"):u.backupDomainCount.textContent="--"}catch(e){u.backupDomainCount.textContent="--"}}async function Le(e,t=!1){const{listType:a,cacheTag:n,title:s}=e;t||(c.dataView.currentOffset=0,c.dataView.rawEntries=[],c.dataView.hasMore=!0,c.dataView.totalCount=0,c.dataView.currentConfig=e,u.dataViewModalTitle.textContent=s,u.dataViewTableContainer.innerHTML='<div class="lazy-placeholder"><div class="spinner"></div></div>',u.dataViewModalInfo.textContent="正在加载...",""!==c.dataView.currentQuery||u.dataViewSearch.value||(u.dataViewSearch.value="")),t||lockScroll(),u.dataViewModal.showModal();try{const e=encodeURIComponent(c.dataView.currentQuery),s=c.dataView.currentOffset,o=c.dataView.currentLimit;let l,i="domain";if(a){const t={fakeip:"/plugins/my_fakeiplist/show",realip:"/plugins/my_realiplist/show",nov4:"/plugins/my_nov4list/show",nov6:"/plugins/my_nov6list/show",total:"/plugins/top_domains/show"};l=await f.fetch(`${t[a]}?q=${e}&offset=${s}&limit=${o}`),i="domain"}else n&&(l=await f.fetch(`/plugins/${n}/show?q=${e}&offset=${s}&limit=${o}`),i="cache");let r="";l&&"object"==typeof l&&void 0!==l.totalCount?(r=l.body,c.dataView.totalCount=l.totalCount):r=l;let d=[];if("cache"===i){d=(r.trim()?r.trim().split("----- Cache Entry -----").filter(e=>""!==e.trim()):[]).map((e,t)=>{const a=e.match(/;; QUESTION SECTION:\s*;\s*([^\s]+)/),n=e.match(/DomainSet:\s*(.+)/);let s=a?a[1].replace(/\.$/,""):`Entry #${c.dataView.currentOffset+t+1}`;return n&&(s+=` [${n[1].trim()}]`),{headerTitle:s,fullText:e}})}else{d=(r.trim()?r.trim().split("\n"):[]).map(e=>{const t=e.trim(),a=t.match(/^(\S+)\s+(\S+)\s+(.*)$/);if(a)return{count:a[1],date:a[2],domain:a[3]};const n=t.match(/^(\S+)\s+(.*)$/);return n?{count:n[1],date:"-",domain:n[2]}:{count:"-",date:"-",domain:t}})}c.dataView.lastBatchSize=d.length,c.dataView.rawEntries=t?[...c.dataView.rawEntries,...d]:d,c.dataView.totalCount>0?c.dataView.hasMore=c.dataView.rawEntries.length<c.dataView.totalCount:c.dataView.hasMore=d.length>=c.dataView.currentLimit,c.dataView.viewType=i,function(e,t="domain",a=!1){if(!u.dataViewTableContainer)return;if(a&&!u.dataViewTableContainer.querySelector(".lazy-placeholder")||(u.dataViewTableContainer.innerHTML=""),0===e.length&&!a)return void(u.dataViewTableContainer.innerHTML='<div class="empty-state-content" style="padding: 2rem 0;"><p>没有匹配的条目。</p></div>');const n=a?e.slice(-c.dataView.lastBatchSize):e;if("cache"===t){let e=u.dataViewTableContainer.querySelector(".accordion-container");e||(e=document.createElement("div"),e.className="accordion-container",u.dataViewTableContainer.appendChild(e)),n.forEach(t=>{const a=document.createElement("div");a.className="accordion-item";const n=document.createElement("h2");n.className="accordion-header";const s=document.createElement("button");s.className="accordion-button collapsed",s.type="button",s.textContent=t.headerTitle,n.appendChild(s);const o=document.createElement("div");o.className="accordion-collapse";const l=document.createElement("div");l.className="accordion-body",o.appendChild(l),a.append(n,o),e.appendChild(a),n.addEventListener("click",e=>{e.target===s||s.contains(e.target)||(e.preventDefault(),s.click())}),s.addEventListener("click",()=>{if(s.classList.contains("collapsed")&&""===l.innerHTML){const e=t.fullText.indexOf("DNS Message:"),a=-1!==e?t.fullText.substring(0,e):t.fullText,n=-1!==e?t.fullText.substring(e):"DNS Message not found.",s=document.createElement("table");s.className="data-table";const o=document.createElement("tbody");a.trim().split("\n").forEach(e=>{const t=e.match(/^([^:]+):\s*(.*)$/);if(t){const e=document.createElement("tr");e.innerHTML=`<td>${t[1].trim()}</td><td>${t[2].trim()}</td>`,o.appendChild(e)}}),s.appendChild(o);const i=document.createElement("pre");i.innerHTML=`<code>${n.trim().replace(/</g,"&lt;").replace(/>/g,"&gt;")}</code>`,l.appendChild(s),l.appendChild(i)}s.classList.toggle("collapsed"),o.classList.toggle("show"),o.style.maxHeight=o.classList.contains("show")?l.scrollHeight+"px":"0px"})})}else{let e=u.dataViewTableContainer.querySelector("tbody");e||(u.dataViewTableContainer.innerHTML='\n                    <table class="mobile-card-layout">\n                        <thead>\n                            <tr>\n                                <th style="width: 20%;">次数</th>\n                                <th style="width: 30%;">最后日期</th>\n                                <th>域名</th>\n                            </tr>\n                        </thead>\n                        <tbody></tbody>\n                    </table>',e=u.dataViewTableContainer.querySelector("tbody"));const t=n.map(e=>`\n                <tr>\n                    <td>${e.count}</td>\n                    <td>${e.date}</td>\n                    <td>${e.domain}</td>\n                </tr>\n            `).join("");e.insertAdjacentHTML("beforeend",t)}}(c.dataView.rawEntries,i,t),c.dataView.currentOffset+=d.length,function(){const e=c.dataView.rawEntries.length,t=c.dataView.totalCount;u.dataViewModalInfo.textContent=t>0?`当前显示: ${e.toLocaleString()} / ${t.toLocaleString()} 条`:`当前显示: ${e.toLocaleString()} 条`;let a=document.getElementById("dataview-load-more-btn");c.dataView.hasMore?(a||(a=document.createElement("button"),a.id="dataview-load-more-btn",a.className="button primary small",a.style.cssText="margin-left: auto; height: 32px; padding: 0 15px; font-size: 0.85rem;",a.innerHTML="<span>加载更多</span>",a.onclick=async()=>{_.setLoading(a,!0),await Le(c.dataView.currentConfig,!0),_.setLoading(a,!1)},u.dataViewModal.querySelector(".modal-footer").appendChild(a)),a.style.display="inline-flex"):a&&(a.style.display="none")}()}catch(e){console.error("Data view fetch error:",e),t||(u.dataViewTableContainer.innerHTML='<div class="empty-state-content"><p style="color:var(--color-danger);">加载失败或请求超时</p></div>'),u.dataViewModalInfo.textContent="请求异常"}}async function Ie(){if(confirm("确定要保存所有分流规则吗?")){_.setLoading(u.saveShuntRulesBtn,!0),_.showToast("正在后台保存所有分流规则...");try{const e=p.map(e=>f.fetch(`/plugins/${e}`)),t=await Promise.allSettled(e),a=t.filter(e=>"rejected"===e.status);a.length>0?(_.showToast(`部分规则保存失败 (${a.length}/${t.length})`,"error"),console.error("Failed to save some rules:",a)):_.showToast("所有分流规则已成功保存","success")}catch(e){_.showToast("保存操作时发生未知错误","error")}finally{_.setLoading(u.saveShuntRulesBtn,!1)}}}async function Ee(){if(confirm("【重要操作】确定要清空所有动态生成的分流规则吗？此操作不可撤销。")){_.setLoading(u.clearShuntRulesBtn,!0),_.showToast("正在后台清空所有分流规则...");try{const e=g.map(e=>f.fetch(`/plugins/${e}`));await Promise.allSettled(e),_.showToast("所有分流规则已清空","success"),await Te()}catch(e){_.showToast("清空操作时发生未知错误","error")}finally{_.setLoading(u.clearShuntRulesBtn,!1)}}}const _e={config:[{key:"cache_all",name:"全部缓存 (兼容)",tag:"cache_all"},{key:"cache_cn",name:"国内缓存",tag:"cache_cn"},{key:"cache_node",name:"节点缓存",tag:"cache_node"},{key:"cache_google",name:"国外缓存 (兼容)",tag:"cache_google"},{key:"cache_all_noleak",name:"全部缓存 (安全)",tag:"cache_all_noleak"},{key:"cache_google_node",name:"国外缓存 (安全)",tag:"cache_google_node"},{key:"cache_cnmihomo",name:"国内域名fakeip",tag:"cache_cnmihomo"}],parseMetrics(e,t){const a=e.split("\n"),n={query_total:0,hit_total:0,lazy_hit_total:0,size_current:0},s=`mosdns_cache_query_total{tag="${t}"}`,o=`mosdns_cache_hit_total{tag="${t}"}`,l=`mosdns_cache_lazy_hit_total{tag="${t}"}`,i=`mosdns_cache_size_current{tag="${t}"}`;return a.forEach(e=>{e.startsWith(s)?n.query_total=parseFloat(e.split(" ")[1])||0:e.startsWith(o)?n.hit_total=parseFloat(e.split(" ")[1])||0:e.startsWith(l)?n.lazy_hit_total=parseFloat(e.split(" ")[1])||0:e.startsWith(i)&&(n.size_current=parseFloat(e.split(" ")[1])||0)}),n},async updateStats(e){try{const t=await f.getMetrics(e);t&&this.config.forEach(e=>{c.cacheStats[e.key]=this.parseMetrics(t,e.tag)}),this.renderTable()}catch(e){"AbortError"!==e.name&&(console.error("Failed to update cache stats:",e),this.renderTable(!0))}},renderTable(e=!1){const t=u.cacheStatsTbody;if(!t)return;const a=t.closest("table");if(a&&(c.isMobile?(a.classList.add("mobile-card-view"),a.classList.remove("mobile-card-layout")):(a.classList.remove("mobile-card-view"),a.classList.remove("mobile-card-layout"))),t.innerHTML="",e){const e=c.isMobile?1:8;return void(t.innerHTML=`<tr><td colspan="${e}" style="text-align:center; color: var(--color-danger);">缓存数据加载失败</td></tr>`)}this.config.forEach(e=>{const a=document.createElement("tr"),n=c.cacheStats[e.key]||{query_total:0,hit_total:0,lazy_hit_total:0,size_current:0},s=n.query_total>0?(n.hit_total/n.query_total*100).toFixed(2)+"%":"0.00%",o=n.query_total>0?(n.lazy_hit_total/n.query_total*100).toFixed(2)+"%":"0.00%";c.isMobile?a.innerHTML=`\n                        <td>\n                            <div class="mobile-system-card">\n                                <div class="card-header">\n                                    <div class="card-title">${e.name}</div>\n                                    <button class="button danger small clear-cache-btn" data-cache-tag="${e.tag}" style="padding: 0.3rem 0.6rem;">清空</button>\n                                </div>\n                                <div class="mobile-stats-grid">\n                                    <div class="mobile-stat-item"><span class="mobile-stat-label">条目数</span><span class="mobile-stat-value"><a href="#" class="control-item-link" data-cache-tag="${e.tag}" data-cache-title="${e.name}">${n.size_current.toLocaleString()}</a></span></div>\n                                    <div class="mobile-stat-item"><span class="mobile-stat-label">请求总数</span><span class="mobile-stat-value">${n.query_total.toLocaleString()}</span></div>\n                                    <div class="mobile-stat-item"><span class="mobile-stat-label">缓存命中</span><span class="mobile-stat-value">${n.hit_total.toLocaleString()}</span></div>\n                                    <div class="mobile-stat-item"><span class="mobile-stat-label">命中率</span><span class="mobile-stat-value">${s}</span></div>\n                                    <div class="mobile-stat-item"><span class="mobile-stat-label">过期命中</span><span class="mobile-stat-value">${n.lazy_hit_total.toLocaleString()}</span></div>\n                                    <div class="mobile-stat-item"><span class="mobile-stat-label">过期命中率</span><span class="mobile-stat-value">${o}</span></div>\n                                </div>\n                            </div>\n                        </td>\n                    `:a.innerHTML=`\n                        <td>\n                            <div class="cache-name-wrapper" style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${e.name}">${e.name}</div>\n                        </td>\n                        <td class="text-right">${n.query_total.toLocaleString()}</td>\n                        <td class="text-right">${n.hit_total.toLocaleString()}</td>\n                        <td class="text-right">${n.lazy_hit_total.toLocaleString()}</td>\n                        <td class="text-right">${s}</td>\n                        <td class="text-right">${o}</td>\n                        <td class="text-right"><a href="#" class="control-item-link" data-cache-tag="${e.tag}" data-cache-title="${e.name}">${n.size_current.toLocaleString()}</a></td>\n                        <td class="text-center"><button class="button danger clear-cache-btn" data-cache-tag="${e.tag}" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">清空</button></td>\n                    `,t.appendChild(a)})}},xe={MAX_LINES:1e4,currentTag:null,profiles:[{tag:"whitelist",name:"白名单"},{tag:"blocklist",name:"黑名单"},{tag:"greylist",name:"灰名单"},{tag:"realiplist",name:"!CN fakeip filter"},{tag:"cnfakeipfilter",name:"CN fakeip filter"},{tag:"ddnslist",name:"DDNS 域名"},{tag:"client_ip",name:"客户端 IP"},{tag:"direct_ip",name:"直连 IP"},{tag:"nft_ip",name:"NFT IP"},{tag:"rewrite",name:"重定向"}],init(){c.listManagerInitialized||(u.listMgmtNav.addEventListener("click",e=>{e.preventDefault();const t=e.target.closest(".list-mgmt-link");t&&!t.classList.contains("active")&&this.loadList(t.dataset.listTag)}),u.listSaveBtn.addEventListener("click",()=>this.saveList()),"requestIdleCallback"in window?requestIdleCallback(()=>this.loadList("whitelist"),{timeout:2e3}):setTimeout(()=>this.loadList("whitelist"),1200),c.listManagerInitialized=!0)},async loadList(e){this.currentTag=e;try{this._abortController?.abort()}catch(e){}this._abortController=new AbortController,u.listContentTextArea.value="",u.listContentTextArea.scrollTop=0,u.listMgmtNav.querySelectorAll(".list-mgmt-link").forEach(t=>t.classList.toggle("active",t.dataset.listTag===e)),u.listMgmtClientIpHint.style.display="client_ip"===e?"block":"none",u.listMgmtDirectIpHint&&(u.listMgmtDirectIpHint.style.display="direct_ip"===e?"block":"none"),u.listMgmtNFTIpHint&&(u.listMgmtNFTIpHint.style.display="nft_ip"===e?"block":"none"),u.listMgmtRewriteHint&&(u.listMgmtRewriteHint.style.display="rewrite"===e?"block":"none"),u.listMgmtRealIPHint&&(u.listMgmtRealIPHint.style.display="realiplist"===e?"block":"none"),u.listMgmtCnFakeipFilterHint&&(u.listMgmtCnFakeipFilterHint.style.display="cnfakeipfilter"===e?"block":"none"),u.listContentLoader.style.display="flex",u.listContentTextArea.style.display="none",u.listContentInfo.textContent="正在加载...",_.setLoading(u.listSaveBtn,!0);try{const t=await fetch(`/plugins/${e}/show?limit=${this.MAX_LINES}`,{signal:this._abortController.signal});if(!t.ok)throw new Error(`HTTP ${t.status}`);const a=t.body?.getReader();let n=0,s=0,o="";const l=this.MAX_LINES;let i=!1;if(a){const e=new TextDecoder;for(;;){const{value:t,done:r}=await a.read();if(r)break;let d;for(o+=e.decode(t,{stream:!0});-1!==(d=o.indexOf("\n"));){n++;const e=o.slice(0,d);if(o=o.slice(d+1),s<l&&(u.listContentTextArea.value+=(s?"\n":"")+e,s++),s>=l){i=!0;try{a.cancel()}catch(e){}break}}if(i)break}!i&&o.length>0&&(n++,s<l&&(u.listContentTextArea.value+=(s?"\n":"")+o,s++))}else{const e=(await t.text()).split("\n");n=e.length,u.listContentTextArea.value=e.slice(0,l).join("\n"),s=Math.min(n,l)}u.listContentInfo.textContent=s>=l?`内容较长，已仅加载前 ${l} 行。`:`共 ${s} 行。`}catch(t){"AbortError"===t?.name?u.listContentInfo.textContent="已取消":(u.listContentTextArea.value=`加载列表“${e}”失败。`,u.listContentInfo.textContent="加载失败",_.showToast(`加载列表“${e}”失败`,"error"))}finally{u.listContentLoader.style.display="none",u.listContentTextArea.style.display="block",_.setLoading(u.listSaveBtn,!1),this._abortController=null}},async saveList(){if(this.currentTag){_.setLoading(u.listSaveBtn,!0);try{const e=u.listContentTextArea.value.split("\n").map(e=>e.trim()).filter(Boolean);await f.fetch(`/plugins/${this.currentTag}/post`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({values:e})}),_.showToast(`列表“${this.currentTag}”已保存`,"success"),u.listContentInfo.textContent=`保存成功！共 ${e.length} 行。`}catch(e){_.showToast(`保存列表“${this.currentTag}”失败`,"error")}finally{_.setLoading(u.listSaveBtn,!1)}}}},$e={init(){this.injectCard(),this.loadSettings(),this.bindEvents()},injectCard(){const e=document.getElementById("update-module");if(!e||!e.parentNode)return;const t=document.createElement("div");t.id="config-manager-card",t.className="control-module",t.style.gridColumn="1 / -1",t.innerHTML='\n                <h3>\n                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">\n                        <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>\n                    </svg>\n                    配置管理\n                </h3>\n                <p class="module-desc">管理 MosDNS 的本地配置。您可以备份当前配置到本地，或者从远程 URL 下载配置包覆盖当前设置。</p>\n                \n                <div class="control-item">\n                    <label for="cfg-local-dir" class="field-label">MosDNS 本地工作目录</label>\n                    <input type="text" id="cfg-local-dir" class="input" placeholder="例如: /etc/mosdns 或 C:\\mosdns">\n                </div>\n\n                <div class="control-item">\n                    <label for="cfg-remote-url" class="field-label">远程配置下载 URL (ZIP)</label>\n                    <input type="text" id="cfg-remote-url" class="input" placeholder="例如: https://github.com/user/repo/archive/master.zip">\n                </div>\n\n                <div class="button-group" style="margin-top: 1rem; justify-content: flex-end;">\n                    <button class="button secondary" id="cfg-backup-btn">\n                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>\n                        <span>备份配置</span>\n                    </button>\n                    <button class="button primary" id="cfg-update-btn">\n                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>\n                        <span>应用远程配置</span>\n                    </button>\n                </div>\n            ',e.parentNode.insertBefore(t,e.nextSibling)},loadSettings(){const e=localStorage.getItem("mosdns-config-dir"),t=localStorage.getItem("mosdns-config-url"),a=document.getElementById("cfg-local-dir"),n=document.getElementById("cfg-remote-url");a&&e&&(a.value=e),n&&t&&(n.value=t)},saveSettings(){const e=document.getElementById("cfg-local-dir"),t=document.getElementById("cfg-remote-url");e&&localStorage.setItem("mosdns-config-dir",e.value.trim()),t&&localStorage.setItem("mosdns-config-url",t.value.trim())},bindEvents(){const e=document.getElementById("cfg-backup-btn"),t=document.getElementById("cfg-update-btn"),a=document.getElementById("cfg-local-dir"),n=document.getElementById("cfg-remote-url");a?.addEventListener("change",()=>this.saveSettings()),n?.addEventListener("change",()=>this.saveSettings()),e?.addEventListener("click",()=>this.handleBackup(e)),t?.addEventListener("click",()=>this.handleUpdate(t))},async handleBackup(e){const t=document.getElementById("cfg-local-dir").value.trim();if(t){this.saveSettings(),_.setLoading(e,!0);try{const e=await fetch("/api/v1/config/export",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({dir:t})});if(!e.ok){const t=await e.text();throw new Error(t||`HTTP ${e.status}`)}const a=await e.blob(),n=window.URL.createObjectURL(a),s=document.createElement("a");s.style.display="none",s.href=n;const o=e.headers.get("Content-Disposition");let l="mosdns_backup.zip";if(o&&-1!==o.indexOf("attachment")){const e=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(o);null!=e&&e[1]&&(l=e[1].replace(/['"]/g,""))}s.download=l,document.body.appendChild(s),s.click(),window.URL.revokeObjectURL(n),_.showToast("备份文件下载开始","success")}catch(e){console.error("Backup failed:",e),_.showToast(`备份失败: ${e.message}`,"error")}finally{_.setLoading(e,!1)}}else _.showToast("请先输入 MosDNS 本地工作目录","error")},async handleUpdate(e){const t=document.getElementById("cfg-local-dir").value.trim(),a=document.getElementById("cfg-remote-url").value.trim();if(t&&a){if(confirm("确定要从远程 URL 更新配置吗？\n\n1. 当前配置将备份到 backup 子目录。\n2. 新配置将覆盖现有文件。\n3. MosDNS 将自动重启。\n\n此操作存在风险，请确保 URL 可信。")){this.saveSettings(),_.setLoading(e,!0);try{const e=await f.fetch("/api/v1/config/update_from_url",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:a,dir:t})});_.showToast(e.message||"更新成功，4秒后重启...","success"),setTimeout(()=>{location.reload()},4e3)}catch(t){console.error("Update failed:",t),_.showToast(`更新失败: ${t.message}`,"error"),_.setLoading(e,!1)}}}else _.showToast("请完整填写本地目录和远程 URL","error")}},ke={state:{replacements:[]},getElements(){const e=e=>document.getElementById(e)||document.getElementById(e.replace("-log",""));return{module:e("overrides-module"),socks5:e("override-socks5-log"),ecs:e("override-ecs-log"),oldSaveBtn:e("overrides-save-btn-log"),oldLoadBtn:e("overrides-load-btn-log")}},async load(e=!1){const t=this.getElements();if(t.socks5){t.oldSaveBtn&&(t.oldSaveBtn.style.display="none"),t.oldLoadBtn&&(t.oldLoadBtn.style.display="none"),this.injectNewCard();try{const a=await f.fetch("/api/v1/overrides");t.socks5&&(t.socks5.value=a&&a.socks5||""),t.ecs&&(t.ecs.value=a&&a.ecs||""),this.state.replacements=a&&a.replacements?a.replacements:[],this.renderReplacementsTable(),e||_.showToast("已读取当前覆盖配置")}catch(t){e||_.showToast("读取覆盖配置失败","error")}}},injectNewCard(){if(document.getElementById("replacements-card"))return;const e=this.getElements();if(!e.module||!e.module.parentNode)return;const t=document.createElement("div");t.id="replacements-card",t.className="control-module",t.style.gridColumn="1 / -1",t.innerHTML='\n                <div class="module-header">\n                    <h3>\n                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">\n                            <path d="M7.5 5.6L5 7 6.4 4.5 5 2 7.5 3.4 10 2 8.6 4.5 10 7 7.5 5.6zm12 9.8L22 17l-2.5 1.4L18.1 22l-1.4-2.5L14.2 18l2.5-1.4L18.1 14l1.4 2.5zM11 10c0-3.31 2.69-6 6-6s6 2.69 6 6-2.69 6-6 6-6-2.69-6-6zm-8 8c0-3.31 2.69-6 6-6s6 2.69 6 6-2.69 6-6 6-6-2.69-6-6z"/>\n                        </svg>\n                        其它设置\n                    </h3>\n                    <button class="button secondary small" id="rep-add-btn">\n                        <span>+ 添加规则</span>\n                    </button>\n                </div>\n\n                <p class="module-desc">配置说明：https://github.com/yyysuo/mosdns</p>\n                \n                <div class="scrollable-table-container">\n                    <table class="data-table" style="min-width: 650px;">\n                        <thead>\n                            <tr>\n                                <th style="width: 15%;">状态</th>\n                                <th style="width: 25%;">原值 (查找)</th>\n                                <th style="width: 25%;">新值 (替换)</th>\n                                <th>备注</th>\n                                <th style="width: 60px; text-align: center;">操作</th>\n                            </tr>\n                        </thead>\n                        <tbody id="rep-tbody"></tbody>\n                    </table>\n                </div>\n\n                <div class="button-group" style="margin-top: 1rem; justify-content: flex-end;">\n                    <span style="color: var(--color-text-secondary); font-size: 0.85em; margin-right: auto;">保存应用SOCKS5/ECS IP/上游DNS设置</span>\n                    <button class="button primary" id="rep-save-btn">\n                        <span>保存并重启</span>\n                    </button>\n                </div>\n            ',e.module.parentNode.insertBefore(t,e.module.nextSibling),t.querySelector("#rep-add-btn").addEventListener("click",()=>{this.state.replacements.push({original:"",new:"",comment:""}),this.renderReplacementsTable()}),t.querySelector("#rep-save-btn").addEventListener("click",()=>this.save());const a=t.querySelector("#rep-tbody");a.addEventListener("click",e=>{const t=e.target.closest(".rep-del-btn");if(t){const e=parseInt(t.dataset.index);this.state.replacements.splice(e,1),this.renderReplacementsTable()}}),a.addEventListener("input",e=>{if(e.target.matches("input")){const t=parseInt(e.target.dataset.index),a=e.target.dataset.field;this.state.replacements[t][a]=e.target.value}})},renderReplacementsTable(){const e=document.getElementById("rep-tbody");if(!e)return;const t=e.closest("table");t&&(c.isMobile?t.classList.add("mobile-card-view"):t.classList.remove("mobile-card-view")),0!==this.state.replacements.length?e.innerHTML=this.state.replacements.map((e,t)=>{let a='<span class="response-tag other" style="font-size: 0.8em; opacity: 0.7;">未保存</span>';return e.result&&(a=e.result.startsWith("Success")?`<span class="response-tag noerror" style="font-size: 0.8em;">${e.result}</span>`:e.result.includes("Not Found")?`<span class="response-tag nxdomain" style="font-size: 0.8em;">${e.result}</span>`:`<span class="response-tag other" style="font-size: 0.8em;">${e.result}</span>`),c.isMobile?`\n                        <tr>\n                            <td>\n                                <div class="mobile-system-card">\n                                    <div class="card-header">\n                                        <div style="font-size:0.9rem; font-weight:600;">规则 #${t+1}</div>\n                                        ${a}\n                                    </div>\n                                    <div class="mobile-override-row">\n                                        <div>\n                                            <label style="font-size:0.75rem; color:var(--color-text-secondary);">原值 (查找)</label>\n                                            <input type="text" class="input" value="${e.original||""}" data-index="${t}" data-field="original" placeholder="例如: 1.1.1.1">\n                                        </div>\n                                        <div>\n                                            <label style="font-size:0.75rem; color:var(--color-text-secondary);">新值 (替换)</label>\n                                            <input type="text" class="input" value="${e.new||""}" data-index="${t}" data-field="new" placeholder="例如: 127.0.0.1">\n                                        </div>\n                                        <div>\n                                            <label style="font-size:0.75rem; color:var(--color-text-secondary);">备注</label>\n                                            <input type="text" class="input" value="${e.comment||""}" data-index="${t}" data-field="comment" placeholder="可选">\n                                        </div>\n                                    </div>\n                                    <div style="text-align:right; margin-top:0.8rem;">\n                                        <button class="button danger small rep-del-btn" data-index="${t}" style="width:100%;">删除规则</button>\n                                    </div>\n                                </div>\n                            </td>\n                        </tr>\n                    `:`\n                        <tr style="border-bottom: 1px solid var(--color-border);">\n                            <td style="padding: 8px;">${a}</td>\n                            <td style="padding: 8px;">\n                                <input type="text" class="input" style="width: 100%;" value="${e.original||""}" data-index="${t}" data-field="original" placeholder="例如: 1.1.1.1">\n                            </td>\n                            <td style="padding: 8px;">\n                                <input type="text" class="input" style="width: 100%;" value="${e.new||""}" data-index="${t}" data-field="new" placeholder="例如: 127.0.0.1">\n                            </td>\n                            <td style="padding: 8px;">\n                                <input type="text" class="input" style="width: 100%;" value="${e.comment||""}" data-index="${t}" data-field="comment" placeholder="备注 (可选)">\n                            </td>\n                            <td style="padding: 8px; text-align: center;">\n                                <button class="button danger small rep-del-btn" data-index="${t}" title="删除此行" style="padding: 6px 10px;">\n                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>\n                                </button>\n                            </td>\n                        </tr>\n                    `}).join(""):e.innerHTML='<tr><td colspan="5" class="text-center" style="padding: 2rem; color: var(--color-text-secondary); font-style: italic;">暂无替换规则</td></tr>'},async save(){const e=this.getElements();if(!e.socks5||!e.ecs)return;const t=document.getElementById("rep-save-btn");_.setLoading(t,!0);const a={socks5:e.socks5.value.trim(),ecs:e.ecs.value.trim(),replacements:this.state.replacements.map(e=>({original:e.original.trim(),new:e.new.trim(),comment:e.comment?e.comment.trim():""})).filter(e=>e.original)};try{await f.fetch("/api/v1/overrides",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),_.showToast("配置已保存，4秒后重启服务…","success");try{await f.fetch("/api/v1/system/restart",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({delay_ms:300})}),setTimeout(()=>{location.reload()},4e3)}catch(e){_.showToast("自动重启请求失败，请尝试手动重启","error"),_.setLoading(t,!1)}}catch(e){_.showToast("保存配置失败","error"),console.error("Save Error:",e),_.setLoading(t,!1)}}},Be={state:{tags:[],config:{},metrics:{}},init(){if(!document.getElementById("upstream-dns-module"))return;this.bindEvents();const e=document.getElementById("system-control-tab");e&&e.classList.contains("active")&&this.loadData()},bindEvents(){document.getElementById("add-upstream-btn")?.addEventListener("click",()=>this.openModal()),document.getElementById("upstream-restart-btn")?.addEventListener("click",()=>this.restartService()),document.getElementById("upstream-dns-tbody")?.addEventListener("click",e=>{const t=e.target.closest("button");if(!t)return;const a=t.closest("tr"),n=a.dataset.group,s=parseInt(a.dataset.index,10);t.classList.contains("edit-btn")?this.openModal(n,s):t.classList.contains("delete-btn")&&this.deleteUpstream(n,s)}),document.getElementById("upstream-dns-tbody")?.addEventListener("change",e=>{if(e.target.matches(".upstream-enable-toggle")){const t=e.target.closest("tr");this.toggleEnable(t.dataset.group,parseInt(t.dataset.index,10),e.target.checked)}});const e=document.getElementById("upstream-modal"),t=document.getElementById("upstream-form"),a=document.getElementById("upstream-protocol");document.getElementById("close-upstream-modal")?.addEventListener("click",()=>closeAndUnlock(e)),document.getElementById("cancel-upstream-modal")?.addEventListener("click",()=>closeAndUnlock(e)),a?.addEventListener("change",()=>this.updateFormFields(a.value)),t?.addEventListener("submit",e=>{e.preventDefault(),this.handleSave(new FormData(t))})},async loadData(){try{const[e,t,a]=await Promise.all([f.fetch("/api/v1/upstream/tags"),f.fetch("/api/v1/upstream/config"),f.getMetrics()]);this.state.tags=Array.isArray(e)?e:[],this.state.config=t||{},this.parseMetrics(a),this.renderTable()}catch(e){console.error("Upstream data load failed",e),_.showToast("加载上游配置失败","error")}},parseMetrics(e){const t=t=>{const a=new RegExp(`${t}\\{[^}]*metrics_tag="([^"]+)"[^}]*tag="([^"]+)"[^}]*\\} ([0-9.eE+-]+)`,"g"),n={};let s;for(;null!==(s=a.exec(e));){const e=s[1],t=s[2],a=parseFloat(s[3]);n[`${e}|${t}`]=a}return n};this.state.metrics={latSum:t("mosdns_aliapi_response_latency_millisecond_sum"),latCount:t("mosdns_aliapi_response_latency_millisecond_count"),queryTotal:t("mosdns_aliapi_query_total"),errorTotal:t("mosdns_aliapi_error_total"),winnerTotal:t("mosdns_aliapi_upstream_winner_total")}},renderTable(){const e=document.getElementById("upstream-dns-tbody");if(!e)return;const t=e.closest("table");t&&(c.isMobile?t.classList.add("mobile-card-view"):t.classList.remove("mobile-card-view")),e.innerHTML="";const a=[];for(const[e,t]of Object.entries(this.state.config))t&&Array.isArray(t)&&t.forEach((t,n)=>{a.push({u:t,group:e,originalIndex:n})});0!==a.length?(a.sort((e,t)=>{const a=(t.u.enabled?1:0)-(e.u.enabled?1:0);if(0!==a)return a;const n=e.group.localeCompare(t.group);return 0!==n?n:(e.u.tag||"").localeCompare(t.u.tag||"")}),a.forEach(t=>{const a=t.u,n=t.group,s=t.originalIndex,o=`${n}|${a.tag}`,l=a.enabled?this.getStats(o):{avgLat:"-",query:"-",error:"-",rate:"-",winner:"-",winRate:"-"},i=document.createElement("tr");i.dataset.group=n,i.dataset.index=s,a.enabled||(i.style.opacity="0.6"),c.isMobile?i.innerHTML=`\n                        <td>\n                            <div class="mobile-system-card">\n                                <div class="card-header">\n                                    <div style="display:flex; flex-direction:column; max-width: 70%;">\n                                        <span class="card-title">${a.tag}</span>\n                                        <small style="color:var(--color-text-secondary); margin-top:4px;">${n} · ${a.protocol}</small>\n                                    </div>\n                                    <label class="switch">\n                                        <input type="checkbox" class="upstream-enable-toggle" ${a.enabled?"checked":""}>\n                                        <span class="slider"></span>\n                                    </label>\n                                </div>\n                                <div class="mobile-stats-grid">\n                                    <div class="mobile-stat-item"><span class="mobile-stat-label">平均响应</span><span class="mobile-stat-value">${l.avgLat}</span></div>\n                                    <div class="mobile-stat-item"><span class="mobile-stat-label">请求数</span><span class="mobile-stat-value">${l.query}</span></div>\n                                    \n                                    <div class="mobile-stat-item"><span class="mobile-stat-label">采纳数</span><span class="mobile-stat-value">${l.winner}</span></div>\n                                    <div class="mobile-stat-item"><span class="mobile-stat-label">采纳率</span><span class="mobile-stat-value">${l.winRate}</span></div>\n                                    \n                                    <div class="mobile-stat-item"><span class="mobile-stat-label">错误数</span><span class="mobile-stat-value" style="${l.error>0?"color:var(--color-danger)":""}">${l.error}</span></div>\n                                    <div class="mobile-stat-item"><span class="mobile-stat-label">出错率</span><span class="mobile-stat-value">${l.rate}</span></div>\n                                </div>\n                                <div class="mobile-card-actions">\n                                    <button class="button secondary small edit-btn" style="flex:1;">编辑</button>\n                                    <button class="button danger small delete-btn" style="flex:1;">删除</button>\n                                </div>\n                            </div>\n                        </td>\n                    `:i.innerHTML=`\n                        <td class="text-center">\n                            <label class="switch">\n                                <input type="checkbox" class="upstream-enable-toggle" ${a.enabled?"checked":""}>\n                                <span class="slider"></span>\n                            </label>\n                        </td>\n                        <td>${n}</td>\n                        <td>${a.tag}</td>\n                        <td>${a.protocol}</td>\n                        <td class="text-center">${l.avgLat}</td>\n                        <td class="text-center">${l.query}</td>\n                        <td class="text-center">${l.winner}</td>\n                        <td class="text-center">${l.winRate}</td>\n                        <td class="text-center">${l.error}</td>\n                        <td class="text-center">${l.rate}</td>\n                        <td class="text-center">\n                             <div style="display: inline-flex; gap: 0.5rem;">\n                                <button class="button secondary small edit-btn" style="padding: 0.3rem 0.6rem;">编辑</button>\n                                <button class="button danger small delete-btn" style="padding: 0.3rem 0.6rem;">删除</button>\n                            </div>\n                        </td>\n                    `,e.appendChild(i)})):e.innerHTML='<tr><td colspan="9" class="text-center" style="padding:2rem;">暂无上游配置，请点击添加。</td></tr>'},getStats(e){const t=this.state.metrics,a=t.queryTotal[e]||0,n=t.errorTotal[e]||0,s=t.winnerTotal[e]||0,o=t.latSum[e]||0,l=t.latCount[e]||0;return{avgLat:l>0?(o/l).toFixed(2)+" ms":"0 ms",query:a,error:n,rate:a>0?(n/a*100).toFixed(2)+"%":"0.00%",winner:s,winRate:a>0?(s/a*100).toFixed(2)+"%":"0.00%"}},openModal(e=null,t=null){const a=document.getElementById("upstream-modal"),n=document.getElementById("upstream-form"),s=document.getElementById("upstream-group"),o=document.getElementById("upstream-protocol");n.reset(),s.innerHTML="";const l=new Set;if(Array.isArray(this.state.tags)&&this.state.tags.forEach(e=>{e&&"string"==typeof e&&isNaN(e)&&l.add(e)}),this.state.config&&"object"==typeof this.state.config&&Object.keys(this.state.config).forEach(e=>{e&&isNaN(e)&&l.add(e)}),l.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,s.appendChild(t)}),e&&null!==t){document.getElementById("upstream-modal-title").textContent="编辑上游DNS";const a=this.state.config[e][t];s.value=e,s.disabled=!0,document.getElementById("upstream-original-tag").value=t,n.elements.tag.value=a.tag||"",o.value=a.protocol||"udp",n.elements.addr.value=a.addr||"",n.elements.dial_addr.value=a.dial_addr||"",n.elements.socks5.value=a.socks5||"",n.elements.bootstrap.value=a.bootstrap||"",n.elements.bootstrap_version.value=a.bootstrap_version||0,n.elements.enable_pipeline&&(n.elements.enable_pipeline.checked=!!a.enable_pipeline),n.elements.enable_http3&&(n.elements.enable_http3.checked=!!a.enable_http3),n.elements.insecure_skip_verify&&(n.elements.insecure_skip_verify.checked=!!a.insecure_skip_verify),n.elements.idle_timeout.value=a.idle_timeout||"",n.elements.upstream_query_timeout.value=a.upstream_query_timeout||"",n.elements.bind_to_device.value=a.bind_to_device||"",n.elements.so_mark.value=a.so_mark||"",n.elements.account_id.value=a.account_id||"",n.elements.access_key_id.value=a.access_key_id||"",n.elements.access_key_secret.value=a.access_key_secret||"",n.elements.server_addr.value=a.server_addr||"223.5.5.5",n.elements.ecs_client_ip.value=a.ecs_client_ip||"",n.elements.ecs_client_mask.value=a.ecs_client_mask||""}else document.getElementById("upstream-modal-title").textContent="添加上游DNS",s.disabled=!1,s.options.length>0&&(s.selectedIndex=0),document.getElementById("upstream-original-tag").value=-1,o.value="aliapi";this.updateFormFields(o.value),lockScroll(),a.showModal()},updateFormFields(e){const t=document.getElementById("group-dns"),a=document.getElementById("group-aliapi"),n=e=>t.querySelectorAll(e).forEach(e=>e.style.display="block");var s;"aliapi"===e?(a.style.display="block",t.style.display="none"):(a.style.display="none",t.style.display="block",s=".field-socks5, .field-pipeline, .field-http3, .field-tls-verify",t.querySelectorAll(s).forEach(e=>e.style.display="none"),["tcp","dot","tls"].includes(e)&&n(".field-pipeline"),["https","doh","quic","doq"].includes(e)&&n(".field-http3"),["dot","tls","tcp","doh","https","quic","doq"].includes(e)&&(n(".field-tls-verify"),n(".field-socks5")))},async handleSave(e){const t=document.getElementById("save-upstream-btn");_.setLoading(t,!0);const a=document.getElementById("upstream-group").value;if(!a)return _.showToast("请选择所属组","error"),void _.setLoading(t,!1);const n=parseInt(document.getElementById("upstream-original-tag").value,10),s=e.get("protocol"),o={tag:e.get("tag"),protocol:s,addr:"aliapi"!==s?e.get("addr"):"",dial_addr:"aliapi"!==s?e.get("dial_addr"):"",idle_timeout:"aliapi"!==s&&parseInt(e.get("idle_timeout"))||0,upstream_query_timeout:"aliapi"!==s&&parseInt(e.get("upstream_query_timeout"))||0,bind_to_device:"aliapi"!==s?e.get("bind_to_device"):"",so_mark:"aliapi"!==s&&parseInt(e.get("so_mark"))||0,enable_pipeline:"aliapi"!==s&&"on"===e.get("enable_pipeline"),enable_http3:"aliapi"!==s&&"on"===e.get("enable_http3"),insecure_skip_verify:"aliapi"!==s&&"on"===e.get("insecure_skip_verify"),socks5:"aliapi"!==s?e.get("socks5"):"",bootstrap:"aliapi"!==s?e.get("bootstrap"):"",bootstrap_version:"aliapi"!==s&&parseInt(e.get("bootstrap_version"))||0,account_id:"aliapi"===s?e.get("account_id"):"",access_key_id:"aliapi"===s?e.get("access_key_id"):"",access_key_secret:"aliapi"===s?e.get("access_key_secret"):"",server_addr:"aliapi"===s?e.get("server_addr"):"",ecs_client_ip:"aliapi"===s?e.get("ecs_client_ip"):"",ecs_client_mask:"aliapi"===s&&parseInt(e.get("ecs_client_mask"))||0};this.state.config&&"object"==typeof this.state.config&&!Array.isArray(this.state.config)||(this.state.config={}),Array.isArray(this.state.config[a])||(this.state.config[a]=[]);let l=this.state.config[a];n>=0&&l[n]?(o.enabled=l[n].enabled,l[n]=o):(o.enabled=!0,l.push(o));try{await f.fetch("/api/v1/upstream/config",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({plugin_tag:a,upstreams:l})}),_.showToast("保存成功"),closeAndUnlock(document.getElementById("upstream-modal")),await this.loadData()}catch(e){console.error("Save upstream error:",e),_.showToast("保存失败: "+e.message,"error")}finally{_.setLoading(t,!1)}},async toggleEnable(e,t,a){const n=this.state.config[e];if(n&&n[t]){n[t].enabled=a;try{await f.fetch("/api/v1/upstream/config",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({plugin_tag:e,upstreams:n})}),this.renderTable()}catch(e){_.showToast("状态更新失败","error"),n[t].enabled=!a,this.renderTable()}}},async deleteUpstream(e,t){if(!confirm("确定要删除此上游吗？"))return;const a=this.state.config[e];a.splice(t,1);try{await f.fetch("/api/v1/upstream/config",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({plugin_tag:e,upstreams:a})}),_.showToast("已删除"),this.renderTable()}catch(e){_.showToast("删除失败","error")}},async restartService(){if(confirm("重启 MosDNS 以应用更改？"))try{await f.fetch("/api/v1/system/restart",{method:"POST",body:JSON.stringify({delay_ms:500})}),_.showToast("正在重启...","success"),setTimeout(()=>location.reload(),4e3)}catch(e){_.showToast("重启请求失败","error")}}};function Ce(){document.querySelectorAll("dialog").forEach(e=>{e.addEventListener("click",t=>{t.target===e&&"upstream-modal"!==e.id&&closeAndUnlock(e)}),e.addEventListener("cancel",t=>{t.preventDefault(),closeAndUnlock(e)})}),u.tabLinks.forEach(e=>e.addEventListener("click",t=>{t.preventDefault(),pe(e)})),u.overridesLoadBtn&&u.overridesLoadBtn.addEventListener("click",()=>ke.load(!1)),u.overridesSaveBtn&&u.overridesSaveBtn.addEventListener("click",()=>ke.save()),window.addEventListener("popstate",()=>{const e=window.location.hash||"#overview";pe(document.querySelector(`.tab-link[href="${e}"]`)||u.tabLinks[0])}),window.addEventListener("resize",h(ge,150)),u.globalRefreshBtn?.addEventListener("click",()=>Y(!0)),setInterval(ae,5e3),[u.autoRefreshToggle,u.autoRefreshIntervalInput].forEach(e=>e&&e.addEventListener("change",()=>{const e=u.autoRefreshToggle.checked;u.autoRefreshIntervalInput.disabled=!e,me.updateSettings(e,parseInt(u.autoRefreshIntervalInput.value,10)||15)})),document.addEventListener("visibilitychange",()=>document.hidden?me.stop():me.start()),u.toggleAuditBtn?.addEventListener("click",async e=>{const t=e.currentTarget;_.setLoading(t,!0);try{await(c.isCapturing?f.stop():f.start()),await Y(!0)}catch(e){console.error("操作失败:",e),_.setLoading(t,!1)}}),u.clearAuditBtn?.addEventListener("click",async e=>{if(confirm("确定要清空所有内存审计日志吗？此操作不可恢复。")){const t=e.currentTarget;_.setLoading(t,!0);try{await f.clear(),_.showToast("日志已清空","success"),u.logSearch&&(u.logSearch.value=""),await Y(!0)}catch(e){_.showToast("清空日志失败","error")}finally{_.setLoading(t,!1)}}}),u.capacityForm?.addEventListener("submit",async e=>{e.preventDefault();const t=parseInt(u.newCapacityInput.value,10);if(!t||t<=0||t>4e5)_.showToast("请输入1到400000之间的有效容量","error");else if(confirm(`确定要将容量设置为 ${t.toLocaleString()} 吗？\n\n注意：这将清空当前所有日志。`)){const a=e.currentTarget.querySelector("button");_.setLoading(a,!0);try{await f.setCapacity(t),_.showToast(`容量已成功设置为 ${t.toLocaleString()}`,"success"),u.newCapacityInput.value="",u.logSearch&&(u.logSearch.value=""),await Y(!0)}catch(e){console.error("Set capacity failed:",e)}finally{_.setLoading(a,!1)}}}),u.logSearch?.addEventListener("input",h(K,300)),u.logQueryTableContainer?.addEventListener("scroll",()=>{const{scrollTop:e,scrollHeight:t,clientHeight:a}=u.logQueryTableContainer;a+e>=t-200&&(c.isLogLoading||!c.logPaginationInfo||c.currentLogPage>=c.logPaginationInfo.total_pages||X(c.currentLogPage+1,!0))},{passive:!0});const e=e=>{const t=e.target.closest(".copy-btn, .filter-btn"),a=e.target.closest(".clickable-link, .tab-link-action"),n=e.target.closest("tr[data-log-index], tr[data-rank-index]");if(t){if(e.stopPropagation(),t.matches(".copy-btn")){const e=t.dataset.copyValue;if(navigator.clipboard&&window.isSecureContext)navigator.clipboard.writeText(e).then(()=>{_.showToast("已复制到剪贴板")}).catch(()=>{_.showToast("复制失败","error")});else{const t=document.createElement("textarea");t.value=e,t.style.position="absolute",t.style.left="-9999px";const a=u.logDetailModal.open?u.logDetailModal:document.body;a.appendChild(t),t.select();try{document.execCommand("copy"),_.showToast("已复制到剪贴板")}catch(e){_.showToast("复制失败","error")}finally{a.removeChild(t)}}}else if(t.matches(".filter-btn")){const e=t.dataset.filterValue,a="true"===t.dataset.exactSearch;u.logSearch.value=a?`"${e}"`:e;const n=document.querySelector('.tab-link[href="#log-query"]');n&&!n.classList.contains("active")?pe(n):K(),se.hide(),u.logDetailModal.open&&u.logDetailModal.close()}}else if(a){if(e.preventDefault(),a.matches(".clickable-link")){const e=a.dataset.filterValue,t="true"===a.dataset.exactSearch;u.logSearch.value=t?`"${e}"`:e;const n=document.querySelector('.tab-link[href="#log-query"]');n&&(n.classList.contains("active")||pe(n),K())}else if(a.matches(".tab-link-action")){const e=document.querySelector(`.tab-link[data-tab="${a.dataset.tab}"]`);e&&pe(e)}}else if(n)try{_.openLogDetailModal(n)}catch(e){console.error("Open modal failed:",e),_.showToast("无法加载详情","error")}};u.body.addEventListener("click",e),u.logDetailModal.addEventListener("click",e),u.body.addEventListener("mouseover",e=>{if(c.isTouchDevice)return;const t=e.target.closest("[data-log-index], [data-rank-index], [data-rule-id]");t&&se.handleTriggerEnter(t)}),u.body.addEventListener("mouseout",e=>{if(c.isTouchDevice)return;e.target.closest("[data-log-index], [data-rank-index], [data-rule-id]")&&se.handleTriggerLeave()}),u.tooltip.addEventListener("mouseenter",()=>se.handleTooltipEnter()),u.tooltip.addEventListener("mouseleave",()=>se.handleTooltipLeave()),u.closeLogDetailModalBtn?.addEventListener("click",()=>closeAndUnlock(u.logDetailModal)),u.aliasModal&&([u.manageAliasesBtn,u.manageAliasesBtnMobile].forEach(e=>e?.addEventListener("click",async()=>{await M.renderEditableList(),lockScroll(),u.aliasModal.showModal()})),document.getElementById("close-alias-modal")?.addEventListener("click",()=>closeAndUnlock(u.aliasModal)),u.saveAllAliasesBtn?.addEventListener("click",async()=>{const e=u.saveAllAliasesBtn;_.setLoading(e,!0);try{await M.saveAll()}finally{_.setLoading(e,!1)}}),document.getElementById("export-aliases-btn")?.addEventListener("click",async e=>{const t=e.currentTarget;_.setLoading(t,!0);try{await M.export()}finally{_.setLoading(t,!1)}}),document.getElementById("import-aliases-btn")?.addEventListener("click",()=>u.importAliasInput?.click()),u.importAliasInput?.addEventListener("change",e=>{e.target.files?.length>0&&(M.import(e.target.files[0]),e.target.value="")}),u.manualAliasForm.addEventListener("submit",async e=>{e.preventDefault();const t=e.currentTarget.querySelector("button");_.setLoading(t,!0);const a=document.getElementById("manual-alias-ip").value.trim(),n=document.getElementById("manual-alias-name").value.trim();try{a&&n?(M.set(a,n),await M.save(),_.showToast(`已添加别名: ${n} -> ${a}`,"success"),e.target.reset(),await M.renderEditableList(),await Y(!1)):_.showToast("IP地址和别名均不能为空","error")}catch(e){}finally{_.setLoading(t,!1)}})),u.ruleForm.addEventListener("submit",fe),u.closeRuleModalBtn.addEventListener("click",()=>closeAndUnlock(u.ruleModal)),u.cancelRuleModalBtn.addEventListener("click",()=>closeAndUnlock(u.ruleModal)),u.addAdguardRuleBtn.addEventListener("click",()=>_.openRuleModal("adguard")),u.checkAdguardUpdatesBtn.addEventListener("click",ye),u.adguardRulesTbody.addEventListener("click",e=>ve(e,"adguard")),u.addDiversionRuleBtn.addEventListener("click",()=>_.openRuleModal("diversion")),u.diversionRulesTbody.addEventListener("click",e=>ve(e,"diversion")),u.rulesSubNavLinks.forEach(e=>{e.addEventListener("click",()=>{u.rulesSubNavLinks.forEach(e=>e.classList.remove("active")),e.classList.add("active");const t=e.dataset.subTab;u.rulesSubTabContents.forEach(e=>{e.classList.toggle("active",e.id===`${t}-sub-tab`)}),"list-mgmt"!==t||c.listManagerInitialized?"adguard"===t&&0===c.adguardRules.length?(O(u.adguardRulesTbody,5,c.isMobile?1:6),be.load()):"diversion"===t&&0===c.diversionRules.length&&(O(u.diversionRulesTbody,5,c.isMobile?1:7),we.load()):xe.init()})}),document.body.addEventListener("click",e=>{const t=e.target.closest("a.control-item-link[data-list-type]"),a=e.target.closest("a.control-item-link[data-cache-tag]"),n=e.target.closest(".clear-cache-btn[data-cache-tag]");if(t)e.preventDefault(),Le({listType:t.dataset.listType,title:t.dataset.listTitle});else if(a)e.preventDefault(),Le({cacheTag:a.dataset.cacheTag,title:a.dataset.cacheTitle});else if(n){e.preventDefault();const t=n.dataset.cacheTag;confirm(`确定要清空缓存 "${t}" 吗？`)&&(_.setLoading(n,!0),f.clearCache(t).then(()=>(_.showToast(`缓存 "${t}" 已清空`,"success"),_e.updateStats())).catch(e=>{_.showToast(`清空缓存 "${t}" 失败`,"error")}).finally(()=>{}))}}),u.closeDataViewModalBtn&&u.closeDataViewModalBtn.addEventListener("click",function(){closeAndUnlock(u.dataViewModal)}),u.dataViewSearch&&u.dataViewSearch.addEventListener("input",h(function(){var e=u.dataViewSearch.value.trim();c.dataView.currentQuery=e,Le(c.dataView.currentConfig,!1)},400)),u.saveShuntRulesBtn&&u.saveShuntRulesBtn.addEventListener("click",Ie),u.clearShuntRulesBtn&&u.clearShuntRulesBtn.addEventListener("click",Ee)}function Me(){const e=document.getElementById("system-control-tab");if(!e)return;const t=new Set,a=new Map,n=[];let s=0;const o=()=>{for(;s<2&&n.length>0;){const e=n.shift();s++,Promise.resolve().then(e).catch(()=>{}).finally(()=>{s--,o()})}},l=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting&&!t.has(e.target)){t.add(e.target);const s=a.get(e.target);"function"==typeof s&&(e=>{n.push(e),o()})(()=>"undefined"!=typeof window&&"requestIdleCallback"in window?new Promise(e=>window.requestIdleCallback(()=>{s(),e()},{timeout:1500})):new Promise(e=>setTimeout(()=>{s(),e()},300)))}})},{root:e,rootMargin:"50px"}),i=(e,t)=>{const n=document.querySelector(e);n&&(a.set(n,t),l.observe(n))};i("#system-info-module",()=>C.load()),i("#update-module",()=>B.refreshStatus(!1)),i("#feature-switches-module",()=>k.loadStatus()),i("#domain-stats-module",()=>Te()),i("#requery-module",()=>$.updateStatus()),i("#overrides-module",()=>ke.load(!0)),i("#cache-stats-table",()=>_e.updateStats()),i("#upstream-dns-module",()=>Be.loadData())}!async function(){c.isTouchDevice="ontouchstart"in window||navigator.maxTouchPoints>0,R.init();const e=window.location.hash||"#overview",t=document.querySelector(`.tab-link[href="${e}"]`)?.dataset.tab||e.replace("#",""),a=()=>M.load().then(()=>{const e=document.querySelector(".tab-link.active")?.dataset.tab;"log-query"===e&&c.displayedLogs.length&&_.renderLogTable(c.displayedLogs,!1)});"overview"===t||"log-query"===t?a():"requestIdleCallback"in window?requestIdleCallback(a):setTimeout(a,1500),q.load(),me.loadSettings(),Z.init(),k.init(),oe(),B.init(),$e.init(),function(){if("1"===document.documentElement.dataset.infoIconDelegationMounted)return;document.documentElement.dataset.infoIconDelegationMounted="1";const e=e=>e.target.closest&&e.target.closest(".info-icon");document.addEventListener("mouseover",t=>{const a=e(t);if(!a)return;const n=a.getAttribute("title")||a.dataset.tip||a.getAttribute("aria-label")||"";se.showText(a,n)},!0),document.addEventListener("mouseout",t=>{e(t)&&se.hide()},!0),document.addEventListener("focusin",t=>{const a=e(t);if(!a)return;const n=a.getAttribute("title")||a.dataset.tip||a.getAttribute("aria-label")||"";se.showText(a,n)}),document.addEventListener("focusout",t=>{e(t)&&se.hide()})}(),Ce(),u.container?.addEventListener("mousemove",e=>{const t=e.target.closest(".card:not(dialog)");if(t){const a=t.getBoundingClientRect();t.style.setProperty("--glow-x",e.clientX-a.left+"px"),t.style.setProperty("--glow-y",e.clientY-a.top+"px")}}),function(){const e=new IntersectionObserver((e,t)=>{e.forEach(e=>{if(e.isIntersecting){const a=e.target;switch(a.id){case"top-domains-card":f.v2.getTopDomains(null,100).then(e=>{c.topDomains=e||[],z(c.topDomains)}).catch(console.error);break;case"top-clients-card":f.v2.getTopClients(null,100).then(e=>{c.topClients=e||[],U(c.topClients)}).catch(console.error);break;case"slowest-queries-card":f.v2.getSlowest(null,100).then(e=>{c.slowestQueries=e||[],j(c.slowestQueries)}).catch(console.error);break;case"shunt-results-card":f.v2.getDomainSetRank(null,100).then(e=>{c.domainSetRank=e||[],W(c.domainSetRank)}).catch(console.error)}t.unobserve(a)}})},{rootMargin:"50px"});document.querySelectorAll(".lazy-load-card").forEach(t=>e.observe(t))}(),Me(),window.innerWidth<=o&&setTimeout(()=>{Promise.allSettled([k.loadStatus(),ke.load(!0),B.refreshStatus(!1)]).catch(()=>{})},500),ge();const n=e,s=document.querySelector(`.tab-link[href="${n}"]`);s&&pe(s),await Y(!1),document.fonts?.ready&&await document.fonts.ready,requestAnimationFrame(()=>{const e=document.querySelector(".tab-link.active");e&&x(e)}),u.initialLoader.style.opacity="0",u.initialLoader.addEventListener("transitionend",()=>u.initialLoader.remove()),document.hidden||me.start(),$.init(),Be.init()}()}),document.addEventListener("DOMContentLoaded",function(){!function(){const e=document.getElementById("system-control-tab");if(!e)return;const t=e.querySelector(".control-panel-grid");if(!t||e.querySelector(".system-sub-nav"))return;const a=document.createElement("nav");a.className="system-sub-nav",a.setAttribute("role","tablist"),a.innerHTML='\n            <button class="system-sub-nav-btn active" data-category="all" role="tab">\n                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>\n                <span>全部</span>\n            </button>\n            <button class="system-sub-nav-btn" data-category="basic" role="tab">\n                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12.9 6.858l4.242 4.243L7.242 21H3v-4.243l9.9-9.9zm1.414-1.414l2.121-2.122a1 1 0 0 1 1.414 0l2.829 2.829a1 1 0 0 1 0 1.414l-2.122 2.121-4.242-4.242z"/></svg>\n                <span>基础设置</span>\n            </button>\n            <button class="system-sub-nav-btn" data-category="data" role="tab">\n                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4 19h16v-7h2v8a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-8h2v7zM20 3H4v7h2V5h12v5h2V4a1 1 0 0 0-1-1z"/></svg>\n                <span>数据管理</span>\n            </button>\n            <button class="system-sub-nav-btn" data-category="system" role="tab">\n                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1l9.5 5.5v11L12 23l-9.5-5.5v-11L12 1zm0 2.31L4.5 7.65v8.7l7.5 4.34 7.5-4.34V7.65L12 3.31z"/></svg>\n                <span>系统信息</span>\n            </button>\n            <button class="system-sub-nav-btn" data-category="advanced" role="tab">\n                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"/></svg>\n                <span>高级设置</span>\n            </button>\n        ',e.insertBefore(a,t);const n=t.querySelectorAll(".control-module");Array.from(n).forEach(function(e,t){if(e.dataset.category)return;const a=e.id;"auto-refresh-module"===a||"appearance-module"===a?e.dataset.category="basic":"domain-stats-module"===a||"requery-module"===a?e.dataset.category="data":"system-info-module"===a||"update-module"===a?e.dataset.category="system":"feature-switches-module"===a||"overrides-module"===a?e.dataset.category="advanced":e.querySelector("#cache-stats-table")?e.dataset.category="data":t<4&&e.classList.contains("control-module--mini")?e.dataset.category="basic":e.dataset.category="advanced"}),a.addEventListener("click",function(e){var n=e.target.closest(".system-sub-nav-btn");if(n){var s=n.dataset.category;a.querySelectorAll(".system-sub-nav-btn").forEach(function(e){e.classList.remove("active")}),n.classList.add("active"),t.querySelectorAll(".control-module").forEach(function(e,t){if(e.dataset.category)return;const a=e.id;"auto-refresh-module"===a||"appearance-module"===a?e.dataset.category="basic":"domain-stats-module"===a||"requery-module"===a?e.dataset.category="data":"system-info-module"===a||"update-module"===a?e.dataset.category="system":"feature-switches-module"===a||"overrides-module"===a||"replacements-card"===a||"socks-ecs-module"===a?e.dataset.category="advanced":e.querySelector("#cache-stats-table")?e.dataset.category="data":e.classList.contains("control-module--mini")?e.dataset.category="basic":e.dataset.category="advanced"}),t.querySelectorAll(".control-module").forEach(function(e){var t=e.dataset.category;e.style.display="all"===s||t===s?"":"none"});var o=document.getElementById("config-manager-card");o&&(o.style.display="all"===s||"system"===s?"":"none")}});var s=a.querySelector('.system-sub-nav-btn[data-category="basic"]');s&&s.click();new MutationObserver(function(e){e.forEach(function(e){e.addedNodes.forEach(function(e){if(1===e.nodeType&&e.classList&&e.classList.contains("control-module")){e.dataset.category||(e.dataset.category="advanced");var t=a.querySelector(".system-sub-nav-btn.active");if(t){var n=t.dataset.category;"all"!==n&&e.dataset.category!==n&&(e.style.display="none")}}})})}).observe(t,{childList:!0,subtree:!1}),console.log("System sub-navigation initialized");const o=document.getElementById("diversion-help-btn");o&&o.addEventListener("click",function(){document.body.insertAdjacentHTML("beforeend",'\n                    <dialog id="help-modal" class="card" style="padding: 0; max-width: 500px; width: 90%; border: none; box-shadow: var(--shadow-lg); border-radius: var(--border-radius-lg);">\n                        <header class="card-header" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid var(--color-border);">\n                            <h3 style="margin: 0;">分流规则说明</h3>\n                            <button class="button icon-only" onclick="this.closest(\'dialog\').close(); this.closest(\'dialog\').remove();" style="background: transparent; border: none; cursor: pointer;">\n                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>\n                            </button>\n                        </header>\n                        <div class="card-body" style="padding: 1.5rem;">\n                            <div style="line-height: 1.6; font-size: 0.95rem;">\n                                <p style="margin-bottom: 0.5rem;"><strong>geositecn:</strong> 中国大陆域名列表，用于直连。</p>\n                                <p style="margin-bottom: 0.5rem;"><strong>geositenocn:</strong> 非中国大陆域名列表，用于代理。</p>\n                                <p style="margin-bottom: 0.5rem;"><strong>geoipcn:</strong> 中国大陆 IP 列表。</p>\n                                <p style="margin-bottom: 0.5rem;"><strong>cuscn:</strong> 自定义中国大陆域名。</p>\n                                <p style="margin-bottom: 0.5rem;"><strong>cusnocn:</strong> 自定义非中国大陆域名。</p>\n                                <p style="margin-bottom: 0.5rem;"><strong>nftadd:</strong> 自动添加ip集至nft。</p>\n                            </div>\n                        </div>\n                        <footer class="modal-footer" style="padding: 1rem 1.5rem; border-top: 1px solid var(--color-border); text-align: right;">\n                            <button class="button primary" onclick="this.closest(\'dialog\').close(); this.closest(\'dialog\').remove();">关闭</button>\n                        </footer>\n                    </dialog>\n                ');const e=document.getElementById("help-modal");e.showModal(),e.addEventListener("click",t=>{t.target===e&&(e.close(),e.remove())})})}()});

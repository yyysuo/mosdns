<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark" data-color-scheme="indigo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mosdns 仪表盘 V2.0</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- UI CSS (v16.1 - 最终修复) --- */
        :root { 
            --font-family-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            --font-family-mono: "SF Mono", "Fira Code", "Consolas", monospace; 
            --border-radius-lg: 16px; 
            --border-radius-md: 12px; 
            --border-radius-sm: 8px; 
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.04); 
            --shadow-md: 0 4px 10px rgba(0,0,0,0.08); 
            --shadow-lg: 0 10px 30px rgba(0,0,0,0.1); 
            --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            --transition-med: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        }

        /* 主题色系统 */
        [data-color-scheme="indigo"] { --color-accent-primary: #4f46e5; --color-accent-primary-hover: #4338ca; --glow-color: rgba(79, 70, 229, 0.2); }
        [data-color-scheme="pink"] { --color-accent-primary: #ec4899; --color-accent-primary-hover: #db2777; --glow-color: rgba(236, 72, 153, 0.2); }
        [data-color-scheme="teal"] { --color-accent-primary: #14b8a6; --color-accent-primary-hover: #0d9488; --glow-color: rgba(20, 184, 166, 0.15); }
        [data-color-scheme="orange"] { --color-accent-primary: #f97316; --color-accent-primary-hover: #ea580c; --glow-color: rgba(249, 115, 22, 0.2); }
        [data-theme="dark"][data-color-scheme="indigo"] { --color-accent-primary: #58a6ff; --color-accent-primary-hover: #80b6f8; --glow-color: rgba(88, 166, 255, 0.15); }
        [data-theme="dark"][data-color-scheme="pink"] { --color-accent-primary: #f778ba; --color-accent-primary-hover: #f599ce; --glow-color: rgba(247, 120, 186, 0.15); }
        [data-theme="dark"][data-color-scheme="teal"] { --color-accent-primary: #2dd4bf; --color-accent-primary-hover: #5eead4; --glow-color: rgba(45, 212, 191, 0.15); }
        [data-theme="dark"][data-color-scheme="orange"] { --color-accent-primary: #fb923c; --color-accent-primary-hover: #fdba74; --glow-color: rgba(251, 146, 60, 0.15); }

        /* 基础明暗主题变量 */
        [data-theme="light"] { --color-bg: #f5f8ff; --color-bg-card: #ffffff; --color-bg-alt: #f0f3f8; --color-text-primary: #0f172a; --color-text-secondary: #64748b; --color-border: #e2e8f0; --color-accent-secondary: #ec4899; --color-accent-text: #ffffff; --color-danger: #ef4444; --color-danger-hover: #dc2626; --color-success: #22c55e; --color-warning: #f59e0b; }
        [data-theme="dark"] { --color-bg: #0d1117; --color-bg-card: #161b22; --color-bg-alt: #21262d; --color-text-primary: #c9d1d9; --color-text-secondary: #8b949e; --color-border: #30363d; --color-accent-secondary: #f778ba; --color-accent-text: #ffffff; --color-danger: #f87171; --color-danger-hover: #ff9191; --color-success: #56d364; --color-warning: #facc15; }
        
        /* --- 基础样式 --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: color-mix(in srgb, var(--color-accent-primary) 40%, transparent); border-radius: 8px; border: 2px solid transparent; background-clip: content-box;}
        ::-webkit-scrollbar-thumb:hover { background-color: color-mix(in srgb, var(--color-accent-primary) 60%, transparent); }
        *, *::before, *::after { box-sizing: border-box; }
        html { font-size: 16px; scroll-behavior: smooth; }
        body { font-family: var(--font-family-sans); background-color: var(--color-bg); color: var(--color-text-primary); margin: 0; position: relative; overflow-x: hidden; transition: background-color var(--transition-slow), color var(--transition-slow); }
        body::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 400px; background: radial-gradient(ellipse at top, var(--glow-color), transparent 70%); z-index: 0; pointer-events: none; transition: var(--transition-slow); }
        .container { max-width: 1300px; margin: 0 auto; padding: 2rem; position: relative; z-index: 1;}
        h1, h2, h3, p { margin: 0; }
        h1 { font-size: 2.25rem; font-weight: 800; }
        h2 { font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.6rem; }
        h3 { font-size: 0.9rem; font-weight: 600; color: var(--color-text-secondary); text-transform: uppercase; letter-spacing: 0.8px;}
        a { color: var(--color-accent-primary); text-decoration: none; font-weight: 600; transition: var(--transition-fast); }
        a:hover { color: var(--color-accent-primary-hover); }
        [title] { 
            cursor: help; 
            text-decoration: underline;
            text-decoration-style: dotted;
            text-decoration-color: var(--color-text-secondary);
            text-underline-offset: 3px;
        }

        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem; flex-wrap: wrap; gap: 1.5rem; }
        .header-main-actions { display: flex; align-items: center; gap: 0.75rem; margin-left: auto; max-width: 100%; }
        .last-updated { font-size: 0.8rem; color: var(--color-text-secondary); white-space: nowrap; }
        .nav-wrapper { position: relative; overflow-x: auto; overflow-y: hidden; }
        
        .main-nav { display: inline-flex; background-color: var(--color-bg-alt); border: 1px solid var(--color-border); border-radius: var(--border-radius-md); padding: 0.25rem; }
        .main-nav-slider { position: absolute; top: 0.25rem; bottom: 0.25rem; border-radius: var(--border-radius-sm); background: var(--color-accent-primary); box-shadow: var(--shadow-md); transition: all var(--transition-med); z-index: 0; }
        .main-nav a { display: flex; align-items: center; justify-content: center; gap: 0.6rem; padding: 0.6rem 1.1rem; color: var(--color-text-secondary); font-weight: 600; font-size: 0.95rem; position: relative; z-index: 1; transition: color var(--transition-med); white-space: nowrap; }
        .main-nav a.active { color: var(--color-accent-text) !important; }
        .main-nav a .status-indicator { width: 8px; height: 8px; border-radius: 50%; background-color: currentColor; opacity: 0.6; transition: all var(--transition-med); }
        .main-nav a.active .status-indicator { opacity: 1; }
        .main-nav a .status-indicator.running { background-color: var(--color-success); opacity: 1; animation: pulse-small 2s infinite; }
        .main-nav a .status-indicator.stopped { background-color: var(--color-danger); opacity: 1; }
        @keyframes pulse-small { 0%, 100% { box-shadow: 0 0 0 0 color-mix(in srgb, var(--color-success) 40%, transparent); } 70% { box-shadow: 0 0 0 5px transparent; } }
        
        .refresh-btn { display: flex; align-items: center; justify-content: center; width: 48px; height: 48px; border-radius: var(--border-radius-md); background-color: var(--color-bg-alt); color: var(--color-text-secondary); border: 1px solid var(--color-border); cursor: pointer; transition: all var(--transition-fast); flex-shrink: 0; }
        .refresh-btn:hover:not(:disabled):not([aria-busy="true"]) { color: var(--color-accent-primary); border-color: var(--color-accent-primary); transform: translateY(-2px); box-shadow: var(--shadow-sm); }
        .refresh-btn:hover:not(:disabled):not([aria-busy="true"]) svg { transform: rotate(45deg); }
        .refresh-btn[aria-busy="true"] { cursor: wait; pointer-events: none; }
        .refresh-btn[aria-busy="true"] svg { animation: spin 1s linear infinite; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .stat-card { padding: 2rem; border-radius: var(--border-radius-lg); position: relative; overflow: hidden; color: var(--color-accent-text); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); transition: transform var(--transition-med), box-shadow var(--transition-med); }
        .stat-card.default-gradient-1 { background: linear-gradient(135deg, #3b82f6, #8b5cf6); }
        .stat-card.default-gradient-2 { background: linear-gradient(135deg, #ec4899, #f59e0b); }
        .stat-card.theme-gradient { background: linear-gradient(135deg, var(--color-accent-primary) 0%, var(--color-accent-secondary) 100%); }
        .stat-card:hover { transform: translateY(-6px) scale(1.02); box-shadow: 0 15px 30px -10px rgba(0,0,0,0.2); }
        .stat-card h3 { color: var(--color-accent-text); opacity: 0.8; text-transform: none; font-size: 1.1rem; font-weight: 500; display: flex; align-items: center; gap: 0.75rem;}
        .stat-card .value { font-size: 3.5rem; font-weight: 800; line-height: 1; margin-top: 1rem; }
        .stat-card .icon-bg { position: absolute; right: -20px; bottom: -20px; font-size: 120px; opacity: 0.1; transform: rotate(-15deg); transition: transform var(--transition-slow); }
        .stat-card:hover .icon-bg { transform: rotate(-10deg) scale(1.1); }
        .sparkline-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 60px; opacity: 0.5; mask-image: linear-gradient(to top, rgba(0,0,0,1) 50%, transparent 100%); -webkit-mask-image: linear-gradient(to top, rgba(0,0,0,1) 50%, transparent 100%); }
        .sparkline-container svg { width: 100%; height: 100%; }
        .sparkline-path { stroke: var(--color-accent-text, #fff); stroke-width: 2.5; fill: url(#sparkline-gradient); fill-opacity: 0.2; stroke-linecap: round; stroke-linejoin: round; }
        .sparkline-labels { position: absolute; bottom: 10px; left: 1.5rem; right: 1.5rem; display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 600; color: var(--color-accent-text); opacity: 0; transition: var(--transition-fast); pointer-events: none; }
        .stat-card:hover .sparkline-labels { opacity: 0.7; }
        
        .card { background-color: var(--color-bg-card); border: 1px solid var(--color-border); border-radius: var(--border-radius-lg); box-shadow: var(--shadow-sm); transition: var(--transition-fast); position: relative; }
        .card::before { content: ""; position: absolute; top: var(--glow-y, 50%); left: var(--glow-x, 50%); transform: translate(-50%, -50%); width: 250px; height: 250px; background: radial-gradient(circle, var(--glow-color), transparent 70%); opacity: 0; transition: opacity 0.4s ease-out; pointer-events: none; z-index: 0; }
        .card:hover::before { opacity: 1; }
        .card > * { position: relative; z-index: 1; }
        .card-header { padding: 1.25rem 1.75rem; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
        .card-body { padding: 1.75rem; }
        
        .card-header .header-actions { display: flex; gap: 0.75rem; align-items: center; }

        .control-item { display: flex; align-items: center; gap: 1rem; font-size: 1rem; flex-wrap: wrap; }
        .control-item strong { color: var(--color-text-primary); font-weight: 500; flex-shrink: 0;}
        .control-item > div, .control-item > form, .control-item > button { margin-left: auto; }
        .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.5rem; }
        #capacity-form { display: grid; grid-template-columns: 1fr auto; gap: 1rem; }
        
        .auto-refresh-form { display: flex; align-items: center; gap: 1rem; }
        .auto-refresh-form input[type="number"] { width: 80px; text-align: center; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--color-border); transition: var(--transition-fast); border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: var(--transition-fast); border-radius: 50%; }
        input:checked + .slider { background-color: var(--color-accent-primary); }
        input:checked + .slider:before { transform: translateX(22px); }
        
        .color-palette { display: flex; gap: 0.5rem; }
        .color-swatch { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: var(--transition-fast); }
        .color-swatch:hover { transform: scale(1.15); }
        .color-swatch.active { border-color: var(--color-accent-primary); }

        .theme-switcher-container { background-color: var(--color-bg-alt); border-radius: 99px; padding: 4px; display: inline-flex; position: relative; border: 1px solid var(--color-border); }
        .theme-switcher-button { border: none; background: none; cursor: pointer; padding: 6px; border-radius: 50%; color: var(--color-text-secondary); display: flex; align-items: center; justify-content: center; z-index: 1; transition: color var(--transition-med); }
        .theme-switcher-button.active { color: var(--color-accent-primary); }
        .theme-switcher-button svg { width: 20px; height: 20px; }
        .theme-switcher-slider { position: absolute; top: 4px; width: 32px; height: 32px; background-color: var(--color-bg-card); border-radius: 50%; box-shadow: var(--shadow-sm); transition: transform var(--transition-med); z-index: 0; }
        [data-theme="dark"] .theme-switcher-slider { transform: translateX(36px); }

        .button { display: inline-flex; align-items: center; justify-content: center; gap: 0.6rem; padding: 0.75rem 1.5rem; font-size: 0.95rem; font-weight: 600; border-radius: var(--border-radius-sm); border: 1px solid transparent; cursor: pointer; white-space: nowrap; box-shadow: 0 1px 2px rgba(0,0,0,0.05), inset 0 1px 0 rgba(255,255,255,0.05); transition: all var(--transition-fast); }
        .button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .button:active:not(:disabled) { transform: translateY(0); box-shadow: var(--shadow-sm); }
        .button.primary { background-color: var(--color-accent-primary); color: var(--color-accent-text); }
        .button.primary:hover:not(:disabled) { background-color: var(--color-accent-primary-hover); }
        .button.secondary { background-color: var(--color-bg-card); color: var(--color-text-primary); border-color: var(--color-border); }
        .button.secondary:hover:not(:disabled) { border-color: var(--color-accent-primary); color: var(--color-accent-primary); }
        .button.danger { background-color: var(--color-danger); color: #fff; }
        .button.danger:hover:not(:disabled) { background-color: var(--color-danger-hover); }
        .button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .button svg { width: 1.2em; height: 1.2em; }
        
        input[type="search"], input[type="text"], input[type="number"] { width: 100%; padding: 0.8rem 1.2rem; font-size: 1rem; background-color: var(--color-bg-alt); border: 1px solid var(--color-border); border-radius: var(--border-radius-sm); color: var(--color-text-primary); transition: var(--transition-fast); }
        input:focus { outline: none; border-color: var(--color-accent-primary); box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-accent-primary) 25%, transparent); }
        
        #search-results-info { 
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            height: 1.2em; /* Reserve space to prevent layout shift */
            transition: opacity 0.3s;
        }

        .rankings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2.5rem; }
        .scrollable-table-container { 
            max-height: 400px; 
            overflow-y: auto; 
            position: relative;
        }
        #log-query-table-container { max-height: calc(100vh - 380px); min-height: 200px; }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.95rem; }
        th, td { padding: 0.8rem 1.25rem; text-align: left; border-bottom: 1px solid var(--color-border); transition: background-color var(--transition-fast); word-break: break-word; vertical-align: middle;}
        .text-right { text-align: right !important; }

        #top-domains-table th:last-child,
        #top-domains-table td:last-child,
        #top-clients-table th:last-child,
        #top-clients-table td:last-child {
            width: 6rem;
            white-space: nowrap;
        }

        thead th { 
            background-color: var(--color-bg-alt); 
            font-weight: 600; 
            font-size: 0.8rem; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            color: var(--color-text-secondary);
        }
        .scrollable-table-container thead th {
            position: sticky; 
            top: 0; 
            z-index: 2;
        }
        .scrollable-table-container thead {
            transition: padding-right 0.2s ease-in-out;
        }
        
        .domain-response-cell { display: flex; flex-direction: column; gap: 0.15rem; }
        .domain-response-cell .domain-name { font-weight: 500; }
        .domain-response-cell .response-summary { font-size: 0.9em; color: var(--color-text-secondary); }

        th[data-sortable] { cursor: pointer; }
        th[data-sortable]:hover { color: var(--color-text-primary); }
        .sort-indicator { display: inline-block; width: 1em; text-align: center; opacity: 0.5; }
        th.sorted .sort-indicator { opacity: 1; }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr:nth-child(even) { background-color: var(--color-bg-alt); }
        tbody tr {
            transition: transform var(--transition-fast), box-shadow var(--transition-fast), background-color var(--transition-fast);
        }
        tbody tr:hover { 
            background-color: color-mix(in srgb, var(--color-accent-primary) 8%, transparent);
            transform: scale(1.01); 
            box-shadow: var(--shadow-sm);
            z-index: 1;
            position: relative;
        }
        
        tbody tr.data-log-entry {
            opacity: 0;
            transform: translateY(10px);
            animation: data-log-entry-animation 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        @keyframes data-log-entry-animation { to { opacity: 1; transform: translateY(0); } }

        .truncate-text { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        tbody td a.clickable-link { position: relative; text-decoration: none; }
        tbody td a.clickable-link::after { content: ''; position: absolute; width: 0; height: 1px; bottom: -3px; left: 50%; transform: translateX(-50%); background-color: var(--color-accent-primary); transition: width var(--transition-fast); }
        tbody td a.clickable-link:hover::after { width: 100%; }

        tbody tr[data-log-index], tbody tr[data-rank-index] { cursor: help; }
        .touch tbody tr[data-log-index], .touch tbody tr[data-rank-index] { cursor: pointer; }

        .empty-state-row td { text-align: center !important; padding: 3rem 1.5rem !important; white-space: normal !important; }
        .empty-state-content { display: flex; flex-direction: column; align-items: center; gap: 1rem; color: var(--color-text-secondary); }
        .empty-state-content svg { width: 48px; height: 48px; opacity: 0.5; }
        .empty-state-content strong { color: var(--color-text-primary); font-size: 1.1rem; }
        .empty-state-content .button { margin-top: 0.5rem; } 

        .tab-content { display: none; margin-top: 2.5rem; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .client-alias { font-weight: 600; }
        
        .response-tag { padding: 0.2rem 0.6rem; font-size: 0.8rem; font-weight: 700; border-radius: var(--border-radius-sm); white-space: nowrap; display: inline-block; }
        .response-tag.noerror { background-color: color-mix(in srgb, var(--color-success) 20%, transparent); color: var(--color-success); }
        .response-tag.nxdomain { background-color: color-mix(in srgb, var(--color-warning) 20%, transparent); color: var(--color-warning); }
        .response-tag.servfail { background-color: color-mix(in srgb, var(--color-danger) 20%, transparent); color: var(--color-danger); }
        .response-tag.refused { background-color: color-mix(in srgb, var(--color-danger) 25%, transparent); color: var(--color-danger); }
        .response-tag.other { background-color: var(--color-border); color: var(--color-text-secondary); }

        .answers-tooltip { visibility: hidden; opacity: 0; position: fixed; padding: 0.75rem 1rem; border-radius: var(--border-radius-md); background: var(--color-bg-alt); border: 1px solid var(--color-border); box-shadow: var(--shadow-lg); width: max-content; max-width: calc(100vw - 20px); z-index: 9999; transition: opacity 0.2s, visibility 0.2s, transform 0.2s; text-align: left; pointer-events: none; font-size: 0.9rem; transform: translateY(10px); } 
        .answers-tooltip.visible { visibility: visible; opacity: 1; transform: translateY(0); }
        .answers-tooltip h5 { margin: 0 0 0.75rem 0; font-size: 0.8rem; color: var(--color-text-secondary); text-transform: uppercase; letter-spacing: 0.8px; border-bottom: 1px solid var(--color-border); padding-bottom: 0.5rem; } 
        .answers-tooltip ul { margin: 0; padding: 0; list-style-type: none; display: flex; flex-direction: column; gap: 0.4rem; } 
        .answers-tooltip li { font-family: var(--font-family-mono); white-space: normal; word-break: break-all; display: flex; align-items: center; justify-content: space-between; gap: 1rem;} 
        .answers-tooltip li > strong { font-family: var(--font-family-sans); flex-shrink: 0; }
        .answers-tooltip small { font-size: 0.85em; opacity: 0.8; } 
        .copy-btn { background: none; border: none; cursor: pointer; color: var(--color-text-secondary); padding: 2px; border-radius: 4px; display: inline-flex; vertical-align: middle; transition: var(--transition-fast); }
        .copy-btn:hover { color: var(--color-accent-primary); background-color: var(--color-border); }

        #toast { position: fixed; top: 20px; right: 20px; display: flex; align-items: center; gap: 0.75rem; padding: 1rem 1.5rem; border-radius: var(--border-radius-sm); z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); transform: translateY(-20px) scale(0.95); box-shadow: var(--shadow-lg); color: var(--color-accent-text); font-weight: 500; } 
        #toast.show { opacity: 1; visibility: visible; transform: translateY(0) scale(1); } 
        #toast.success { background-color: var(--color-success); } 
        #toast.error { background-color: var(--color-danger); }
        #toast svg { width: 1.25em; height: 1.25em; }

        dialog { border: none; border-radius: var(--border-radius-lg); box-shadow: var(--shadow-lg); padding: 0; max-width: 600px; width: 90%; background-color: var(--color-bg-card); color: var(--color-text-primary); } 
        dialog::backdrop { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(8px); } 
        .modal-header { padding: 1.25rem 1.75rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--color-border); } 
        .modal-body { padding: 1.75rem; max-height: 60vh; overflow-y: auto; scrollbar-gutter: stable; } 
        .modal-footer { padding: 1.25rem 1.75rem; border-top: 1px solid var(--color-border); display: flex; justify-content: space-between; gap: 0.75rem; background-color: var(--color-bg-alt); } 
        .modal-footer .footer-actions-right { display: flex; gap: 0.75rem; }
        
        .alias-item { display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; align-items: center; padding: 0.75rem; border-radius: var(--border-radius-sm); } 
        .alias-item:nth-child(even) { background-color: var(--color-bg-alt); }
        .alias-item input.changed { border-color: var(--color-warning); box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-warning) 25%, transparent); }
        #manual-alias-form { padding: 1.25rem; background: var(--color-bg-alt); border-radius: var(--border-radius-md); margin-bottom: 1.5rem; display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: center; border: 1px solid var(--color-border); }
        
        #initial-loader { position: fixed; inset: 0; background: var(--color-bg); display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s; }
        #log-loader { text-align: center; padding: 2rem; display: none; }
        .spinner { display: inline-block; width: 2.5rem; height: 2.5rem; border: 4px solid var(--color-border); border-top-color: var(--color-accent-primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .control-panel-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .control-module { background-color: var(--color-bg-card); border: 1px solid var(--color-border); border-radius: var(--border-radius-md); padding: 1.5rem; display: flex; flex-direction: column; gap: 1.25rem; }
        .control-module h3 { font-size: 1rem; font-weight: 600; color: var(--color-text-primary); text-transform: none; letter-spacing: 0; padding-bottom: 0.75rem; border-bottom: 1px solid var(--color-border); margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.6rem; }
        .control-module h3 svg { width: 1.1em; height: 1.1em; color: var(--color-accent-primary); opacity: 0.8; }

        .fab { display: none; }

        /* --- 全面优化的响应式布局 --- */
        @media (max-width: 992px) {
            .page-header { justify-content: center; }
            h1 { flex-basis: 100%; text-align: center; margin-bottom: 0.5rem; }
            .header-main-actions { order: 1; flex-grow: 1; justify-content: center; }
        }
        
        @media (max-width: 768px) {
            html { font-size: 15px; } 
            .container { padding: 1.5rem 1rem 4rem; }
            h1 { font-size: 1.8rem; }
            .card-header { padding: 1rem 1.25rem; }
            .card-body { padding: 1.25rem; }
            .rankings-grid { grid-template-columns: 1fr; gap: 2rem; }
            
            .hide-on-mobile { display: none !important; }

            .fab { display: flex; align-items: center; justify-content: center; position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; background-color: var(--color-accent-primary); color: var(--color-accent-text); border-radius: 50%; border: none; box-shadow: var(--shadow-lg); z-index: 100; transition: all var(--transition-med); }
            .fab:hover { background-color: var(--color-accent-primary-hover); transform: scale(1.05); }
            .fab[aria-busy="true"] svg { animation: spin 1s linear infinite; }
            
            .header-main-actions .refresh-btn, .header-main-actions .last-updated { display: none; }
            
            .mobile-card-layout thead { display: none; }
            .mobile-card-layout, .mobile-card-layout tbody { display: block; }
            .mobile-card-layout tr {
                display: block;
                background-color: var(--color-bg-card);
                padding: 1rem;
                border-radius: var(--border-radius-md);
                margin-bottom: 0.75rem;
                border: 1px solid var(--color-border);
                box-shadow: var(--shadow-sm);
            }
            .mobile-card-layout td { display: block; border: none; padding: 0; }
            .mobile-card-layout tr:nth-child(even) { background-color: var(--color-bg-card); }
            .mobile-card-layout tr:hover { transform: none; box-shadow: var(--shadow-md); }
            
            .mobile-log-row { display: grid; grid-template-columns: 1fr auto; grid-template-areas: "domain time" "meta meta"; gap: 0.25rem 1rem; font-size: 0.9rem; }
            .mobile-log-row .domain { grid-area: domain; font-weight: 600; color: var(--color-text-primary); word-break: break-all; align-self: center;}
            .mobile-log-row .time { grid-area: time; text-align: right; color: var(--color-text-secondary); font-size: 0.8rem; align-self: center; }
            .mobile-log-row .meta { grid-area: meta; display: flex; align-items: center; flex-wrap: wrap; gap: 0.5rem 1rem; color: var(--color-text-secondary); font-size: 0.85rem; padding-top: 0.5rem; margin-top: 0.5rem; border-top: 1px solid var(--color-border);}
            .mobile-log-row .meta .client { max-width: 15ch; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
            .mobile-log-row .meta .duration { font-weight: 500; }

            .mobile-compact-table th:not(:first-child),
            .mobile-compact-table td:not(:first-child) {
                display: none;
            }
            .mobile-compact-table th:first-child,
            .mobile-compact-table td:first-child {
                width: 100%;
            }

            #slowest-queries-card .scrollable-table-container,
            #log-query-table-container {
                padding: 0.75rem;
                background-color: var(--color-bg-alt);
                border-radius: var(--border-radius-md);
            }
            #top-domains-card .scrollable-table-container,
            #top-clients-card .scrollable-table-container {
                padding-top: 1.25rem; 
            }
            #top-domains-card thead th,
            #top-clients-card thead th {
                top: -1.25rem;
            }
            #slowest-queries-card .scrollable-table-container {
                padding-left: 0; padding-right: 0;
            }
            
            .control-panel-grid { grid-template-columns: 1fr; gap: 1.5rem; }
            .control-module { padding: 1.25rem; }
            .control-item { flex-direction: column; align-items: flex-start; gap: 0.75rem; }
            .control-item > div, .control-item > form, .control-item > button { margin-left: 0; width: 100%; }
            .button-group { grid-template-columns: 1fr; gap: 0.75rem; }
            #capacity-form { grid-template-columns: 1fr; gap: 0.75rem; }
            .auto-refresh-form { flex-direction: row; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; }
            .color-palette { justify-content: flex-start; }
            #manual-alias-form { grid-template-columns: 1fr; }
            .alias-item { grid-template-columns: 1fr; }
        }
        @media (max-width: 480px) {
            .alias-item { text-align: center; }
            .alias-item input { text-align: center; }
        }
    </style>
</head>
<body>
    <div id="initial-loader"><div class="spinner"></div></div>

    <main class="container">
        <header class="page-header">
            <h1>Mosdns 仪表盘</h1>
            <div class="header-main-actions">
                <div class="nav-wrapper">
                    <nav class="main-nav">
                        <div class="main-nav-slider"></div>
                        <a href="#overview" class="tab-link active" data-tab="overview" role="tab">概览</a>
                        <a href="#log-query" class="tab-link" data-tab="log-query" role="tab">查询日志</a>
                        <a href="#system-control" class="tab-link" data-tab="system-control" role="tab">
                            <span class="status-indicator"></span>
                            <span>系统</span>
                        </a>
                    </nav>
                </div>
                <span id="last-updated" class="last-updated"></span>
                <button id="global-refresh-btn" class="refresh-btn" title="刷新数据" aria-label="刷新数据" aria-busy="false">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
                </button>
            </div>
        </header>

        <div id="toast" role="status" aria-live="polite"></div>

        <dialog id="alias-modal">
            <header class="modal-header">
                <h2>管理客户端别名</h2>
                <button class="button secondary" id="close-alias-modal" aria-label="Close" style="min-width:auto; padding:0.3rem 0.5rem;">✕</button>
            </header>
            <div class="modal-body">
                <form id="manual-alias-form">
                    <input type="text" id="manual-alias-ip" placeholder="输入 IP 地址" required>
                    <input type="text" id="manual-alias-name" placeholder="输入别名" required>
                    <button type="submit" class="button primary"><span>添加</span></button>
                </form>
                <p>为客户端 IP 设置别名，方便在日志中快速识别。下面是最近活跃的客户端：</p>
                <div id="alias-list-container"></div>
            </div>
            <footer class="modal-footer">
                <div class="footer-actions-left">
                     <button id="import-aliases-btn" class="button secondary"><span>导入配置</span></button>
                     <button id="export-aliases-btn" class="button secondary"><span>导出配置</span></button>
                </div>
                <div class="footer-actions-right">
                     <button id="save-all-aliases-btn" class="button primary"><span>全部保存</span></button>
                </div>
            </footer>
        </dialog>
        <input type="file" id="import-alias-file-input" accept=".json" style="display: none;">
        
        <section id="overview-tab" class="tab-content active" role="tabpanel">
            <div class="stats-grid">
                <div class="stat-card" id="stat-card-1">
                    <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M11.25 4.53335C11.6642 4.44457 12.0858 4.44457 12.5 4.53335C17.1524 5.54133 21 9.80443 21 14.6465C21 19.9806 16.9706 22 12 22C7.02944 22 3 19.9806 3 14.6465C3 9.80443 6.84759 5.54133 11.25 4.53335ZM12 2C6.47715 2 2 7.02165 2 14.6465C2 21.4939 6.27609 24 12 24C17.7239 24 22 21.4939 22 14.6465C22 7.02165 17.5228 2 12 2Z"></path></svg><span>总查询数</span></h3>
                    <div id="total-queries" class="value">--</div>
                    <div class="sparkline-labels"><span id="sparkline-total-min"></span><span id="sparkline-total-max"></span></div>
                    <div class="icon-bg"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18 2H6C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V4C20 2.89543 19.1046 2 18 2ZM11 14H8V12H11V14ZM16 10H8V8H16V10Z"></path></svg></div>
                    <div class="sparkline-container" id="sparkline-total"></div>
                </div>
                <div class="stat-card" id="stat-card-2">
                    <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2ZM11 6V11H16V13H11V18H9V11H4V9H9V6H11Z"></path></svg><span>平均处理时间 (ms)</span></h3>
                    <div id="avg-duration" class="value">--</div>
                    <div class="sparkline-labels"><span id="sparkline-avg-min"></span><span id="sparkline-avg-max"></span></div>
                    <div class="icon-bg"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2ZM12 11.0711L14.1213 13.1924L15.5355 11.7782L12.7071 9L12 9.70711V11.0711ZM13 13H11V17H13V13Z"></path></svg></div>
                    <div class="sparkline-container" id="sparkline-avg"></div>
                </div>
            </div>
            
            <div class="rankings-grid" style="margin-top: 2.5rem;">
                <div class="card" id="top-domains-card">
                    <header class="card-header"><h2>域名请求排行</h2></header>
                    <div class="card-body">
                        <div class="scrollable-table-container">
                            <table id="top-domains-table" class="mobile-compact-table">
                                <thead><tr><th>域名</th><th class="text-right hide-on-mobile">请求数</th></tr></thead>
                                <tbody id="top-domains-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="card" id="top-clients-card">
                    <header class="card-header"><h2>客户端请求排行</h2></header>
                    <div class="card-body">
                        <div class="scrollable-table-container">
                            <table id="top-clients-table" class="mobile-compact-table">
                                <thead><tr><th>客户端</th><th class="text-right hide-on-mobile">请求数</th></tr></thead>
                                <tbody id="top-clients-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
                
            <div class="card" id="slowest-queries-card" style="margin-top: 2.5rem;">
                <header class="card-header"><h2>最慢查询</h2></header>
                <div class="card-body">
                     <div class="scrollable-table-container">
                        <table id="slowest-queries-table" class="mobile-card-layout">
                            <thead><tr><th class="hide-on-mobile">时间</th><th>域名 / 响应</th><th class="hide-on-mobile text-right">耗时 (ms)</th><th class="hide-on-mobile">客户端</th></tr></thead>
                            <tbody id="slowest-queries-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="log-query-tab" class="tab-content">
            <div class="card">
                <header class="card-header">
                    <h2>查询与过滤日志</h2>
                    <div class="header-actions">
                        <button id="manage-aliases-btn" class="button secondary"><span>管理别名</span></button>
                    </div>
                </header>
                <div class="card-body">
                    <input type="search" id="log-search" placeholder="全局搜索... (使用 &quot;引号&quot; 进行精确匹配)" style="margin-bottom: 0.5rem;">
                    <div id="search-results-info"></div>
                    <div class="scrollable-table-container" id="log-query-table-container">
                        <table id="log-table" class="mobile-card-layout">
                            <thead id="log-table-head">
                                <tr>
                                    <th class="hide-on-mobile" data-sortable data-sort-key="query_time">时间 <span class="sort-indicator"></span></th>
                                    <th data-sortable data-sort-key="query_name">域名 / 响应 <span class="sort-indicator"></span></th>
                                    <th class="hide-on-mobile" data-sortable data-sort-key="query_type">类型 <span class="sort-indicator"></span></th>
                                    <th class="hide-on-mobile text-right" data-sortable data-sort-key="duration_ms">耗时(ms) <span class="sort-indicator"></span></th>
                                    <th class="hide-on-mobile" data-sortable data-sort-key="client_ip">客户端 <span class="sort-indicator"></span></th>
                                </tr>
                            </thead>
                            <tbody id="log-table-body"></tbody>
                        </table>
                        <div id="log-loader"><div class="spinner" style="width:1.5rem; height:1.5rem; border-width:3px;"></div></div>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="system-control-tab" class="tab-content">
             <div class="control-panel-grid">
                <div class="control-module">
                    <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22ZM11 11H7V13H11V17H13V13H17V11H13V7H11V11Z"></path></svg>审计状态</h3>
                    <div class="control-item">
                        <strong>运行状态:</strong> <span id="audit-status">查询中...</span>
                    </div>
                    <div class="button-group">
                        <button id="toggle-audit-btn" class="button primary" disabled data-default-text="请稍后"><span>请稍后</span></button>
                        <button id="clear-audit-btn" class="button danger" data-default-text="清空日志"><span>清空日志</span></button>
                    </div>
                </div>
                <div class="control-module">
                    <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21C16.9706 21 21 16.9706 21 12C21 7.02944 16.9706 3 12 3ZM12 19C8.13401 19 5 15.866 5 12C5 8.13401 8.13401 5 12 5C15.866 5 19 8.13401 19 12C19 15.866 15.866 19 12 19ZM12 10.5C12.8284 10.5 13.5 11.1716 13.5 12C13.5 12.8284 12.8284 13.5 12 13.5C11.1716 13.5 10.5 12.8284 10.5 12C10.5 11.1716 11.1716 10.5 12 10.5Z"></path></svg>日志容量</h3>
                    <div class="control-item">
                        <strong>当前容量:</strong> <span id="audit-capacity">查询中...</span>
                    </div>
                    <form id="capacity-form">
                        <input type="number" id="new-capacity" placeholder="新容量 (将清空日志)" required min="1" max="400000">
                        <button type="submit" class="button primary" data-default-text="设置"><span>设置</span></button>
                    </form>
                </div>
                <div class="control-module">
                    <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM11 7H13V12L16.5 15.5L15.0858 16.9142L11 12.8284V7Z"></path></svg>自动刷新</h3>
                     <form id="auto-refresh-form" class="auto-refresh-form">
                        <label class="switch" for="auto-refresh-toggle" style="display: contents; cursor: pointer;">
                            <strong>启用</strong>
                            <label class="switch">
                                <input type="checkbox" id="auto-refresh-toggle">
                                <span class="slider"></span>
                            </label>
                        </label>
                        <div>
                            <input type="number" id="auto-refresh-interval" min="5">
                            <span>秒/次</span>
                        </div>
                    </form>
                </div>
                <div class="control-module">
                    <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.5C12.4142 2.5 12.75 2.83579 12.75 3.25V5.03131C15.2635 5.50376 17.25 7.49021 17.7224 9.99993H19.5C19.9142 9.99993 20.25 10.3357 20.25 10.75V13.25C20.25 13.6642 19.9142 14 19.5 14H17.7224C17.25 16.5097 15.2635 18.4962 12.75 18.9686V20.75C12.75 21.1642 12.4142 21.5 12 21.5C11.5858 21.5 11.25 21.1642 11.25 20.75V18.9686C8.73652 18.4962 6.75 16.5097 6.27758 14H4.5C4.08579 14 3.75 13.6642 3.75 13.25V10.75C3.75 10.3357 4.08579 9.99993 4.5 9.99993H6.27758C6.75 7.49021 8.73652 5.50376 11.25 5.03131V3.25C11.25 2.83579 11.5858 2.5 12 2.5ZM12 7C9.23858 7 7 9.23858 7 12C7 14.7614 9.23858 17 12 17C14.7614 17 17 14.7614 17 12C17 9.23858 14.7614 7 12 7Z"></path></svg>主题与外观</h3>
                    <div class="control-item">
                        <strong>颜色方案</strong>
                        <div class="color-palette">
                            <button class="color-swatch" data-color="indigo" style="background-color: #4f46e5;" title="靛蓝" aria-label="靛蓝"></button>
                            <button class="color-swatch" data-color="pink" style="background-color: #ec4899;" title="粉色" aria-label="粉色"></button>
                            <button class="color-swatch" data-color="teal" style="background-color: #14b8a6;" title="青色" aria-label="青色"></button>
                            <button class="color-swatch" data-color="orange" style="background-color: #f97316;" title="橙色" aria-label="橙色"></button>
                        </div>
                    </div>
                    <div class="control-item">
                        <strong>明暗模式</strong>
                        <div class="theme-switcher-container">
                            <div class="theme-switcher-slider"></div>
                            <button id="light-theme-btn" class="theme-switcher-button" aria-label="切换到明亮模式">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg>
                            </button>
                            <button id="dark-theme-btn" class="theme-switcher-button" aria-label="切换到黑暗模式">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <button id="fab-refresh" class="fab" aria-label="刷新数据" aria-busy="false">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
    </button>
    

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. 核心常量、状态、元素 ---
        const CONSTANTS = { API_BASE_URL: `${window.location.protocol}//${window.location.hostname}:9099`, LOGS_PER_PAGE: 50, HISTORY_LENGTH: 30, DEFAULT_AUTO_REFRESH_INTERVAL: 15, ANIMATION_DURATION: 1000, MOBILE_BREAKPOINT: 768, TOAST_DURATION: 3000 };
        let state = { isUpdating: false, isCapturing: false, isMobile: false, isTouchDevice: false, currentLogPage: 1, isLogLoading: false, logPaginationInfo: null, displayedLogs: [], currentLogSearchTerm: '', clientAliases: {}, topDomains: [], topClients: [], slowestQueries: [], logSort: { key: 'query_time', order: 'desc' }, autoRefresh: { enabled: true, intervalId: null, intervalSeconds: CONSTANTS.DEFAULT_AUTO_REFRESH_INTERVAL }, data: { totalQueries: { current: null, previous: 0 }, avgDuration: { current: null, previous: 0 } }, history: { totalQueries: [], avgDuration: [] }, lastUpdateTime: null };
        const elements = { 
            html: document.documentElement, body: document.body, container: document.querySelector('.container'), initialLoader: document.getElementById('initial-loader'), 
            lightThemeBtn: document.getElementById('light-theme-btn'), darkThemeBtn: document.getElementById('dark-theme-btn'), colorSwatches: document.querySelectorAll('.color-swatch'), 
            navWrapper: document.querySelector('.nav-wrapper'), mainNav: document.querySelector('.main-nav'), navSlider: document.querySelector('.main-nav-slider'), 
            tabLinks: document.querySelectorAll('.tab-link'), tabContents: document.querySelectorAll('.tab-content'), 
            globalRefreshBtn: document.getElementById('global-refresh-btn'), lastUpdated: document.getElementById('last-updated'), fabRefresh: document.getElementById('fab-refresh'), 
            autoRefreshToggle: document.getElementById('auto-refresh-toggle'), autoRefreshIntervalInput: document.getElementById('auto-refresh-interval'), autoRefreshForm: document.getElementById('auto-refresh-form'), 
            statCard1: document.getElementById('stat-card-1'), statCard2: document.getElementById('stat-card-2'), 
            totalQueries: document.getElementById('total-queries'), avgDuration: document.getElementById('avg-duration'), 
            sparklineTotal: document.getElementById('sparkline-total'), sparklineAvg: document.getElementById('sparkline-avg'), 
            sparklineTotalMin: document.getElementById('sparkline-total-min'), sparklineTotalMax: document.getElementById('sparkline-total-max'), 
            sparklineAvgMin: document.getElementById('sparkline-avg-min'), sparklineAvgMax: document.getElementById('sparkline-avg-max'), 
            auditStatus: document.getElementById('audit-status'), toggleAuditBtn: document.getElementById('toggle-audit-btn'), clearAuditBtn: document.getElementById('clear-audit-btn'), 
            auditCapacity: document.getElementById('audit-capacity'), capacityForm: document.getElementById('capacity-form'), newCapacityInput: document.getElementById('new-capacity'), 
            topDomainsBody: document.getElementById('top-domains-body'), topClientsBody: document.getElementById('top-clients-body'), slowestQueriesBody: document.getElementById('slowest-queries-body'), 
            logTable: document.getElementById('log-table'), logTableHead: document.getElementById('log-table-head'), logTableBody: document.getElementById('log-table-body'),
            slowestQueriesTable: document.getElementById('slowest-queries-table'),
            logSearch: document.getElementById('log-search'), logQueryTableContainer: document.getElementById('log-query-table-container'), logLoader: document.getElementById('log-loader'), 
            searchResultsInfo: document.getElementById('search-results-info'),
            toast: document.getElementById('toast'), 
            aliasModal: document.getElementById('alias-modal'), manualAliasForm: document.getElementById('manual-alias-form'), 
            aliasListContainer: document.getElementById('alias-list-container'), importAliasInput: document.getElementById('import-alias-file-input'), saveAllAliasesBtn: document.getElementById('save-all-aliases-btn'), 
            systemControlTabIndicator: document.querySelector('a[data-tab="system-control"] .status-indicator') 
        };
        let toastTimeout;
        
        // --- 2. 工具函数 ---
        const debounce = (func, wait) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };

        // --- 3. 轻量级表头对齐管理器 ---
        const tableHeaderAligner = {
            scrollbarWidth: 0,
            containersToAlign: [],

            init() {
                this.scrollbarWidth = this.getScrollbarWidth();
                this.containersToAlign = [
                    elements.logQueryTableContainer,
                    document.querySelector('#slowest-queries-card .scrollable-table-container'),
                    document.querySelector('#top-domains-card .scrollable-table-container'),
                    document.querySelector('#top-clients-card .scrollable-table-container')
                ].filter(Boolean);
                
                window.addEventListener('resize', debounce(() => this.updateAll(), 150));
                this.containersToAlign.forEach(container => {
                    container.addEventListener('scroll', () => this.update(container));
                });
            },

            getScrollbarWidth() {
                const outer = document.createElement('div');
                outer.style.visibility = 'hidden';
                outer.style.overflow = 'scroll';
                document.body.appendChild(outer);
                const inner = document.createElement('div');
                outer.appendChild(inner);
                const scrollbarWidth = outer.offsetWidth - inner.offsetWidth;
                outer.parentNode.removeChild(outer);
                return scrollbarWidth > 0 ? scrollbarWidth : 17;
            },

            update(container) {
                if (!container || state.isMobile) return;
                const thead = container.querySelector('thead');
                if (!thead) return;

                const hasScrollbar = container.scrollHeight > container.clientHeight;
                
                thead.style.paddingRight = hasScrollbar ? `${this.scrollbarWidth}px` : '0px';
            },

            updateAll() {
                this.containersToAlign.forEach(container => this.update(container));
            }
        };

        // --- 4. 主要模块 ---
        const api = { fetch: async (url, options = {}) => { try { const response = await fetch(url, { ...options, signal: options.signal }); if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`); const contentType = response.headers.get('content-type'); if (contentType && contentType.includes('application/json')) return response.json(); return { success: true, message: await response.text() }; } catch (error) { if (error.name !== 'AbortError') { ui.showToast(`网络请求失败: ${error.message}`, 'error'); console.error(error); } throw error; } }, getStatus: (signal) => api.fetch(`${CONSTANTS.API_BASE_URL}/api/v1/audit/status`, { signal }), getCapacity: (signal) => api.fetch(`${CONSTANTS.API_BASE_URL}/api/v1/audit/capacity`, { signal }), start: () => api.fetch(`${CONSTANTS.API_BASE_URL}/api/v1/audit/start`, { method: 'POST' }), stop: () => api.fetch(`${CONSTANTS.API_BASE_URL}/api/v1/audit/stop`, { method: 'POST' }), clear: () => api.fetch(`${CONSTANTS.API_BASE_URL}/api/v1/audit/clear`, { method: 'POST' }), setCapacity: (capacity) => api.fetch(`${CONSTANTS.API_BASE_URL}/api/v1/audit/capacity`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ capacity: parseInt(capacity, 10) }) }), v2: { getStats: (signal) => api.fetch(`${CONSTANTS.API_BASE_URL}/api/v2/audit/stats`, { signal }), getTopDomains: (signal, limit = 50) => api.fetch(`${CONSTANTS.API_BASE_URL}/api/v2/audit/rank/domain?limit=${limit}`, { signal }), getTopClients: (signal, limit = 50) => api.fetch(`${CONSTANTS.API_BASE_URL}/api/v2/audit/rank/client?limit=${limit}`, { signal }), getSlowest: (signal, limit = 50) => api.fetch(`${CONSTANTS.API_BASE_URL}/api/v2/audit/rank/slowest?limit=${limit}`, { signal }), getLogs: (signal, params = {}) => { const queryParams = new URLSearchParams({ page: 1, limit: CONSTANTS.LOGS_PER_PAGE, ...params }); for(let [key, value] of queryParams.entries()){ if(!value) { queryParams.delete(key); } } return api.fetch(`${CONSTANTS.API_BASE_URL}/api/v2/audit/logs?${queryParams}`, { signal }); } } };
        const ui = {
            showToast(message, type = 'success') { if (!elements.toast) return; clearTimeout(toastTimeout); const icon = type === 'success' ? `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"></path></svg>`; elements.toast.innerHTML = `${icon}<span>${message}</span>`; elements.toast.className = `show ${type}`; const hideToast = () => { elements.toast.className = elements.toast.className.replace('show', ''); }; elements.toast.onmouseenter = () => clearTimeout(toastTimeout); elements.toast.onmouseleave = () => toastTimeout = setTimeout(hideToast, CONSTANTS.TOAST_DURATION); toastTimeout = setTimeout(hideToast, CONSTANTS.TOAST_DURATION); },
            setLoading(button, isLoading) { if (!button) return; button.disabled = isLoading; const textSpan = button.querySelector('span'); if (textSpan) { if (!button.dataset.defaultText) { button.dataset.defaultText = textSpan.textContent; } textSpan.textContent = isLoading ? '处理中...' : button.dataset.defaultText; } },
            updateStatus(isCapturing) { if (!elements.toggleAuditBtn || !elements.auditStatus) return; this.setLoading(elements.toggleAuditBtn, false); const statusIndicator = elements.systemControlTabIndicator; if(statusIndicator) statusIndicator.className = 'status-indicator'; if (typeof isCapturing === 'boolean') { state.isCapturing = isCapturing; elements.auditStatus.textContent = isCapturing ? '运行中' : '已停止'; elements.auditStatus.style.color = isCapturing ? 'var(--color-success)' : 'var(--color-danger)'; const actionText = isCapturing ? '关闭审计' : '开启审计'; elements.toggleAuditBtn.querySelector('span').textContent = actionText; elements.toggleAuditBtn.dataset.defaultText = actionText; elements.toggleAuditBtn.className = `button ${isCapturing ? 'danger' : 'primary'}`; if(statusIndicator) statusIndicator.classList.add(isCapturing ? 'running' : 'stopped'); } else { elements.auditStatus.textContent = '未知'; elements.auditStatus.style.color = 'var(--color-text-secondary)'; elements.toggleAuditBtn.querySelector('span').textContent = '刷新状态'; elements.toggleAuditBtn.dataset.defaultText = '刷新状态'; } },
            updateCapacity(capacity) { if (elements.auditCapacity) elements.auditCapacity.textContent = capacity != null ? `${capacity.toLocaleString()} 条` : '查询失败'; },
            updateOverviewStats() { animateValue(elements.totalQueries, state.data.totalQueries.previous, state.data.totalQueries.current, CONSTANTS.ANIMATION_DURATION); animateValue(elements.avgDuration, state.data.avgDuration.previous, state.data.avgDuration.current, CONSTANTS.ANIMATION_DURATION); state.history.totalQueries.push(state.data.totalQueries.current ?? 0); state.history.avgDuration.push(state.data.avgDuration.current ?? 0); if (state.history.totalQueries.length > CONSTANTS.HISTORY_LENGTH) state.history.totalQueries.shift(); if (state.history.avgDuration.length > CONSTANTS.HISTORY_LENGTH) state.history.avgDuration.shift(); historyManager.save(); if (elements.sparklineTotal) elements.sparklineTotal.innerHTML = generateSparklineSVG(state.history.totalQueries); if (elements.sparklineAvg) elements.sparklineAvg.innerHTML = generateSparklineSVG(state.history.avgDuration, true); },
            renderLogTable(logs, append = false) {
                const tbody = elements.logTableBody;
                if (!tbody) return;
                
                if (!append) {
                    tbody.innerHTML = '';
                    state.displayedLogs = [];
                }

                if (logs.length === 0 && !append) {
                    renderTable(tbody, [], () => {}, 'log-query');
                    return;
                }

                const startIndex = state.displayedLogs.length;
                state.displayedLogs.push(...logs);

                const fragment = document.createDocumentFragment();
                logs.forEach((log, i) => {
                    const row = renderLogItemHTML(log, startIndex + i);
                    row.classList.add('data-log-entry');
                    row.style.animationDelay = `${i * 30}ms`;
                    fragment.appendChild(row);
                });
                tbody.appendChild(fragment);

                requestAnimationFrame(() => tableHeaderAligner.update(elements.logQueryTableContainer));
            },
            updateSearchResultsInfo(pagination) {
                if (!elements.searchResultsInfo) return;
                if (state.currentLogSearchTerm && pagination) {
                    elements.searchResultsInfo.innerHTML = `为您找到 <strong>${pagination.total_items.toLocaleString()}</strong> 条相关结果`;
                } else {
                    elements.searchResultsInfo.innerHTML = '';
                }
            }
        };
        const aliasManager = { load: () => { state.clientAliases = JSON.parse(localStorage.getItem('mosdnsClientAliases')) || {}; }, save: () => { localStorage.setItem('mosdnsClientAliases', JSON.stringify(state.clientAliases)); }, getDisplayName: (ip) => state.clientAliases[ip] || ip, getAliasedClientHTML: (ip) => state.clientAliases[ip] ? `<span class="client-alias" title="IP: ${ip}">${state.clientAliases[ip]}</span>` : ip, getIpByAlias: (alias) => { const searchTerm = alias.toLowerCase(); for (const ip in state.clientAliases) { if (state.clientAliases[ip].toLowerCase() === searchTerm) { return ip; } } return null; }, set(ip, name) { if (name) { state.clientAliases[ip] = name; } else { delete state.clientAliases[ip]; } }, async saveAll() { const aliasItems = elements.aliasListContainer.querySelectorAll('.alias-item'); let changed = false; aliasItems.forEach(item => { const ip = item.dataset.ip; const input = item.querySelector('input'); const newValue = input.value.trim(); const originalValue = input.dataset.originalValue; if (newValue !== originalValue) { this.set(ip, newValue); changed = true; } }); if(changed) { this.save(); ui.showToast('所有别名更改已保存', 'success'); await updatePageData(); await this.renderEditableList(); } else { ui.showToast('没有检测到任何更改', 'success'); } }, async renderEditableList() { if (!elements.aliasListContainer) return; elements.aliasListContainer.innerHTML = '<p>正在加载客户端列表...</p>'; try { const topClients = await api.v2.getTopClients(null, 200); const uniqueIps = [...new Set(topClients.map(client => client.key))].sort(); if (uniqueIps.length === 0) { elements.aliasListContainer.innerHTML = '<p>日志中暂无客户端 IP 记录。</p>'; return; } elements.aliasListContainer.innerHTML = ''; uniqueIps.forEach(ip => { const item = document.createElement('div'); item.className = 'alias-item'; item.dataset.ip = ip; const currentAlias = this.getDisplayName(ip); const aliasValue = currentAlias === ip ? '' : currentAlias; item.innerHTML = `<span style="font-weight:600;">${ip}</span> <input type="text" placeholder="设置别名..." value="${aliasValue}" data-original-value="${aliasValue}">`; const input = item.querySelector('input'); input.addEventListener('input', () => { input.classList.toggle('changed', input.value.trim() !== input.dataset.originalValue); }); elements.aliasListContainer.appendChild(item); }); } catch (error) { elements.aliasListContainer.innerHTML = '<p>加载客户端列表失败。</p>'; console.error("Failed to fetch clients for alias management:", error); } }, export: () => { const dataStr = JSON.stringify(state.clientAliases, null, 2); const blob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `mosdns-aliases-${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); ui.showToast('配置已导出', 'success'); }, import: (file) => { const reader = new FileReader(); reader.onload = (e) => { try { const newAliases = JSON.parse(e.target.result); if (typeof newAliases !== 'object' || newAliases === null || Array.isArray(newAliases)) throw new Error('无效的JSON对象格式'); state.clientAliases = { ...state.clientAliases, ...newAliases }; this.save(); this.renderEditableList(); updatePageData(); ui.showToast('配置已成功导入并合并', 'success'); } catch (error) { ui.showToast(`导入失败: ${error.message}`, 'error'); } }; reader.readAsText(file); }, };
        const historyManager = { load: () => { const saved = JSON.parse(localStorage.getItem('mosdnsHistory')); if (saved) { state.history.totalQueries = saved.totalQueries || []; state.history.avgDuration = saved.avgDuration || []; } }, save: () => { localStorage.setItem('mosdnsHistory', JSON.stringify(state.history)); } };
        const themeManager = { init() { const savedTheme = localStorage.getItem('mosdns-theme') || 'dark'; const savedColor = localStorage.getItem('mosdns-color') || 'indigo'; this.setTheme(savedTheme, false); this.setColor(savedColor, false); elements.lightThemeBtn?.addEventListener('click', () => this.setTheme('light')); elements.darkThemeBtn?.addEventListener('click', () => this.setTheme('dark')); elements.colorSwatches.forEach(swatch => { swatch.addEventListener('click', () => this.setColor(swatch.dataset.color)); }); }, setTheme(theme, save = true) { elements.html.setAttribute('data-theme', theme); if (elements.lightThemeBtn) { elements.lightThemeBtn.classList.toggle('active', theme === 'light'); elements.darkThemeBtn.classList.toggle('active', theme === 'dark'); } if (save) localStorage.setItem('mosdns-theme', theme); }, setColor(color, save = true) { elements.html.setAttribute('data-color-scheme', color); document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active')); document.querySelectorAll(`.color-swatch[data-color="${color}"]`).forEach(s => s.classList.add('active')); if (save) localStorage.setItem('mosdns-color', color); if (color === 'indigo') { if (elements.statCard1) elements.statCard1.className = 'stat-card default-gradient-1'; if (elements.statCard2) elements.statCard2.className = 'stat-card default-gradient-2'; } else { if (elements.statCard1) elements.statCard1.className = 'stat-card theme-gradient'; if (elements.statCard2) elements.statCard2.className = 'stat-card theme-gradient'; } } };
        const animateValue = (element, start, end, duration) => { if (!element || start === null || end === null) return; if (start === end) { element.textContent = (element.id === 'avg-duration' ? parseFloat(end).toFixed(2) : Math.floor(end).toLocaleString()); return; } let startTimestamp = null; const step = (timestamp) => { if (!startTimestamp) startTimestamp = timestamp; const progress = Math.min((timestamp - startTimestamp) / duration, 1); const current = start + progress * (end - start); element.textContent = (element.id === 'avg-duration' ? parseFloat(current).toFixed(2) : Math.floor(current).toLocaleString()); if (progress < 1) window.requestAnimationFrame(step); }; window.requestAnimationFrame(step); };
        const setupGlowEffect = () => { elements.container?.addEventListener('mousemove', (e) => { const card = e.target.closest('.card'); if (card) { const rect = card.getBoundingClientRect(); card.style.setProperty('--glow-x', `${e.clientX - rect.left}px`); card.style.setProperty('--glow-y', `${e.clientY - rect.top}px`); } }); };
        const generateSparklineSVG = (data, isFloat = false, width = 300, height = 60) => { if (!data || data.length < 2) return ''; const numericData = data.map(Number); const maxVal = Math.max(...numericData); const minVal = Math.min(...numericData); const range = maxVal - minVal === 0 ? 1 : maxVal - minVal; const points = numericData.map((d, i) => { const x = (i / (data.length - 1)) * width; const y = height - ((d - minVal) / range) * height; return `${x.toFixed(2)},${y.toFixed(2)}`; }); const pathD = `M ${points.join(' L ')}`; const fillPathD = `${pathD} L ${width},${height} L 0,${height} Z`; return `<svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="none"><defs><linearGradient id="sparkline-gradient" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="var(--color-accent-text, #fff)" stop-opacity="0.5" /><stop offset="100%" stop-color="var(--color-accent-text, #fff)" stop-opacity="0" /></linearGradient></defs><path d="${fillPathD}" fill="url(#sparkline-gradient)" /><path d="${pathD}" class="sparkline-path" fill="none" /></svg>`; };
        const renderTable = (tbody, data, renderRow, tableType) => { if (!tbody) return; tbody.innerHTML = ''; if (!data || data.length === 0) { const isSearchEmpty = tableType === 'log-query' && state.currentLogSearchTerm; const message = isSearchEmpty ? `沒有找到与 "<strong>${state.currentLogSearchTerm}</strong>" 匹配的记录。` : '请确保审计功能已开启。'; const ctaButton = isSearchEmpty ? '' : '<button class="button primary tab-link-action" data-tab="system-control">前往系统控制</button>'; const colspan = state.isMobile ? 1 : (tbody.previousElementSibling?.rows[0]?.cells.length || 2); const emptyRow = document.createElement('tr'); emptyRow.className = 'empty-state-row'; emptyRow.innerHTML = `<td colspan="${colspan}"><div class="empty-state-content"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.71,3.29C21.32,2.9,20.69,2.9,20.3,3.29L3.29,20.3c-0.39,0.39-0.39,1.02,0,1.41C3.48,21.9,3.74,22,4,22s0.52-0.1,0.71-0.29L21.71,4.7C22.1,4.31,22.1,3.68,21.71,3.29z M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10,10-4.48,10-10S17.52,2,12,2z M12,20c-4.41,0-8-3.59-8-8c0-2.33,1-4.45,2.65-5.92l11.27,11.27C16.45,19,14.33,20,12,20z"></path></svg><strong>暂无数据</strong><p>${message}</p>${ctaButton}</div></td>`; tbody.appendChild(emptyRow); return; } const fragment = document.createDocumentFragment(); data.forEach((item, index) => { const row = renderRow(item, index); row.classList.add('data-log-entry'); row.style.animationDelay = `${index * 30}ms`; fragment.appendChild(row); }); tbody.appendChild(fragment); };
        const renderTopDomains = (data) => renderTable(elements.topDomainsBody, data, (item, index) => { const tr = document.createElement('tr'); tr.dataset.rankIndex = index; tr.dataset.rankSource = 'domain'; tr.innerHTML = `<td><span class="truncate-text">${item.key}</span></td><td class="text-right hide-on-mobile"><a href="#log-query" class="clickable-link" data-filter-value="${item.key}">${item.count.toLocaleString()}</a></td>`; return tr; }, 'top-domains');
        const renderTopClients = (data) => renderTable(elements.topClientsBody, data, (item, index) => { const tr = document.createElement('tr'); tr.dataset.rankIndex = index; tr.dataset.rankSource = 'client'; tr.innerHTML = `<td>${aliasManager.getAliasedClientHTML(item.key)}</td><td class="text-right hide-on-mobile"><a href="#log-query" class="clickable-link" data-filter-value="${item.key}">${item.count.toLocaleString()}</a></td>`; return tr; }, 'top-clients');
        const renderSlowestQueries = (data) => renderTable(elements.slowestQueriesBody, data, renderSlowestQueryItemHTML, 'slowest-queries');
        
        let updateController;
        async function updatePageData() {
            if (state.isUpdating) return;
            state.isUpdating = true;
            if (updateController) updateController.abort();
            updateController = new AbortController();
            const signal = updateController.signal;
            elements.globalRefreshBtn.setAttribute('aria-busy', 'true');
            elements.fabRefresh.setAttribute('aria-busy', 'true');
            try {
                const [statusRes, capacityRes, statsRes, topDomainsRes, topClientsRes, slowestRes] = await Promise.allSettled([
                    api.getStatus(signal), api.getCapacity(signal), api.v2.getStats(signal),
                    api.v2.getTopDomains(signal), api.v2.getTopClients(signal), api.v2.getSlowest(signal, 50)
                ]);
                
                ui.updateStatus(statusRes.status === 'fulfilled' ? statusRes.value?.capturing : null);
                ui.updateCapacity(capacityRes.status === 'fulfilled' ? capacityRes.value?.capacity : null);

                if (statsRes.status === 'fulfilled' && statsRes.value) {
                    const stats = statsRes.value;
                    state.data.totalQueries.previous = state.data.totalQueries.current ?? stats.total_queries;
                    state.data.avgDuration.previous = state.data.avgDuration.current ?? stats.average_duration_ms;
                    state.data.totalQueries.current = stats.total_queries;
                    state.data.avgDuration.current = stats.average_duration_ms;
                    ui.updateOverviewStats();
                }

                if (topDomainsRes.status === 'fulfilled') { state.topDomains = topDomainsRes.value || []; renderTopDomains(state.topDomains); }
                if (topClientsRes.status === 'fulfilled') { state.topClients = topClientsRes.value || []; renderTopClients(state.topClients); }
                if (slowestRes.status === 'fulfilled') { state.slowestQueries = slowestRes.value || []; renderSlowestQueries(state.slowestQueries); }
                
                state.lastUpdateTime = new Date();
                updateLastUpdated();

                const activeTabLink = document.querySelector('.tab-link.active');
                if (activeTabLink && activeTabLink.dataset.tab === 'log-query') { fetchAndRenderLogs(1, false); }
            } catch (error) { if (error.name !== 'AbortError') console.error("Page update failed:", error); } 
            finally { 
                elements.globalRefreshBtn.setAttribute('aria-busy', 'false'); 
                elements.fabRefresh.setAttribute('aria-busy', 'false'); 
                state.isUpdating = false; 
                requestAnimationFrame(() => tableHeaderAligner.updateAll());
            }
        }
        
        let logRequestController;
        async function fetchAndRenderLogs(page = 1, append = false) {
            if (state.isLogLoading && !append) {
                return;
            }
            state.isLogLoading = true;
            if (elements.logLoader) elements.logLoader.style.display = 'block';
            
            if (!append && logRequestController) {
                logRequestController.abort();
            }
            logRequestController = new AbortController();
            const signal = logRequestController.signal;

            const params = {
                page: page,
                limit: CONSTANTS.LOGS_PER_PAGE,
                q: state.currentLogSearchTerm.query,
                exact: state.currentLogSearchTerm.exact,
            };

            try {
                const response = await api.v2.getLogs(signal, params);

                if (!response || !response.pagination) {
                    throw new Error("Invalid response from logs API");
                }
                
                const { pagination, logs } = response;
                state.logPaginationInfo = pagination;
                state.currentLogPage = pagination.current_page;
                
                if(!append) {
                     ui.updateSearchResultsInfo(pagination);
                }

                ui.renderLogTable(logs || [], append);

            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error("Failed to fetch logs:", error);
                    ui.showToast('获取日志失败', 'error');
                }
            } finally { 
                state.isLogLoading = false; 
                if (elements.logLoader) elements.logLoader.style.display = 'none'; 
                requestAnimationFrame(() => tableHeaderAligner.update(elements.logQueryTableContainer));
            }
        }
        
        const tableSorter = {
            init() { if (elements.logTableHead) elements.logTableHead.addEventListener('click', this.handleSort.bind(this)); this.updateHeaders(); },
            handleSort(e) { const th = e.target.closest('th[data-sortable]'); if (!th) return; const key = th.dataset.sortKey; if (state.logSort.key === key) { state.logSort.order = state.logSort.order === 'asc' ? 'desc' : 'asc'; } else { state.logSort.key = key; state.logSort.order = 'desc'; } this.sortLogs(); this.updateHeaders(); },
            sortLogs() {
                const logs = state.displayedLogs;
                const { key, order } = state.logSort;
                logs.sort((a, b) => {
                    let valA = a[key];
                    let valB = b[key];
                    if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
                    const result = valA < valB ? -1 : valA > valB ? 1 : 0;
                    return order === 'asc' ? result : -result;
                });
                ui.renderLogTable(logs, false); // Re-render the table with sorted data
            },
            updateHeaders() { document.querySelectorAll('#log-table-head th[data-sortable]').forEach(th => { th.classList.remove('sorted'); const indicator = th.querySelector('.sort-indicator'); if(indicator) { if (th.dataset.sortKey === state.logSort.key) { th.classList.add('sorted'); indicator.textContent = state.logSort.order === 'asc' ? '▲' : '▼'; } else { indicator.textContent = ' '; } } }); }
        };

        function applyLogFilterAndRender() {
            if (!elements.logSearch) return;
            const rawSearchTerm = elements.logSearch.value.trim();
            
            let query = rawSearchTerm;
            let exact = false;

            if (rawSearchTerm.startsWith('"') && rawSearchTerm.endsWith('"')) {
                query = rawSearchTerm.substring(1, rawSearchTerm.length - 1);
                exact = true;
            }

            // Also check for alias if it's not an exact search
            if (!exact) {
                const ipFromAlias = aliasManager.getIpByAlias(query);
                if (ipFromAlias) {
                    query = ipFromAlias; 
                }
            }
            
            state.currentLogSearchTerm = { query, exact };
            fetchAndRenderLogs(1, false);
        }

        function loadMoreLogs() {
            if (state.isLogLoading || !state.logPaginationInfo || state.currentLogPage >= state.logPaginationInfo.total_pages) {
                return;
            }
            fetchAndRenderLogs(state.currentLogPage + 1, true);
        }

        function formatDate(isoString) { return isoString ? new Date(isoString).toLocaleString('zh-CN', { hour12: false, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' }).replace(/\//g, '-') : 'N/A'; }
        function formatRelativeTime(isoString) {
            if (!isoString) return 'N/A';
            const now = new Date();
            const past = new Date(isoString);
            const diffInSeconds = Math.max(0, Math.round((now - past) / 1000));
            if (diffInSeconds < 5) return '刚刚';
            if (diffInSeconds < 60) return `${diffInSeconds}秒前`;
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}分钟前`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}小时前`;
            if (diffInSeconds < 86400 * 2) return `昨天`;
            return past.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
        }
        function updateLastUpdated() { if (elements.lastUpdated) { elements.lastUpdated.textContent = state.lastUpdateTime ? `上次更新于 ${formatRelativeTime(state.lastUpdateTime.toISOString())}` : ''; } }
        
        let activeTooltip = null;
        let hideTooltipTimeout = null;

        function showTooltip(targetElement) {
            clearTimeout(hideTooltipTimeout);
            const logIndex = targetElement.dataset.logIndex ? parseInt(targetElement.dataset.logIndex, 10) : null;
            const rankIndex = targetElement.dataset.rankIndex ? parseInt(targetElement.dataset.rankIndex, 10) : null;
            const source = targetElement.dataset.logSource || targetElement.dataset.rankSource;
            const targetId = `${source}-${logIndex ?? rankIndex}`;
            
            if (state.isTouchDevice && activeTooltip && activeTooltip.dataset.targetId === targetId) { hideTooltip(true); return; }
            hideTooltip(true);

            let data;
            if(source === 'slowest') data = state.slowestQueries[logIndex];
            else if(source === 'domain') data = state.topDomains[rankIndex];
            else if(source === 'client') data = state.topClients[rankIndex];
            else if(logIndex !== null) data = state.displayedLogs[logIndex];
            
            if (!data) return;

            activeTooltip = document.createElement('div');
            activeTooltip.className = 'answers-tooltip';
            activeTooltip.innerHTML = getTooltipHTML(data, source);
            activeTooltip.dataset.targetId = targetId;
            document.body.appendChild(activeTooltip);

            const targetRect = targetElement.getBoundingClientRect();
            const tooltipRect = activeTooltip.getBoundingClientRect();
            let top = targetRect.bottom + 10;
            let left = targetRect.left + (targetRect.width / 2) - (tooltipRect.width / 2);
            if (top + tooltipRect.height > window.innerHeight - 10) { top = targetRect.top - tooltipRect.height - 10; }
            if (left < 10) { left = 10; } 
            else if (left + tooltipRect.width > window.innerWidth - 10) { left = window.innerWidth - tooltipRect.width - 10; }
            activeTooltip.style.top = `${top}px`;
            activeTooltip.style.left = `${left}px`;
            setTimeout(() => { if (activeTooltip) activeTooltip.classList.add('visible'); }, 10);
        }

        function hideTooltip(immediate = false) {
            clearTimeout(hideTooltipTimeout);
            if (!activeTooltip) return;
            if (immediate) {
                if (activeTooltip) activeTooltip.remove();
                activeTooltip = null;
            } else {
                hideTooltipTimeout = setTimeout(() => {
                    if (activeTooltip) {
                        activeTooltip.classList.remove('visible');
                        setTimeout(() => { if (activeTooltip) activeTooltip.remove(); activeTooltip = null; }, 200);
                    }
                }, 100);
            }
        }
        
        function getResponseTagHTML(log) { if (!log) return ''; const code = log.response_code || 'UNKNOWN'; let tagClass = 'other'; if (code === 'NOERROR') tagClass = 'noerror'; else if (code === 'NXDOMAIN') tagClass = 'nxdomain'; else if (code === 'SERVFAIL') tagClass = 'servfail'; else if (code === 'REFUSED') tagClass = 'refused'; return `<span class="response-tag ${tagClass}">${code}</span>`; }
        function getResponseSummary(log) { if (!log) return ''; if (log.response_code !== 'NOERROR') { return getResponseTagHTML(log); } if (log.answers && log.answers.length > 0) { const firstIp = log.answers.find(a => a.type === 'A' || a.type === 'AAAA'); const firstCname = log.answers.find(a => a.type === 'CNAME'); let mainText = firstIp ? firstIp.data : (firstCname ? firstCname.data : log.answers[0].data); if (mainText.length > 25) mainText = mainText.substring(0, 22) + '...'; if (log.answers.length > 1) mainText += ` (+${log.answers.length - 1})`; return `<span class="truncate-text">${mainText}</span>`; } return '<span>(empty)</span>'; }
        function renderDomainResponseCellHTML(log) { return `<div class="domain-response-cell"><span class="domain-name truncate-text">${log.query_name}</span><span class="response-summary">${getResponseSummary(log)}</span></div>`; }
        
        function renderLogItemHTML(log, globalIndex) {
            const tr = document.createElement('tr');
            tr.dataset.logIndex = globalIndex;
            if (state.isMobile) {
                tr.innerHTML = `<td><div class="mobile-log-row"><div class="domain">${log.query_name}</div><div class="time">${formatRelativeTime(log.query_time)}</div><div class="meta"><span class="client">${aliasManager.getDisplayName(log.client_ip)}</span><span class="duration">${log.duration_ms.toFixed(0)}ms</span>${getResponseTagHTML(log)}</div></div></td>`;
            } else {
                tr.innerHTML = `<td>${formatRelativeTime(log.query_time)}</td><td>${renderDomainResponseCellHTML(log)}</td><td>${log.query_type}</td><td class="text-right">${log.duration_ms.toFixed(2)}</td><td>${aliasManager.getAliasedClientHTML(log.client_ip)}</td>`;
            }
            return tr;
        }

        function renderSlowestQueryItemHTML(log, index) {
            const tr = document.createElement('tr');
            tr.dataset.logIndex = index;
            tr.dataset.logSource = 'slowest';
            if (state.isMobile) {
                tr.innerHTML = `<td><div class="mobile-log-row"><div class="domain">${log.query_name}</div><div class="time">${formatRelativeTime(log.query_time)}</div><div class="meta"><span class="client">${aliasManager.getDisplayName(log.client_ip)}</span><span class="duration">${log.duration_ms.toFixed(0)}ms</span>${getResponseTagHTML(log)}</div></div></td>`;
            } else {
                tr.innerHTML = `
                    <td class="hide-on-mobile">${formatRelativeTime(log.query_time)}</td>
                    <td>${renderDomainResponseCellHTML(log)}</td>
                    <td class="hide-on-mobile text-right">${log.duration_ms.toFixed(2)}</td>
                    <td class="hide-on-mobile">${aliasManager.getAliasedClientHTML(log.client_ip)}</td>
                `;
            }
            return tr;
        }

        function getTooltipHTML(data, source) { if (!data) return ''; const queryInfo = {}; const responseInfo = {}; let answers = []; if (source === 'domain' || source === 'client') { queryInfo['请求数'] = data.count.toLocaleString(); } else { const flags = data.response_flags || {}; const flagItems = []; if (flags.ra) flagItems.push('RA'); if (flags.aa) flagItems.push('AA'); if (flags.tc) flagItems.push('TC'); queryInfo['精确时间'] = formatDate(data.query_time); queryInfo['客户端'] = aliasManager.getDisplayName(data.client_ip); queryInfo['类型'] = data.query_type || 'N/A'; if (data.query_class) queryInfo['类别'] = data.query_class; responseInfo['耗时'] = `${data.duration_ms.toFixed(2)} ms`; responseInfo['状态'] = data.response_code || 'N/A'; if (flagItems.length > 0) responseInfo['标志'] = flagItems.join(', '); if (data.trace_id) { const copyIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg>`; queryInfo['Trace ID'] = `<div><small>${data.trace_id}</small> <button class="copy-btn" data-copy-value="${data.trace_id}" title="复制Trace ID">${copyIcon}</button></div>`; } answers = data.answers || []; } const buildList = (obj) => Object.entries(obj).map(([key, value]) => `<li><strong>${key}:</strong> ${value}</li>`).join(''); let tooltipHTML = ``; if (Object.keys(queryInfo).length > 0) tooltipHTML += `<h5>查询信息</h5><ul>${buildList(queryInfo)}</ul>`; if (Object.keys(responseInfo).length > 0) tooltipHTML += `<h5 style="margin-top:0.75rem;">响应信息</h5><ul>${buildList(responseInfo)}</ul>`; if (answers.length > 0) { tooltipHTML += `<h5 style="margin-top:0.75rem;">应答记录 (${answers.length})</h5><ul>${answers.map(ans => `<li>[${ans.type}] ${ans.data} <small>(TTL: ${ans.ttl}s)</small></li>`).join('')}</ul>`; } return tooltipHTML; }
        
        const autoRefreshManager = {
            start() { this.stop(); if (state.autoRefresh.enabled && state.autoRefresh.intervalSeconds >= 5) { state.autoRefresh.intervalId = setInterval(updatePageData, state.autoRefresh.intervalSeconds * 1000); } },
            stop() { if (state.autoRefresh.intervalId) { clearInterval(state.autoRefresh.intervalId); state.autoRefresh.intervalId = null; } },
            updateSettings(enabled, seconds) { state.autoRefresh.enabled = enabled; state.autoRefresh.intervalSeconds = Math.max(seconds, 5); localStorage.setItem('mosdnsAutoRefresh', JSON.stringify({ enabled: state.autoRefresh.enabled, intervalSeconds: state.autoRefresh.intervalSeconds })); this.start(); ui.showToast(`自动刷新已${enabled ? `开启, 频率: ${state.autoRefresh.intervalSeconds}秒` : '关闭'}`, 'success'); },
            loadSettings() { const saved = JSON.parse(localStorage.getItem('mosdnsAutoRefresh')); if (saved) { state.autoRefresh.enabled = saved.enabled ?? true; state.autoRefresh.intervalSeconds = saved.intervalSeconds || CONSTANTS.DEFAULT_AUTO_REFRESH_INTERVAL; } elements.autoRefreshToggle.checked = state.autoRefresh.enabled; elements.autoRefreshIntervalInput.value = state.autoRefresh.intervalSeconds; elements.autoRefreshIntervalInput.disabled = !state.autoRefresh.enabled; }
        };

        function handleNavigation(targetLink) {
            if (!targetLink || !elements.mainNav) return;
            elements.tabLinks.forEach(link => link.classList.remove('active'));
            targetLink.classList.add('active');
            
            const navPadding = parseFloat(getComputedStyle(elements.mainNav).paddingLeft);
            elements.navSlider.style.width = `${targetLink.offsetWidth}px`;
            elements.navSlider.style.transform = `translateX(${targetLink.offsetLeft - navPadding}px)`;

            const newHash = targetLink.getAttribute('href');
            if (window.location.hash !== newHash) {
                history.pushState(null, '', newHash);
            }
            
            const activeTabId = targetLink.dataset.tab;
            elements.tabContents.forEach(el => {
                el.classList.toggle('active', el.id === `${activeTabId}-tab`);
            });
            
            if (activeTabId === 'log-query' && state.displayedLogs.length === 0) {
                applyLogFilterAndRender();
            }
        }
        
        function handleResize() {
            const wasMobile = state.isMobile;
            state.isMobile = window.innerWidth <= CONSTANTS.MOBILE_BREAKPOINT;
            
            if (wasMobile !== state.isMobile) {
                elements.logTable?.classList.toggle('mobile-card-layout', state.isMobile);
                elements.slowestQueriesTable?.classList.toggle('mobile-card-layout', state.isMobile);
                
                const activeTab = document.querySelector('.tab-link.active')?.dataset.tab;
                if (activeTab === 'log-query') {
                    ui.renderLogTable(state.displayedLogs); 
                } else if (activeTab === 'overview') {
                    renderSlowestQueries(state.slowestQueries);
                }
            }

            if (state.isTouchDevice) { elements.body.classList.add('touch'); } else { elements.body.classList.remove('touch'); }
            const activeLink = document.querySelector('.tab-link.active');
            if (activeLink) { setTimeout(() => handleNavigation(activeLink), 50); }
        }

        function setupEventListeners() {
            elements.tabLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); handleNavigation(link); }); });
            window.addEventListener('popstate', () => { const hash = window.location.hash || '#overview'; const targetLink = document.querySelector(`.tab-link[href="${hash}"]`); handleNavigation(targetLink || elements.tabLinks[0]); });
            window.addEventListener('resize', debounce(handleResize, 150));
            [elements.globalRefreshBtn, elements.fabRefresh].forEach(btn => btn?.addEventListener('click', updatePageData));
            setInterval(updateLastUpdated, 5000);
            elements.autoRefreshForm.addEventListener('change', (e) => { if(e.target.type === 'checkbox' || e.target.type === 'number') { const enabled = elements.autoRefreshToggle.checked; const interval = parseInt(elements.autoRefreshIntervalInput.value, 10); elements.autoRefreshIntervalInput.disabled = !enabled; autoRefreshManager.updateSettings(enabled, interval); } });
            document.addEventListener('visibilitychange', () => { document.hidden ? autoRefreshManager.stop() : autoRefreshManager.start(); });
            elements.toggleAuditBtn?.addEventListener('click', async (e) => { const btn = e.currentTarget; ui.setLoading(btn, true); try { if (state.isCapturing) { await api.stop(); } else { await api.start(); } } catch (error) { console.error("操作失败:", error); } await updatePageData(); });
            elements.clearAuditBtn?.addEventListener('click', async (e) => { if (confirm('确定要清空所有内存审计日志吗？此操作不可恢复。')) { const btn = e.currentTarget; ui.setLoading(btn, true); try { await api.clear(); ui.showToast('日志已清空', 'success'); if (elements.logSearch) elements.logSearch.value = ''; } catch (error) { ui.showToast('清空日志失败', 'error'); } finally { await updatePageData(); ui.setLoading(btn, false); } } });
            elements.capacityForm?.addEventListener('submit', async (e) => { e.preventDefault(); const newCapacity = parseInt(elements.newCapacityInput.value, 10); if (!newCapacity || newCapacity <= 0 || newCapacity > 400000) { ui.showToast('请输入1到400000之间的有效容量', 'error'); return; } if (confirm(`确定要将容量设置为 ${newCapacity.toLocaleString()} 吗？\n\n注意：这将清空当前所有日志。`)) { const btn = e.currentTarget.querySelector('button'); ui.setLoading(btn, true); try { await api.setCapacity(newCapacity); ui.showToast(`容量已成功设置为 ${newCapacity.toLocaleString()}`, 'success'); elements.newCapacityInput.value = ''; } catch (error) { console.error("Set capacity failed:", error); } finally { await updatePageData(); ui.setLoading(btn, false); } } });
            elements.logSearch?.addEventListener('input', debounce(applyLogFilterAndRender, 300));
            elements.logQueryTableContainer?.addEventListener('scroll', () => { const { scrollTop, scrollHeight, clientHeight } = elements.logQueryTableContainer; if (clientHeight + scrollTop >= scrollHeight - 200) { loadMoreLogs(); } });
            
            document.querySelectorAll('.stat-card').forEach(card => {
                card.addEventListener('mouseenter', () => {
                    const sparklineId = card.querySelector('.sparkline-container')?.id;
                    if (!sparklineId) return;
                    const historyKey = sparklineId === 'sparkline-total' ? 'totalQueries' : 'avgDuration';
                    const data = state.history[historyKey];
                    if(data && data.length > 0) {
                        const min = Math.min(...data);
                        const max = Math.max(...data);
                        const isAvg = historyKey === 'avgDuration';
                        document.getElementById(`${sparklineId}-min`).textContent = isAvg ? min.toFixed(2) : min.toLocaleString();
                        document.getElementById(`${sparklineId}-max`).textContent = isAvg ? max.toFixed(2) : max.toLocaleString();
                    }
                });
            });

            elements.body.addEventListener('click', e => {
                const clickableLink = e.target.closest('.clickable-link');
                const tabLinkAction = e.target.closest('.tab-link-action');
                const copyBtn = e.target.closest('.copy-btn');
                if (clickableLink) { e.preventDefault(); if (elements.logSearch) { elements.logSearch.value = clickableLink.dataset.filterValue; } const logQueryLink = document.querySelector('.tab-link[href="#log-query"]'); if (logQueryLink) handleNavigation(logQueryLink); applyLogFilterAndRender(); return; }
                if (tabLinkAction) { e.preventDefault(); const tabId = tabLinkAction.dataset.tab; const targetLink = document.querySelector(`.tab-link[data-tab="${tabId}"]`); if(targetLink) handleNavigation(targetLink); return; }
                if (copyBtn) {
                    e.stopPropagation();
                    const valueToCopy = copyBtn.dataset.copyValue;
                    if(valueToCopy) {
                        navigator.clipboard.writeText(valueToCopy)
                            .then(() => ui.showToast('已复制到剪贴板', 'success'))
                            .catch(err => ui.showToast('复制失败', 'error'));
                    }
                    return;
                }
            });

            if (state.isTouchDevice) {
                elements.body.addEventListener('click', e => {
                    const tooltipTrigger = e.target.closest('tr[data-log-index], tr[data-rank-index]');
                    if (tooltipTrigger) { showTooltip(tooltipTrigger); return; }
                    if (activeTooltip && !e.target.closest('.answers-tooltip')) { hideTooltip(true); }
                });
            } else {
                let currentHoverTarget = null;
                elements.body.addEventListener('mouseover', e => {
                    const tooltipTrigger = e.target.closest('tr[data-log-index], tr[data-rank-index]');
                    if (tooltipTrigger) {
                        currentHoverTarget = tooltipTrigger;
                        showTooltip(tooltipTrigger);
                    }
                });
                elements.body.addEventListener('mouseout', e => {
                    const tooltipTrigger = e.target.closest('tr[data-log-index], tr[data-rank-index]');
                    if (tooltipTrigger && tooltipTrigger === currentHoverTarget) {
                        currentHoverTarget = null;
                        hideTooltip();
                    }
                });
            }

            if (elements.aliasModal) {
                document.getElementById('manage-aliases-btn')?.addEventListener('click', async () => { await aliasManager.renderEditableList(); elements.aliasModal.showModal(); });
                document.getElementById('close-alias-modal')?.addEventListener('click', () => elements.aliasModal.close());
                elements.saveAllAliasesBtn?.addEventListener('click', async () => {
                    ui.setLoading(elements.saveAllAliasesBtn, true);
                    await aliasManager.saveAll();
                    ui.setLoading(elements.saveAllAliasesBtn, false);
                });
                document.getElementById('export-aliases-btn')?.addEventListener('click', () => aliasManager.export());
                document.getElementById('import-aliases-btn')?.addEventListener('click', () => elements.importAliasInput?.click());
                elements.importAliasInput?.addEventListener('change', (e) => { if (e.target.files?.length > 0) { aliasManager.import(e.target.files[0]); e.target.value = ''; } });
                elements.manualAliasForm.addEventListener('submit', async (e) => { e.preventDefault(); const btn = e.currentTarget.querySelector('button'); ui.setLoading(btn, true); const ipInput = document.getElementById('manual-alias-ip'); const nameInput = document.getElementById('manual-alias-name'); const ip = ipInput.value.trim(); const name = nameInput.value.trim(); if(ip && name) { aliasManager.set(ip, name); aliasManager.save(); ui.showToast(`已添加别名: ${name} -> ${ip}`, 'success'); ipInput.value = ''; nameInput.value = ''; await aliasManager.renderEditableList(); await updatePageData(); } else { ui.showToast('IP地址和别名均不能为空', 'error'); } ui.setLoading(btn, false); });
            }
        }
        
        async function init() {
            state.isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
            
            themeManager.init();
            aliasManager.load();
            historyManager.load();
            autoRefreshManager.loadSettings();
            tableSorter.init();
            setupEventListeners();
            setupGlowEffect();
            
            tableHeaderAligner.init();
            
            handleResize();
            
            const initialHash = window.location.hash || '#overview';
            const initialLink = document.querySelector(`.tab-link[href="${initialHash}"]`);
            handleNavigation(initialLink || elements.tabLinks[0]);

            await updatePageData();
            
            const loader = elements.initialLoader;
            loader.style.opacity = '0';
            loader.addEventListener('transitionend', () => loader.remove());
            
            if (!document.hidden) autoRefreshManager.start();
        }

        init();
    });
    </script>
</body>
</html>

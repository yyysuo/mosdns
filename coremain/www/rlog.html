<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark" data-color-scheme="indigo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mosdns ‰ª™Ë°®Áõò V3.1 Hybrid</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code&family=Georgia&display=swap" rel="stylesheet">
    <style>
        /* --- UI CSS (V3.1 "Hybrid" - Best of Both Worlds) --- */
        :root { 
            --font-family-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            --font-family-mono: "Fira Code", "SF Mono", "Consolas", monospace;
            --font-family-serif: 'Georgia', "Times New Roman", serif;
            --border-radius-xl: 20px;
            --border-radius-lg: 16px; 
            --border-radius-md: 12px; 
            --border-radius-sm: 8px; 
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.04); 
            --shadow-md: 0 4px 10px rgba(0,0,0,0.08); 
            --shadow-lg: 0 10px 30px -5px rgba(0,0,0,0.1), 0 8px 16px -8px rgba(0,0,0,0.06);
            --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            --transition-med: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        }

        /* ‰∏ªÈ¢òËâ≤Á≥ªÁªü */
        [data-color-scheme="indigo"] { --color-accent-primary: #4f46e5; --color-accent-primary-hover: #4338ca; --glow-color: rgba(79, 70, 229, 0.2); }
        [data-color-scheme="pink"] { --color-accent-primary: #ec4899; --color-accent-primary-hover: #db2777; --glow-color: rgba(236, 72, 153, 0.2); }
        [data-color-scheme="teal"] { --color-accent-primary: #14b8a6; --color-accent-primary-hover: #0d9488; --glow-color: rgba(20, 184, 166, 0.15); }
        [data-color-scheme="orange"] { --color-accent-primary: #f97316; --color-accent-primary-hover: #ea580c; --glow-color: rgba(249, 115, 22, 0.2); }
        [data-color-scheme="green"] { --color-accent-primary: #22c55e; --color-accent-primary-hover: #16a34a; --glow-color: rgba(34, 197, 94, 0.2); }
        [data-color-scheme="violet"] { --color-accent-primary: #8b5cf6; --color-accent-primary-hover: #7c3aed; --glow-color: rgba(139, 92, 246, 0.2); }

        [data-theme="dark"][data-color-scheme="indigo"] { --color-accent-primary: #6d9dff; --color-accent-primary-hover: #80b6f8; --glow-color: rgba(88, 166, 255, 0.15); }
        [data-theme="dark"][data-color-scheme="pink"] { --color-accent-primary: #f778ba; --color-accent-primary-hover: #f599ce; --glow-color: rgba(247, 120, 186, 0.15); }
        [data-theme="dark"][data-color-scheme="teal"] { --color-accent-primary: #2dd4bf; --color-accent-primary-hover: #5eead4; --glow-color: rgba(45, 212, 191, 0.15); }
        [data-theme="dark"][data-color-scheme="orange"] { --color-accent-primary: #fb923c; --color-accent-primary-hover: #fdba74; --glow-color: rgba(251, 146, 60, 0.15); }
        [data-theme="dark"][data-color-scheme="green"] { --color-accent-primary: #4ade80; --color-accent-primary-hover: #86efac; --glow-color: rgba(74, 222, 128, 0.15); }
        [data-theme="dark"][data-color-scheme="violet"] { --color-accent-primary: #a78bfa; --color-accent-primary-hover: #c4b5fd; --glow-color: rgba(167, 139, 250, 0.15); }

        /* Âü∫Á°ÄÊòéÊöó‰∏ªÈ¢òÂèòÈáè */
        [data-theme="light"] { --color-bg: #f3f5f9; --color-bg-card: #ffffff; --color-bg-alt: #eef1f7; --color-text-primary: #0f172a; --color-text-secondary: #64748b; --color-border: #e2e8f0; --color-accent-secondary: #ec4899; --color-accent-text: #ffffff; --color-danger: #ef4444; --color-danger-hover: #dc2626; --color-success: #22c55e; --color-warning: #f59e0b; --glow-border-color: rgba(79, 70, 229, 0.3); }
        [data-theme="dark"] { --color-bg: #0f121a; --color-bg-card: #191e29; --color-bg-alt: #222836; --color-text-primary: #c9d1d9; --color-text-secondary: #8b949e; --color-border: #30363d; --color-accent-secondary: #f778ba; --color-accent-text: #0f172a; --color-danger: #f87171; --color-danger-hover: #ff9191; --color-success: #56d364; --color-warning: #facc15; --glow-border-color: rgba(88, 166, 255, 0.25); }
        
        /* --- Âü∫Á°ÄÊ†∑Âºè --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: color-mix(in srgb, var(--color-accent-primary) 40%, transparent); border-radius: 8px; border: 2px solid transparent; background-clip: content-box;}
        ::-webkit-scrollbar-thumb:hover { background-color: color-mix(in srgb, var(--color-accent-primary) 60%, transparent); }
        *, *::before, *::after { box-sizing: border-box; }
        html { font-size: 16px; scroll-behavior: smooth; }
        body { font-family: var(--font-family-sans); background-color: var(--color-bg); color: var(--color-text-primary); margin: 0; position: relative; overflow-x: hidden; transition: background-color var(--transition-slow), color var(--transition-slow); }
        body::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 400px; background: linear-gradient(180deg, var(--glow-color) 0%, transparent 100%); z-index: 0; pointer-events: none; transition: var(--transition-slow); }
        .container { max-width: 1300px; margin: 0 auto; padding: 2rem; position: relative; z-index: 1;}
        h1, h2, h3, p { margin: 0; }
        h1 { font-size: 2.25rem; font-weight: 800; }
        h2 { font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.6rem; }
        h2 svg { width: 1.2em; height: 1.2em; color: var(--color-accent-primary); }
        h3 { font-size: 0.9rem; font-weight: 600; color: var(--color-text-secondary); text-transform: uppercase; letter-spacing: 0.8px;}
        a { color: var(--color-accent-primary); text-decoration: none; font-weight: 600; transition: var(--transition-fast); }
        a:hover { color: var(--color-accent-primary-hover); }
        .text-right { text-align: right; }

        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem; flex-wrap: wrap; gap: 1.5rem; }
        .header-main-actions { display: flex; align-items: center; gap: 0.75rem; margin-left: auto; max-width: 100%; }
        .last-updated { font-size: 0.8rem; color: var(--color-text-secondary); white-space: nowrap; }
        .nav-wrapper { position: relative; overflow-x: auto; overflow-y: hidden; }
        
        .main-nav { display: inline-flex; background-color: var(--color-bg-alt); border: 1px solid var(--color-border); border-radius: var(--border-radius-md); padding: 0.25rem; }
        .main-nav-slider { position: absolute; top: 0.25rem; bottom: 0.25rem; border-radius: var(--border-radius-sm); background: var(--color-accent-primary); box-shadow: var(--shadow-md); transition: all var(--transition-med); z-index: 0; }
        .main-nav a { display: flex; align-items: center; justify-content: center; gap: 0.6rem; padding: 0.6rem 1.1rem; color: var(--color-text-primary); opacity: 0.7; font-weight: 600; font-size: 0.95rem; position: relative; z-index: 1; transition: color var(--transition-med), opacity var(--transition-med); white-space: nowrap; }
        .main-nav a:hover:not(.active), .main-nav a.active { opacity: 1; }
        [data-theme="light"] .main-nav a.active { color: var(--color-accent-text) !important; }
        [data-theme="dark"] .main-nav a.active { color: #fff !important; }

        .main-nav a .status-indicator { width: 8px; height: 8px; border-radius: 50%; background-color: currentColor; opacity: 0.6; transition: all var(--transition-med); }
        .main-nav a.active .status-indicator { opacity: 1; }
        .main-nav a .status-indicator.running { background-color: var(--color-success); opacity: 1; animation: pulse-small 2s infinite; }
        .main-nav a .status-indicator.stopped { background-color: var(--color-danger); opacity: 1; }
        @keyframes pulse-small { 0%, 100% { box-shadow: 0 0 0 0 color-mix(in srgb, var(--color-success) 40%, transparent); } 70% { box-shadow: 0 0 0 5px transparent; } }
        
        .refresh-btn { display: flex; align-items: center; justify-content: center; width: 48px; height: 48px; border-radius: var(--border-radius-md); background-color: var(--color-bg-alt); color: var(--color-text-secondary); border: 1px solid var(--color-border); cursor: pointer; transition: all var(--transition-fast); flex-shrink: 0; }
        .refresh-btn:hover:not(:disabled):not([aria-busy="true"]) { color: var(--color-accent-primary); border-color: var(--color-accent-primary); transform: translateY(-2px); box-shadow: var(--shadow-sm); }
        .refresh-btn:hover:not(:disabled):not([aria-busy="true"]) svg { transform: rotate(45deg); }
        .refresh-btn[aria-busy="true"] { cursor: wait; pointer-events: none; }
        .refresh-btn[aria-busy="true"] svg { animation: spin 1s linear infinite; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .stat-card { padding: 1.5rem; border-radius: var(--border-radius-xl); position: relative; overflow: hidden; color: var(--color-accent-text); box-shadow: var(--shadow-lg); transition: transform var(--transition-med), box-shadow var(--transition-med); background-size: cover; background-position: center; }
        .icon-bg-pattern { position: absolute; inset: 0; opacity: 0.1; }
        .stat-card.default-gradient-1 { background: linear-gradient(135deg, #3b82f6, #8b5cf6); }
        .stat-card.theme-gradient { background: linear-gradient(135deg, var(--color-accent-primary) 0%, var(--color-accent-secondary) 100%); }
        .stat-card:hover { transform: translateY(-6px) scale(1.02); box-shadow: 0 15px 30px -10px color-mix(in srgb, var(--color-accent-primary) 30%, black); }
        .stat-card-content { display: flex; flex-direction: column; height: 100%; }
        .stat-card h3 { color: var(--color-accent-text); opacity: 0.8; text-transform: none; font-size: 1rem; font-weight: 500; display: flex; align-items: center; gap: 0.75rem;}
        .stat-card-main { display: flex; align-items: flex-end; gap: 0.75rem; margin-top: 0.75rem; flex-grow: 1; }
        .stat-card .value { font-size: 2.75rem; font-weight: 800; line-height: 1; }
        .stat-change { font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; border-radius: 99px; background-color: rgba(255, 255, 255, 0.15); margin-bottom: 0.2rem; }
        .stat-change.up { color: #bef264; } .stat-change.down { color: #fca5a5; }
        .stat-change svg { width: 1.1em; height: 1.1em; }
        .sparkline-container { position: relative; margin-top: auto; height: 50px; }
        .sparkline-path { stroke: var(--color-accent-primary); stroke-width: 2.0; fill: url(#sparkline-gradient); fill-opacity: 0.15; stroke-linecap: round; stroke-linejoin: round; }
        [data-theme="light"] .sparkline-path, [data-theme="dark"] .sparkline-path { stroke: var(--color-accent-text); }
        #sparkline-gradient stop { stop-color: var(--color-accent-primary); }
        [data-theme="light"] #sparkline-gradient stop, [data-theme="dark"] #sparkline-gradient stop { stop-color: var(--color-accent-text); }

        .card { background-color: var(--color-bg-card); border: 1px solid var(--color-border); border-radius: var(--border-radius-xl); box-shadow: var(--shadow-sm); transition: var(--transition-fast); position: relative; }
        .card::before { content: ""; position: absolute; inset: 0; border-radius: inherit; border: 1px solid transparent; background: radial-gradient(400px circle at var(--glow-x, 50%) var(--glow-y, 50%), var(--glow-color), transparent 40%); opacity: 0; transition: opacity 0.3s ease-out; pointer-events: none; z-index: 0; }
        .card:hover::before { opacity: 1; }
        .card:hover { border-color: var(--glow-border-color); }
        .card > * { position: relative; z-index: 1; }
        .card-header { padding: 1.25rem 1.75rem; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; background: linear-gradient(to right, color-mix(in srgb, var(--color-bg-alt) 50%, transparent), transparent); }
        .card-body { padding: 1.75rem; }
        .card-body.no-padding { padding: 0; }
        
        .card-header .header-actions { display: flex; gap: 0.75rem; align-items: center; }

        .control-item { display: flex; align-items: center; gap: 1rem; font-size: 1rem; flex-wrap: wrap; }
        .control-item strong { color: var(--color-text-primary); font-weight: 500; flex-shrink: 0;}
        .control-item > div, .control-item > form, .control-item > button, .control-item > select { margin-left: auto; }
        .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.5rem; }
        #capacity-form { display: grid; grid-template-columns: 1fr auto; gap: 1rem; }
        
        .auto-refresh-form { display: flex; align-items: center; gap: 1rem; }
        .auto-refresh-form input[type="number"] { width: 80px; text-align: center; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; vertical-align: middle;}
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--color-border); transition: var(--transition-fast); border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: var(--transition-fast); border-radius: 50%; }
        input:checked + .slider { background-color: var(--color-accent-primary); }
        input:checked + .slider:before { transform: translateX(22px); }
        
        .color-palette { display: flex; gap: 0.5rem; }
        .color-swatch { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: var(--transition-fast); }
        .color-swatch:hover { transform: scale(1.15); }
        .color-swatch.active { border-color: var(--color-accent-primary); }

        #theme-switcher-select { max-width: 200px; }

        .button { display: inline-flex; align-items: center; justify-content: center; gap: 0.6rem; padding: 0.75rem 1.5rem; font-size: 0.95rem; font-weight: 600; border-radius: var(--border-radius-sm); border: 1px solid transparent; cursor: pointer; white-space: nowrap; box-shadow: 0 1px 2px rgba(0,0,0,0.05), inset 0 1px 0 rgba(255,255,255,0.05); transition: all var(--transition-fast); }
        .button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .button:active:not(:disabled) { transform: translateY(0); box-shadow: var(--shadow-sm); }
        .button.primary { background-color: var(--color-accent-primary); color: var(--color-accent-text); border-color: var(--color-accent-primary); }
        .button.primary:hover:not(:disabled) { background-color: var(--color-accent-primary-hover); border-color: var(--color-accent-primary-hover); }
        [data-theme="dark"] .button.primary { color: #fff; }
        .button.secondary { background-color: var(--color-bg-card); color: var(--color-text-primary); border-color: var(--color-border); }
        .button.secondary:hover:not(:disabled) { border-color: var(--color-accent-primary); color: var(--color-accent-primary); }
        .button.danger { background-color: var(--color-danger); color: #fff; }
        .button.danger:hover:not(:disabled) { background-color: var(--color-danger-hover); }
        .button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .button svg { width: 1.2em; height: 1.2em; }
        
        input[type="search"], input[type="text"], input[type="number"], input[type="url"], select { 
            width: 100%; padding: 0.8rem 1.2rem; font-size: 1rem; background-color: var(--color-bg-alt); border: 1px solid var(--color-border); border-radius: var(--border-radius-sm); color: var(--color-text-primary); transition: var(--transition-fast); font-family: var(--font-family-sans); -webkit-appearance: none; -moz-appearance: none; appearance: none;
        }
        select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 16px 12px; padding-right: 2.5rem; }
        [data-theme="dark"] select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23c9d1d9' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e"); }
        input:focus, select:focus { outline: none; border-color: var(--color-accent-primary); box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-accent-primary) 25%, transparent); }
        
        #search-results-info { color: var(--color-text-secondary); font-size: 0.9rem; margin-bottom: 1rem; height: 1.2em; transition: opacity 0.3s; }

        .overview-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 2rem; margin-top: 2.5rem; }

        .scrollable-table-container { max-height: 400px; overflow-y: auto; position: relative; }
        .overview-grid .scrollable-table-container { max-height: 300px; }
        #log-query-table-container { max-height: calc(100vh - 380px); min-height: 200px; }
        #adguard-table-container, #diversion-table-container { max-height: calc(100vh - 350px); min-height: 300px; }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.95rem; table-layout: fixed; }
        th, td { padding: 0.8rem 1.25rem; text-align: left; border-bottom: 1px solid var(--color-border); transition: background-color var(--transition-fast); word-break: break-word; vertical-align: middle;}
        thead th { background-color: var(--color-bg-alt); font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: var(--color-text-secondary); }
        .scrollable-table-container thead th { position: sticky; top: 0; z-index: 2; }
        .scrollable-table-container thead { transition: padding-right 0.2s ease-in-out; }
        
        .domain-response-cell { display: flex; flex-direction: column; gap: 0.25rem; }
        .domain-response-cell .domain-name { font-weight: 500; }
        .response-meta { display: flex; align-items: center; gap: 0.75rem; color: var(--color-text-secondary); }
        .response-summary { flex-shrink: 1; }

        th[data-sortable] { cursor: pointer; }
        th[data-sortable]:hover { color: var(--color-text-primary); }
        .sort-indicator { display: inline-block; width: 1em; text-align: center; opacity: 0.5; }
        th.sorted .sort-indicator { opacity: 1; }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr:nth-child(even) { background-color: var(--color-bg-alt); }
        tbody tr:hover { background-color: color-mix(in srgb, var(--color-accent-primary) 8%, transparent); transform: scale(1.01); box-shadow: var(--shadow-sm); z-index: 1; position: relative; }
        
        .truncate-text { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        tbody td a.clickable-link { position: relative; text-decoration: none; }
        tbody td a.clickable-link::after { content: ''; position: absolute; width: 0; height: 1px; bottom: -3px; left: 50%; transform: translateX(-50%); background-color: var(--color-accent-primary); transition: width var(--transition-fast); }
        tbody td a.clickable-link:hover::after { width: 100%; }

        tbody tr[data-log-index], tbody tr[data-rank-index], tbody tr[data-rule-id] { cursor: help; }
        .touch tbody tr[data-log-index], .touch tbody tr[data-rank-index], .touch [data-rule-id] { cursor: pointer; }

        .empty-state-row td { text-align: center !important; padding: 3rem 1.5rem !important; white-space: normal !important; }
        .empty-state-content { display: flex; flex-direction: column; align-items: center; gap: 1rem; color: var(--color-text-secondary); }
        .empty-state-content svg { width: 48px; height: 48px; opacity: 0.5; }
        .empty-state-content strong { color: var(--color-text-primary); font-size: 1.1rem; }
        .empty-state-content .button { margin-top: 0.5rem; } 

        .tab-content { display: none; margin-top: 2.5rem; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .client-alias { font-weight: 600; }
        
        .response-tag, .rule-tag { padding: 0.2rem 0.6rem; font-size: 0.8rem; border-radius: var(--border-radius-sm); white-space: nowrap; display: inline-flex; align-items: center; }
        .response-tag { font-weight: 700; }
        .response-tag.noerror { background-color: color-mix(in srgb, var(--color-success) 20%, transparent); color: var(--color-success); }
        .response-tag.nxdomain { background-color: color-mix(in srgb, var(--color-warning) 20%, transparent); color: var(--color-warning); }
        .response-tag.servfail { background-color: color-mix(in srgb, var(--color-danger) 20%, transparent); color: var(--color-danger); }
        .response-tag.refused { background-color: color-mix(in srgb, var(--color-danger) 25%, transparent); color: var(--color-danger); }
        .response-tag.other { background-color: var(--color-border); color: var(--color-text-secondary); }

        .rule-tag { font-weight: 600; gap: 0.4rem; max-width: 150px; overflow: hidden; text-overflow: ellipsis; flex-shrink: 0; }
        .rule-tag::before { content: ''; width: 8px; height: 8px; border-radius: 50%; background-color: currentcolor; flex-shrink: 0; }

        #answers-tooltip { visibility: hidden; opacity: 0; position: fixed; padding: 0.75rem 1rem; border-radius: var(--border-radius-md); background: var(--color-bg-alt); border: 1px solid var(--color-border); box-shadow: var(--shadow-lg); width: max-content; max-width: calc(100vw - 20px); z-index: 9999; transition: opacity 0.2s, visibility 0.2s, transform 0.2s; text-align: left; pointer-events: none; font-size: 0.9rem; transform: translateY(10px); } 
        #answers-tooltip.visible { visibility: visible; opacity: 1; transform: translateY(0); pointer-events: auto; }
        #answers-tooltip h5 { margin: 0 0 0.75rem 0; font-size: 0.8rem; color: var(--color-text-secondary); text-transform: uppercase; letter-spacing: 0.8px; border-bottom: 1px solid var(--color-border); padding-bottom: 0.5rem; } 
        #answers-tooltip ul { margin: 0; padding: 0; list-style-type: none; display: flex; flex-direction: column; gap: 0.4rem; } 
        #answers-tooltip li { font-family: var(--font-family-mono); white-space: normal; word-break: break-all; display: flex; align-items: center; justify-content: space-between; gap: 1rem;} 
        #answers-tooltip li > strong { font-family: var(--font-family-sans); flex-shrink: 0; }
        #answers-tooltip small { font-size: 0.85em; opacity: 0.8; } 
        .copy-btn { background: none; border: none; cursor: pointer; color: var(--color-text-secondary); padding: 2px; border-radius: 4px; display: inline-flex; vertical-align: middle; transition: var(--transition-fast); }
        .copy-btn:hover { color: var(--color-accent-primary); background-color: var(--color-border); }

        #toast { position: fixed; top: 20px; right: 20px; display: flex; align-items: center; gap: 0.75rem; padding: 1rem 1.5rem; border-radius: var(--border-radius-sm); z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); transform: translateY(-20px) scale(0.95); box-shadow: var(--shadow-lg); color: var(--color-accent-text); font-weight: 500; } 
        #toast.show { opacity: 1; visibility: visible; transform: translateY(0) scale(1); } 
        #toast.success { background-color: var(--color-success); } 
        #toast.error { background-color: var(--color-danger); }
        #toast svg { width: 1.25em; height: 1.25em; }

        dialog { border: 1px solid var(--color-border); border-radius: var(--border-radius-xl); box-shadow: var(--shadow-lg); padding: 0; max-width: 600px; width: 90%; background-color: var(--color-bg-card); color: var(--color-text-primary); overflow: visible; } 
        dialog::backdrop { background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); } 
        dialog[open] { animation: modal-fade-in 0.4s cubic-bezier(0.25, 0.8, 0.25, 1) forwards; }
        dialog[open]::before { content: ""; position: absolute; inset: -1px; border-radius: inherit; border: 2px solid var(--glow-border-color); animation: modal-glow-pulse 2.5s ease-out forwards; pointer-events: none; z-index: -1; }
        @keyframes modal-fade-in { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes modal-glow-pulse { 0% { opacity: 0.8; } 100% { opacity: 0; } }

        dialog.card:hover::before { opacity: 0 !important; }
        dialog.card:hover { border-color: var(--color-border) !important; }
        
        .modal-header { padding: 1.25rem 1.75rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--color-border); } 
        .modal-body { padding: 1.75rem; max-height: 60vh; overflow-y: auto; scrollbar-gutter: stable; } 
        .modal-footer { padding: 1.25rem 1.75rem; border-top: 1px solid var(--color-border); display: flex; justify-content: space-between; gap: 0.75rem; background-color: var(--color-bg-alt); border-bottom-left-radius: var(--border-radius-xl); border-bottom-right-radius: var(--border-radius-xl); } 
        .modal-footer .footer-actions-right { display: flex; gap: 0.75rem; margin-left: auto; }
        
        .alias-item { display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; align-items: center; padding: 0.75rem; border-radius: var(--border-radius-sm); } 
        .alias-item:nth-child(even) { background-color: var(--color-bg-alt); }
        #manual-alias-form { padding: 1.25rem; background: var(--color-bg-alt); border-radius: var(--border-radius-md); margin-bottom: 1.5rem; display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: center; border: 1px solid var(--color-border); }
        
        #initial-loader { position: fixed; inset: 0; background: var(--color-bg); display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s; }
        #log-loader { text-align: center; padding: 2rem; display: none; }
        .spinner { display: inline-block; width: 2.5rem; height: 2.5rem; border: 4px solid var(--color-border); border-top-color: var(--color-accent-primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .control-panel-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .control-module { background-color: var(--color-bg-card); border: 1px solid var(--color-border); border-radius: var(--border-radius-xl); padding: 1.5rem; display: flex; flex-direction: column; gap: 1.25rem; }
        .control-module h3 { font-size: 1rem; font-weight: 600; color: var(--color-text-primary); text-transform: none; letter-spacing: 0; padding-bottom: 0.75rem; border-bottom: 1px solid var(--color-border); margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.6rem; }
        .control-module h3 svg { width: 1.1em; height: 1.1em; color: var(--color-accent-primary); opacity: 0.8; }
        .form-field { margin-bottom: 1.25rem; }
        .form-field label { display: block; font-weight: 500; margin-bottom: 0.5rem; }
        
        .rule-card { background-color: var(--color-bg-card); border: 1px solid var(--color-border); border-radius: var(--border-radius-md); padding: 1rem; margin-bottom: 0.75rem; box-shadow: var(--shadow-sm); display: grid; grid-template-columns: auto 1fr; grid-template-rows: auto auto auto; grid-template-areas: "toggle name" "meta meta" "actions actions"; gap: 0.5rem 1rem; align-items: center; }
        .rule-card-toggle { grid-area: toggle; }
        .rule-card-name { grid-area: name; font-weight: 600; word-break: break-all; }
        .rule-card-meta { grid-area: meta; font-size: 0.85rem; color: var(--color-text-secondary); padding-top: 0.75rem; margin-top: 0.75rem; border-top: 1px solid var(--color-border); display: flex; flex-wrap: wrap; gap: 0.5rem 1.5rem; align-items: center; }
        .rule-card-meta .url { flex-basis: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .rule-card-actions { grid-area: actions; display: flex; gap: 0.75rem; margin-top: 0.5rem; }
        .rule-card-actions .button { flex-grow: 1; padding: 0.6rem 1rem; }
        
        .sub-nav { display: flex; border-bottom: 1px solid var(--color-border); margin: 0 1.75rem 1.5rem; }
        .sub-nav-link { padding: 0.75rem 1.25rem; margin-bottom: -1px; border: 1px solid transparent; color: var(--color-text-secondary); font-weight: 600; cursor: pointer; transition: var(--transition-fast); }
        .sub-nav-link.active { color: var(--color-accent-primary); border-color: var(--color-border); border-bottom-color: var(--color-bg-card); border-top-left-radius: var(--border-radius-sm); border-top-right-radius: var(--border-radius-sm); }
        .sub-tab-content { display: none; }
        .sub-tab-content.active { display: block; }
        .rules-card .card-header { border-bottom: none; }
        .rule-actions-wrapper { display: flex; justify-content: flex-end; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap; }

        /* Skeleton Loader */
        .skeleton { opacity: 0.7; animation: skeleton-loading 1.5s linear infinite alternate; }
        .skeleton-row td > div { background-color: var(--color-bg-alt); border-radius: var(--border-radius-sm); height: 20px; }
        .skeleton-row td:first-child > div { width: 60%; }
        .skeleton-row td:nth-child(2) > div { width: 90%; }
        .skeleton-row td:nth-child(3) > div { width: 30%; }
        @keyframes skeleton-loading { from { background-color: var(--color-bg-alt); } to { background-color: color-mix(in srgb, var(--color-bg-alt) 60%, var(--color-border)); } }

        /* Donut Chart */
        .donut-chart-wrapper { display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 3rem; }
        .donut-chart { position: relative; width: 160px; height: 160px; flex-shrink: 0; }
        .donut-chart svg { transform: rotate(-90deg); }
        .donut-chart-center-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .donut-chart-center-text .total { font-size: 1.6rem; font-weight: 700; }
        .donut-chart-center-text .label { font-size: 0.85rem; color: var(--color-text-secondary); }
        .donut-legend { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 0.8rem; flex-basis: 220px; flex-grow: 1; }
        .donut-legend-item { display: flex; align-items: center; font-size: 1rem; }
        .legend-color-box { width: 14px; height: 14px; border-radius: 4px; margin-right: 0.75rem; flex-shrink: 0; }
        .legend-label { color: var(--color-text-secondary); flex-grow: 1; margin-right: 1rem; }
        .legend-value { font-weight: 600; white-space: nowrap; }

        @media (max-width: 992px) {
            .page-header { justify-content: center; gap: 0.75rem; }
            h1 { flex-basis: 100%; text-align: center; margin-bottom: 0.5rem; }
            .header-main-actions { order: 1; flex-grow: 1; justify-content: center; }
            .overview-grid { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 768px) {
            html { font-size: 15px; } 
            .container { padding: 1.5rem 1rem 4rem; }
            h1 { font-size: 1.8rem; }
            .card-header { padding: 1rem 1.25rem; }
            .card-body { padding: 1.25rem; }
            .card-body.no-padding { padding: 0; }
            .hide-on-mobile { display: none !important; }
            .show-on-mobile { display: block !important; }

            .mobile-card-layout thead, .mobile-rule-card-layout thead { display: none; }
            .mobile-card-layout, .mobile-card-layout tbody, .mobile-rule-card-layout, .mobile-rule-card-layout tbody { display: block; }
            .mobile-card-layout tr { display: block; background-color: var(--color-bg-card); padding: 1rem; border-radius: var(--border-radius-md); margin-bottom: 0.75rem; border: 1px solid var(--color-border); box-shadow: var(--shadow-sm); }
            .mobile-card-layout td { display: block; border: none; padding: 0; }
            .mobile-card-layout tr:nth-child(even) { background-color: var(--color-bg-card); }
            
            .mobile-log-row { display: grid; grid-template-columns: 1fr auto; grid-template-areas: "domain time" "meta meta"; gap: 0.25rem 1rem; font-size: 0.9rem; }
            .mobile-log-row .domain { grid-area: domain; font-weight: 600; color: var(--color-text-primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; align-self: center;}
            .mobile-log-row .time { grid-area: time; text-align: right; color: var(--color-text-secondary); font-size: 0.8rem; align-self: center; }
            .mobile-log-row .meta { grid-area: meta; display: flex; align-items: center; flex-wrap: wrap; gap: 0.5rem 1rem; color: var(--color-text-secondary); font-size: 0.85rem; padding-top: 0.5rem; margin-top: 0.5rem; border-top: 1px solid var(--color-border);}
            .mobile-log-row .meta .client { max-width: 15ch; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
            .mobile-log-row .meta .duration { font-weight: 500; }

            .mobile-compact-table th:not(:first-child), .mobile-compact-table td:not(:first-child) { display: none; }
            .mobile-compact-table th:first-child, .mobile-compact-table td:first-child { width: 100%; }

            #log-query-table-container, .rules-card .sub-tab-content { padding: 0.75rem; background-color: var(--color-bg-alt); border-radius: var(--border-radius-md); }
            .rules-card .sub-nav { margin: 0 1.25rem 1.5rem; }
            .rules-card .card-body { padding: 0; }
            #adguard-table-container, #diversion-table-container { max-height: calc(100vh - 400px); padding: 0; background: none; }
            
            .control-panel-grid { grid-template-columns: 1fr; gap: 1.5rem; }
            .control-module { padding: 1.25rem; }
            .control-item { flex-direction: column; align-items: flex-start; gap: 0.75rem; }
            .control-item > div, .control-item > form, .control-item > button, .control-item > select { margin-left: 0; width: 100%; }
            .button-group, #capacity-form { grid-template-columns: 1fr; gap: 0.75rem; }
            .auto-refresh-form { flex-direction: row; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; }
            #manual-alias-form { grid-template-columns: 1fr; }
            .alias-item { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 576px) {
            .donut-chart-wrapper { flex-direction: column; gap: 1.5rem; }
            .donut-legend { width: 100%; max-width: 320px; }
        }

        @media (max-width: 480px) {
            .alias-item { text-align: center; }
            .alias-item input { text-align: center; }
            .rule-actions-wrapper { justify-content: center; }
        }
        
        /* --- Theme: Sakura Night --- */
        [data-theme="sakura"] { --color-bg: #191724; --color-bg-card: rgba(31, 29, 46, 0.6); --color-bg-alt: rgba(31, 29, 46, 0.8); --color-text-primary: #e0def4; --color-text-secondary: #908caa; --color-border: #eb6f92; --color-accent-primary: #eb6f92; --color-accent-primary-hover: #f4abc4; --color-accent-text: #191724; --glow-color: rgba(235, 111, 146, 0.2); --glow-border-color: #f4abc4; --color-success: #9ccfd8; --color-danger: #eb6f92; --color-warning: #f6c177; }
        @keyframes bg-pan { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        [data-theme="sakura"] body { background: linear-gradient(170deg, #191724 0%, #21202e 50%, #393552 100%); background-size: 200% 200%; animation: bg-pan 30s ease infinite; background-attachment: fixed; }
        [data-theme="sakura"] .card, [data-theme="sakura"] .main-nav, [data-theme="sakura"] dialog { backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-color: rgba(235, 111, 146, 0.3); background-color: var(--color-bg-card); }
        [data-theme="sakura"] .card { box-shadow: var(--shadow-md), inset 0 0 0 1px rgba(235, 111, 146, 0.2); }
        [data-theme="sakura"] .stat-card { background: rgba(31, 29, 46, 0.7); border: 1px solid rgba(235, 111, 146, 0.5); color: #e0def4; }
        [data-theme="sakura"] .stat-card h3 { color: #e0def4; }
        [data-theme="sakura"] h1, [data-theme="sakura"] .stat-card .value { text-shadow: 0 0 10px rgba(235, 111, 146, 0.8), 0 0 4px rgba(255,255,255,0.5); }
        [data-theme="sakura"] .main-nav-slider { background: rgba(235, 111, 146, 0.8); }
        @keyframes sakura-fall { 0% { transform: translateY(110vh) translateX(-10vw) rotate(0deg); opacity: 1; } 100% { transform: translateY(-10vh) translateX(10vw) rotate(720deg); opacity: 0; } }
        [data-theme="sakura"] main::before, [data-theme="sakura"] main::after { content: 'üå∏'; position: fixed; bottom: -50px; color: #f4abc4; font-size: 1rem; z-index: 0; pointer-events: none; animation: sakura-fall 15s linear infinite; animation-direction: reverse; }
        [data-theme="sakura"] main::before { left: 10%; animation-delay: 0s; }
        [data-theme="sakura"] main::after { left: 30%; animation-delay: -5s; content: 'üíÆ'; font-size: 1.5rem; }

        /* --- Theme: Evergreen --- */
        [data-theme="evergreen"] { --color-bg: #1a2e26; --color-bg-card: rgba(20, 38, 31, 0.7); --color-bg-alt: rgba(14, 27, 22, 0.8); --color-text-primary: #e2e8f0; --color-text-secondary: #94a3b8; --color-border: #4ade80; --color-accent-primary: #4ade80; --color-accent-primary-hover: #86efac; --color-accent-text: #064e3b; --glow-color: rgba(74, 222, 128, 0.15); --glow-border-color: #86efac; --color-success: #4ade80; --color-danger: #f87171; --color-warning: #fbbf24; }
        [data-theme="evergreen"] body { background: #1a2e26 url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3E%3Cg fill-rule="evenodd"%3E%3Cg fill="%232c5d4c" fill-opacity="0.2"%3E%3Cpath opacity=".5" d="M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4H1v-4H0v-1h1v-9H0v-1h1v-9H0v-1h1v-9H0v-1h1v-9H0v-1h1v-9H0v-1h1v-9H0v-1h1v-9H0v-1h1V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4z"/%3E%3Cpath d="M6 6h2v2H6V6zm2-2h2v2H8V4zM4 2h2v2H4V2zM2 4h2v2H2V4z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E'); }
        [data-theme="evergreen"] .card, [data-theme="evergreen"] dialog { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); box-shadow: inset 0 0 0 1px rgba(74, 222, 128, 0.2); }
        [data-theme="evergreen"] .stat-card { background: var(--color-bg-card); color: var(--color-text-primary); border: 1px solid rgba(74, 222, 128, 0.4); }
        [data-theme="evergreen"] .stat-card h3 { color: var(--color-text-primary); }

        /* --- Theme: Starlight --- */
        [data-theme="starlight"] { --color-bg: #000; --color-bg-card: rgba(10, 10, 25, 0.6); --color-bg-alt: rgba(10, 10, 25, 0.8); --color-text-primary: #d1d5db; --color-text-secondary: #6b7280; --color-border: #3b82f6; --color-accent-primary: #3b82f6; --color-accent-primary-hover: #60a5fa; --color-accent-text: #fff; --glow-color: rgba(59, 130, 246, 0.2); --glow-border-color: #60a5fa; --color-success: #34d399; --color-danger: #f87171; --color-warning: #f59e0b; }
        [data-theme="starlight"] body { background: #000 url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 800"%3E%3Ccircle fill="%23fff" fill-opacity="0.8" cx="200" cy="200" r="1"/%3E%3Ccircle fill="%23fff" fill-opacity="0.8" cx="600" cy="600" r="1.5"/%3E%3Ccircle fill="%23fff" fill-opacity="0.8" cx="400" cy="500" r="0.5"/%3E%3Ccircle fill="%23fff" fill-opacity="0.8" cx="100" cy="50" r="0.5"/%3E%3Ccircle fill="%23fff" fill-opacity="0.8" cx="700" cy="100" r="1"/%3E%3Ccircle fill="%23fff" fill-opacity="0.8" cx="50" cy="700" r="0.5"/%3E%3Ccircle fill="%23fff" fill-opacity="0.8" cx="300" cy="50" r="1"/%3E%3Ccircle fill="%23fff" fill-opacity="0.8" cx="550" cy="300" r="2"/%3E%3C/svg%3E'); animation: starlight-drift 40s infinite linear; }
        @keyframes starlight-drift { from { background-position: 0 0; } to { background-position: -400px 200px; } }
        @keyframes twinkle-star { 0%, 100% { opacity: 0.1; } 50% { opacity: 0.8; } }
        [data-theme="starlight"] main::after { content: '‚úß'; position: fixed; color: #fff; z-index: 0; pointer-events: none; animation: twinkle-star 5s infinite; top: 20%; left: 10%; font-size: 0.5rem;}
        [data-theme="starlight"] main::before { content: '‚ú¶'; position: fixed; color: #fff; z-index: 0; pointer-events: none; animation: twinkle-star 7s infinite; top: 60%; right: 15%; animation-delay: -2s; font-size: 0.8rem;}
        [data-theme="starlight"] .card, [data-theme="starlight"] .main-nav, [data-theme="starlight"] dialog { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        [data-theme="starlight"] .stat-card { background: var(--color-bg-card); color: var(--color-text-primary); border-color: var(--color-border); }
        [data-theme="starlight"] .stat-card h3, [data-theme="starlight"] h1 { color: #fff; }
        [data-theme="starlight"] .stat-card .value { text-shadow: 0 0 5px var(--color-accent-primary); }

        /* --- Theme: Dusk --- */
        [data-theme="dusk"] { --color-bg: #232526; --color-bg-card: rgba(20, 20, 20, 0.5); --color-bg-alt: rgba(10, 10, 10, 0.7); --color-text-primary: #F2F2F2; --color-text-secondary: #A9A9A9; --color-border: #FF8C00; --color-accent-primary: #FF8C00; --color-accent-primary-hover: #FFA500; --color-accent-text: #000; --glow-color: rgba(255, 140, 0, 0.2); --glow-border-color: #FFA500; --color-success: #98FB98; --color-danger: #F08080; --color-warning: #FFD700; }
        @keyframes dusk-gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        [data-theme="dusk"] body { background: linear-gradient(-45deg, #434343, #232526, #2c3e50, #fd746c); background-size: 400% 400%; animation: dusk-gradient 20s ease infinite; background-attachment: fixed; }
        [data-theme="dusk"] .card, [data-theme="dusk"] .main-nav, [data-theme="dusk"] dialog { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-color: rgba(255, 140, 0, 0.3); }
        [data-theme="dusk"] .stat-card { background: var(--color-bg-card); color: var(--color-text-primary); }
        [data-theme="dusk"] .stat-card h3 { color: var(--color-text-primary); }
        [data-theme="dusk"] .main-nav a.active { color: var(--color-accent-text) !important; }
        
        /* --- Theme: Terra --- */
        [data-theme="terra"] { --color-bg: #4a2a22; --color-bg-card: rgba(45, 30, 26, 0.6); --color-bg-alt: rgba(30, 20, 17, 0.7); --color-text-primary: #f2e9e4; --color-text-secondary: #a99985; --color-border: #ff8c42; --color-accent-primary: #ff8c42; --color-accent-primary-hover: #ffac70; --color-accent-text: #2d1e1a; --glow-color: rgba(255, 140, 66, 0.2); --glow-border-color: #ffac70; --color-success: #a7c957; --color-danger: #e56b6f; --color-warning: #ffb703; }
        [data-theme="terra"] body { background: #4a2a22 url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%236b4235" fill-opacity="0.2"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E'); }
        [data-theme="terra"] .card, [data-theme="terra"] .main-nav, [data-theme="terra"] dialog { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); box-shadow: inset 0 0 0 1px rgba(255, 140, 66, 0.2); border-color: rgba(255, 140, 66, 0.3); }
        [data-theme="terra"] .stat-card { background: var(--color-bg-card); color: var(--color-text-primary); border: 1px solid rgba(255, 140, 66, 0.4); }
        [data-theme="terra"] .stat-card h3 { color: var(--color-text-primary); }
        [data-theme="terra"] .main-nav a.active { color: var(--color-accent-text) !important; }

    </style>
</head><body>
    <div id="initial-loader"><div class="spinner"></div></div>
    <div id="answers-tooltip"></div>

    <main class="container">
        <header class="page-header">
            <h1>Mosdns ‰ª™Ë°®Áõò</h1>
            <div class="header-main-actions">
                <div class="nav-wrapper">
                    <nav class="main-nav">
                        <div class="main-nav-slider"></div>
                        <a href="#overview" class="tab-link active" data-tab="overview" role="tab">Ê¶ÇËßà</a>
                        <a href="#log-query" class="tab-link" data-tab="log-query" role="tab">Êü•ËØ¢Êó•Âøó</a>
                        <a href="#rules" class="tab-link" data-tab="rules" role="tab">ËßÑÂàôÁÆ°ÁêÜ</a>
                        <a href="#system-control" class="tab-link" data-tab="system-control" role="tab">
                            <span class="status-indicator"></span>
                            <span>Á≥ªÁªü</span>
                        </a>
                    </nav>
                </div>
                <span id="last-updated" class="last-updated"></span>
                <button id="global-refresh-btn" class="refresh-btn" title="Âà∑Êñ∞Êï∞ÊçÆ" aria-label="Âà∑Êñ∞Êï∞ÊçÆ" aria-busy="false">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
                </button>
            </div>
        </header>

        <div id="toast" role="status" aria-live="polite"></div>

        <dialog id="alias-modal" class="card">
            <header class="modal-header">
                <h2>ÁÆ°ÁêÜÂÆ¢Êà∑Á´ØÂà´Âêç</h2>
                <button class="button secondary" id="close-alias-modal" aria-label="Close" style="min-width:auto; padding:0.3rem 0.5rem;">‚úï</button>
            </header>
            <div class="modal-body">
                <form id="manual-alias-form">
                    <input type="text" id="manual-alias-ip" placeholder="ËæìÂÖ• IP Âú∞ÂùÄ" required>
                    <input type="text" id="manual-alias-name" placeholder="ËæìÂÖ•Âà´Âêç" required>
                    <button type="submit" class="button primary"><span>Ê∑ªÂä†</span></button>
                </form>
                <p>‰∏∫ÂÆ¢Êà∑Á´Ø IP ËÆæÁΩÆÂà´ÂêçÔºåÊñπ‰æøÂú®Êó•Âøó‰∏≠Âø´ÈÄüËØÜÂà´„ÄÇ‰∏ãÈù¢ÊòØÊúÄËøëÊ¥ªË∑ÉÁöÑÂÆ¢Êà∑Á´ØÔºö</p>
                <div id="alias-list-container"></div>
            </div>
            <footer class="modal-footer">
                <div class="footer-actions-left">
                     <button id="import-aliases-btn" class="button secondary"><span>ÂØºÂÖ•</span></button>
                     <button id="export-aliases-btn" class="button secondary"><span>ÂØºÂá∫</span></button>
                </div>
                <div class="footer-actions-right">
                     <button id="save-all-aliases-btn" class="button primary"><span>ÂÖ®ÈÉ®‰øùÂ≠ò</span></button>
                </div>
            </footer>
        </dialog>
        <input type="file" id="import-alias-file-input" accept=".json" style="display: none;">
        
        <dialog id="rule-modal" class="card">
            <header class="modal-header">
                <h2 id="modal-title">Ê∑ªÂä†ËßÑÂàô</h2>
                <button class="button secondary" id="close-rule-modal" aria-label="Close" style="min-width:auto; padding:0.3rem 0.5rem;">‚úï</button>
            </header>
            <form id="rule-form">
                <div class="modal-body">
                    <input type="hidden" id="rule-id" name="id">
                    <input type="hidden" id="rule-mode" name="mode"> <!-- Áî®‰∫éÂå∫ÂàÜ adguard/diversion -->
                    <div class="form-field" id="rule-type-wrapper" style="display: none;">
                        <label for="rule-type">Á±ªÂûã</label>
                        <select id="rule-type" name="type" required>
                            <option value="" disabled selected>ËØ∑ÈÄâÊã©Á±ªÂûã</option>
                            <option value="geositecn">geositecn</option>
                            <option value="geositenocn">geositenocn</option>
                            <option value="geoipcn">geoipcn</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="rule-name">ÂêçÁß∞</label>
                        <input type="text" id="rule-name" name="name" placeholder="‰æãÂ¶ÇÔºöMy Custom Rules" required>
                    </div>
                    <div class="form-field" id="rule-files-wrapper" style="display: none;">
                        <label for="rule-files">Êú¨Âú∞Êñá‰ª∂Ë∑ØÂæÑ</label>
                        <input type="text" id="rule-files" name="files" placeholder="‰æãÂ¶Ç: /mosdns/geosite-cn.srs" required>
                    </div>
                    <div class="form-field">
                        <label for="rule-url">Ê∏ÖÂçïÁΩëÂùÄ (URL)</label>
                        <input type="url" id="rule-url" name="url" placeholder="https://example.com/rules.txt" required>
                    </div>
                    <div class="form-field control-item" style="justify-content: space-between;">
                        <strong>Ëá™Âä®Êõ¥Êñ∞</strong>
                        <label class="switch">
                            <input type="checkbox" id="rule-auto-update" name="auto_update">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="form-field">
                        <label for="rule-update-interval">Êõ¥Êñ∞Èó¥Èöî (Â∞èÊó∂)</label>
                        <input type="number" id="rule-update-interval" name="update_interval_hours" min="1" value="24" style="width: 120px;">
                    </div>
                </div>
                <footer class="modal-footer">
                    <div class="footer-actions-right">
                        <button type="button" id="cancel-rule-modal-btn" class="button secondary"><span>ÂèñÊ∂à</span></button>
                        <button type="submit" id="save-rule-btn" class="button primary" data-default-text="‰øùÂ≠ò"><span>‰øùÂ≠ò</span></button>
                    </div>
                </footer>
            </form>
        </dialog>

        <section id="overview-tab" class="tab-content active" role="tabpanel">
            <div class="stats-grid">
                <div class="stat-card default-gradient-1">
                     <svg class="icon-bg-pattern" width="100%" height="100%"><defs><pattern id="p1" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse" patternTransform="rotate(45)"><circle cx="2.5" cy="2.5" r="2.5" fill="currentColor"></circle></pattern></defs><rect width="100%" height="100%" fill="url(#p1)"></rect></svg>
                    <div class="stat-card-content">
                        <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M11.25 4.53335C11.6642 4.44457 12.0858 4.44457 12.5 4.53335C17.1524 5.54133 21 9.80443 21 14.6465C21 19.9806 16.9706 22 12 22C7.02944 22 3 19.9806 3 14.6465C3 9.80443 6.84759 5.54133 11.25 4.53335ZM12 2C6.47715 2 2 7.02165 2 14.6465C2 21.4939 6.27609 24 12 24C17.7239 24 22 21.4939 22 14.6465C22 7.02165 17.5228 2 12 2Z"></path></svg><span>ÊÄªÊü•ËØ¢Êï∞</span></h3>
                        <div class="stat-card-main">
                            <div id="total-queries" class="value">--</div>
                            <span id="total-queries-change" class="stat-change" style="visibility: hidden;"></span>
                        </div>
                        <div class="sparkline-container" id="sparkline-total"></div>
                    </div>
                </div>
                <div class="stat-card theme-gradient">
                     <svg class="icon-bg-pattern" width="100%" height="100%"><defs><pattern id="p2" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse" patternTransform="rotate(135)"><rect width="5" height="5" fill="currentColor"></rect></pattern></defs><rect width="100%" height="100%" fill="url(#p2)"></rect></svg>
                    <div class="stat-card-content">
                        <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM11 7H13V12L16.5 15.5L15.0858 16.9142L11 12.8284V7Z"></path></svg><span>Âπ≥ÂùáÂ§ÑÁêÜÊó∂Èó¥ (ms)</span></h3>
                        <div class="stat-card-main">
                            <div id="avg-duration" class="value">--</div>
                            <span id="avg-duration-change" class="stat-change" style="visibility: hidden;"></span>
                        </div>
                        <div class="sparkline-container" id="sparkline-avg"></div>
                    </div>
                </div>
            </div>
            
            <div class="overview-grid">
                <div class="card" id="top-domains-card">
                    <header class="card-header"><h2><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22ZM13 13.5V18H11V13.5C9.34315 13.5 8 12.1569 8 10.5C8 8.84315 9.34315 7.5 11 7.5V6H13V7.5C14.6569 7.5 16 8.84315 16 10.5C16 12.1569 14.6569 13.5 13 13.5Z"></path></svg>ÂüüÂêçËØ∑Ê±ÇÊéíË°å</h2></header>
                    <div class="card-body">
                        <div class="scrollable-table-container">
                            <table class="mobile-compact-table">
                                <thead><tr><th>ÂüüÂêç</th><th class="text-right hide-on-mobile">ËØ∑Ê±ÇÊï∞</th></tr></thead>
                                <tbody id="top-domains-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="card" id="top-clients-card">
                    <header class="card-header"><h2><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2ZM12 4C14.2091 4 16 5.79086 16 8C16 10.2091 14.2091 12 12 12C9.79086 12 8 10.2091 8 8C8 5.79086 9.79086 4 12 4ZM12 20C10.0576 20 8.22596 19.3433 6.74542 18.1818C8.34978 16.7383 10.1132 16 12 16C13.8868 16 15.6502 16.7383 17.2546 18.1818C15.774 19.3433 13.9424 20 12 20Z"></path></svg>ÂÆ¢Êà∑Á´ØËØ∑Ê±ÇÊéíË°å</h2></header>
                    <div class="card-body">
                        <div class="scrollable-table-container">
                            <table class="mobile-compact-table">
                                <thead><tr><th>ÂÆ¢Êà∑Á´Ø</th><th class="text-right hide-on-mobile">ËØ∑Ê±ÇÊï∞</th></tr></thead>
                                <tbody id="top-clients-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
           
                <div class="card" id="slowest-queries-card">
                    <header class="card-header"><h2><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2ZM11.1716 12.8284L15.0858 16.7426L16.5 15.3284L13.2929 12.1213C13.6834 11.5 14 10.7071 14 9.82843C14 7.87563 12.4477 6.32328 10.5 6.32328C8.55228 6.32328 7 7.87563 7 9.82843C7 11.7812 8.55228 13.3336 10.5 13.3336C10.7071 13.3336 10.95 13.1517 11.1716 12.8284Z"></path></svg>ÊúÄÊÖ¢Êü•ËØ¢</h2></header>
                    <div class="card-body">
                         <div class="scrollable-table-container">
                            <table id="slowest-queries-table" class="mobile-card-layout">
                                <thead><tr><th style="width: 50%;">ÂüüÂêç / ÂìçÂ∫î</th><th style="width: 35%;">ÂÆ¢Êà∑Á´Ø</th><th class="text-right" style="width: 15%;">ËÄóÊó∂ (ms)</th></tr></thead>
                                <tbody id="slowest-queries-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card" id="shunt-results-card">
                    <header class="card-header"><h2><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18.5 7.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0Zm-10 0a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0Zm0 10a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0ZM6 10v4a1 1 0 0 0 1 1h4.5v-1.5H7.5a.5.5 0 0 1-.5-.5v-3h7.5a2.5 2.5 0 0 0 2.5-2.5V5H8.75A4.5 4.5 0 0 0 6 7.25V10Z"></path></svg>ÂàÜÊµÅÁªìÊûúÁªüËÆ°</h2></header>
                    <div class="card-body" id="shunt-results-body">
                        <!-- Donut chart will be rendered here -->
                    </div>
                </div>
            </div>
        </section>

        <section id="log-query-tab" class="tab-content">
            <div class="card">
                <header class="card-header">
                    <h2>Êü•ËØ¢‰∏éËøáÊª§Êó•Âøó</h2>
                    <div class="header-actions hide-on-mobile">
                        <button id="manage-aliases-btn" class="button secondary"><span>ÁÆ°ÁêÜÂà´Âêç</span></button>
                    </div>
                </header>
                <div class="card-body">
                    <div style="display: flex; gap: 1rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
                         <input type="search" id="log-search" placeholder="ÂÖ®Â±ÄÊêúÁ¥¢... (‰ΩøÁî® &quot;ÂºïÂè∑&quot; Á≤æÁ°ÆÂåπÈÖç)" style="flex-grow: 1;">
                         <button id="manage-aliases-btn-mobile" class="button secondary show-on-mobile" style="display: none; flex-shrink: 0;"><span>ÁÆ°ÁêÜÂà´Âêç</span></button>
                    </div>
                    <div id="search-results-info"></div>
                    <div class="scrollable-table-container" id="log-query-table-container">
                        <table id="log-table" class="mobile-card-layout">
                            <thead id="log-table-head">
                                <tr>
                                    <th class="hide-on-mobile" data-sortable data-sort-key="query_time" style="width: 15%;">Êó∂Èó¥ <span class="sort-indicator"></span></th>
                                    <th data-sortable data-sort-key="query_name" style="width: 40%;">ÂüüÂêç / ÂìçÂ∫î <span class="sort-indicator"></span></th>
                                    <th class="hide-on-mobile" data-sortable data-sort-key="query_type" style="width: 10%;">Á±ªÂûã <span class="sort-indicator"></span></th>
                                    <th class="hide-on-mobile text-right" data-sortable data-sort-key="duration_ms" style="width: 15%;">ËÄóÊó∂(ms) <span class="sort-indicator"></span></th>
                                    <th class="hide-on-mobile" data-sortable data-sort-key="client_ip" style="width: 20%;">ÂÆ¢Êà∑Á´Ø <span class="sort-indicator"></span></th>
                                </tr>
                            </thead>
                            <tbody id="log-table-body"></tbody>
                        </table>
                        <div id="log-loader"><div class="spinner" style="width:1.5rem; height:1.5rem; border-width:3px;"></div></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="rules-tab" class="tab-content">
            <div class="card rules-card">
                 <div class="card-body no-padding">
                    <nav class="sub-nav">
                        <a class="sub-nav-link active" data-sub-tab="adguard">ÂπøÂëäÊã¶Êà™</a>
                        <a class="sub-nav-link" data-sub-tab="diversion">Âú®Á∫øÂàÜÊµÅ</a>
                    </nav>
                    <div id="adguard-sub-tab" class="sub-tab-content active" style="padding: 0 1.25rem 1.25rem;">
                        <div class="rule-actions-wrapper">
                            <button id="add-adguard-rule-btn" class="button primary">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11 11V5H13V11H19V13H13V19H11V13H5V11H11Z"></path></svg>
                                <span>Ê∑ªÂä†Êã¶Êà™ËßÑÂàô</span>
                            </button>
                            <button id="check-adguard-updates-btn" class="button secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C16.1333 2 19.536 4.30641 21.1009 7.82362L18.3294 8.76801C17.1523 6.22352 14.7951 4.5 12 4.5C7.85786 4.5 4.5 7.85786 4.5 12C4.5 16.1421 7.85786 19.5 12 19.5C15.2443 19.5 17.9739 17.4478 18.9472 14.5H16.5V12.5H22V18.5H20V15.118C18.6468 19.068 15.5849 22 12 22Z"></path></svg>
                                <span>Ê£ÄÊü•Êõ¥Êñ∞</span>
                            </button>
                        </div>
                        <div class="scrollable-table-container" id="adguard-table-container">
                            <table id="adguard-rules-table">
                                <thead>
                                    <tr>
                                        <th class="text-center hide-on-mobile" style="width: 6rem;">ÂêØÁî®</th>
                                        <th class="hide-on-mobile">ÂêçÁß∞</th>
                                        <th class="hide-on-mobile">Ê∏ÖÂçïÁΩëÂùÄ</th>
                                        <th class="text-right hide-on-mobile" style="width: 7rem;">ËßÑÂàôÊï∞</th>
                                        <th class="hide-on-mobile" style="width: 12rem;">‰∏äÊ¨°Êõ¥Êñ∞</th>
                                        <th class="text-center hide-on-mobile" style="width: 12rem;">Êìç‰Ωú</th>
                                    </tr>
                                </thead>
                                <tbody id="adguard-rules-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="diversion-sub-tab" class="sub-tab-content" style="padding: 0 1.25rem 1.25rem;">
                         <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                            <p style="color: var(--color-text-secondary); font-size: 0.9rem;">Ê≥®ÊÑèÔºöËØ∑ÂãøÈöèÊÑèÂà†Èô§ÊàñÁ¶ÅÁî®Á≥ªÁªüÈªòËÆ§ÁöÑÂàÜÊµÅËßÑÂàôÔºÅ</p>
                            <button id="add-diversion-rule-btn" class="button primary">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11 11V5H13V11H19V13H13V19H11V13H5V11H11Z"></path></svg>
                                <span>Ê∑ªÂä†ÂàÜÊµÅËßÑÂàô</span>
                            </button>
                        </div>
                        <div class="scrollable-table-container" id="diversion-table-container">
                            <table id="diversion-rules-table">
                                <thead>
                                    <tr>
                                        <th class="text-center hide-on-mobile" style="width: 6rem;">ÂêØÁî®</th>
                                        <th class="hide-on-mobile">ÂêçÁß∞</th>
                                        <th class="hide-on-mobile">Á±ªÂûã</th>
                                        <th class="hide-on-mobile">Ê∏ÖÂçïÁΩëÂùÄ</th>
                                        <th class="text-right hide-on-mobile" style="width: 7rem;">ËßÑÂàôÊï∞</th>
                                        <th class="hide-on-mobile" style="width: 12rem;">‰∏äÊ¨°Êõ¥Êñ∞</th>
                                        <th class="text-center hide-on-mobile" style="width: 16rem;">Êìç‰Ωú</th>
                                    </tr>
                                </thead>
                                <tbody id="diversion-rules-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                 </div>
            </div>
        </section>
        
        <section id="system-control-tab" class="tab-content">
             <div class="control-panel-grid">
                <div class="control-module">
                    <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22ZM11 11H7V13H11V17H13V13H17V11H13V7H11V11Z"></path></svg>ÂÆ°ËÆ°ÊéßÂà∂</h3>
                    <div class="control-item">
                        <strong>ËøêË°åÁä∂ÊÄÅ:</strong> <span id="audit-status">Êü•ËØ¢‰∏≠...</span>
                    </div>
                    <div class="button-group">
                        <button id="toggle-audit-btn" class="button primary" disabled data-default-text="ËØ∑Á®çÂêé"><span>ËØ∑Á®çÂêé</span></button>
                        <button id="clear-audit-btn" class="button danger" data-default-text="Ê∏ÖÁ©∫Êó•Âøó"><span>Ê∏ÖÁ©∫Êó•Âøó</span></button>
                    </div>
                </div>
                <div class="control-module">
                    <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21C16.9706 21 21 16.9706 21 12C21 7.02944 16.9706 3 12 3ZM12 19C8.13401 19 5 15.866 5 12C5 8.13401 8.13401 5 12 5C15.866 5 19 8.13401 19 12C19 15.866 15.866 19 12 19ZM12 10.5C12.8284 10.5 13.5 11.1716 13.5 12C13.5 12.8284 12.8284 13.5 12 13.5C11.1716 13.5 10.5 12.8284 10.5 12C10.5 11.1716 11.1716 10.5 12 10.5Z"></path></svg>Êó•ÂøóÂÆπÈáè</h3>
                    <div class="control-item">
                        <strong>ÂΩìÂâçÂÆπÈáè:</strong> <span id="audit-capacity">Êü•ËØ¢‰∏≠...</span>
                    </div>
                    <form id="capacity-form">
                        <input type="number" id="new-capacity" placeholder="Êñ∞ÂÆπÈáè (Â∞ÜÊ∏ÖÁ©∫Êó•Âøó)" required min="1" max="400000">
                        <button type="submit" class="button primary" data-default-text="ËÆæÁΩÆ"><span>ËÆæÁΩÆ</span></button>
                    </form>
                </div>
                 <div class="control-module">
                    <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12.98,2.05C12.67,2.02 12.33,2.02 12.02,2.05C8.44,2.37 5.5,5.29 5.06,8.87C5.02,9.2 5,9.55 5,9.91L5.02,9.99C4.38,10.12 3.8,10.66 3.8,11.35V12.5C3.8,13.25 4.41,13.88 5.16,13.98L5.18,14C5.5,17.56 8.44,20.5 12.02,20.94C12.33,20.98 12.67,20.98 12.98,20.94C16.56,20.5 19.5,17.56 19.82,14L19.84,13.98C20.59,13.88 21.2,13.25 21.2,12.5V11.35C21.2,10.66 20.62,10.12 19.98,9.99L20,9.91C20,9.55 19.98,9.2 19.94,8.87C19.5,5.29 16.56,2.37 12.98,2.05ZM10,7L14,10L10,13V7Z"></path></svg>ÁºìÂ≠òÁÆ°ÁêÜ</h3>
                     <div class="control-item">
                        <strong>ÂÖ®Â±ÄÁºìÂ≠ò:</strong> <span id="cache-status">ÁÆ°ÁêÜMosdnsÁöÑËß£ÊûêÁºìÂ≠ò„ÄÇ</span>
                    </div>
                     <button id="clear-cache-btn" class="button danger"><span>Ê∏ÖÁ©∫ÊâÄÊúâÁºìÂ≠ò</span></button>
                </div>
                <div class="control-module">
                    <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM11 7H13V12L16.5 15.5L15.0858 16.9142L11 12.8284V7Z"></path></svg>Ëá™Âä®Âà∑Êñ∞</h3>
                     <form id="auto-refresh-form" class="auto-refresh-form">
                        <label class="switch" for="auto-refresh-toggle" style="display: contents; cursor: pointer;">
                            <strong>ÂêØÁî®</strong>
                            <label class="switch">
                                <input type="checkbox" id="auto-refresh-toggle">
                                <span class="slider"></span>
                            </label>
                        </label>
                        <div>
                            <input type="number" id="auto-refresh-interval" min="5">
                            <span>Áßí/Ê¨°</span>
                        </div>
                    </form>
                </div>
                <div class="control-module" style="grid-column: 1 / -1;">
                    <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.5C12.4142 2.5 12.75 2.83579 12.75 3.25V5.03131C15.2635 5.50376 17.25 7.49021 17.7224 9.99993H19.5C19.9142 9.99993 20.25 10.3357 20.25 10.75V13.25C20.25 13.6642 19.9142 14 19.5 14H17.7224C17.25 16.5097 15.2635 18.4962 12.75 18.9686V20.75C12.75 21.1642 12.4142 21.5 12 21.5C11.5858 21.5 11.25 21.1642 11.25 20.75V18.9686C8.73652 18.4962 6.75 16.5097 6.27758 14H4.5C4.08579 14 3.75 13.6642 3.75 13.25V10.75C3.75 10.3357 4.08579 9.99993 4.5 9.99993H6.27758C6.75 7.49021 8.73652 5.50376 11.25 5.03131V3.25C11.25 2.83579 11.5858 2.5 12 2.5ZM12 7C9.23858 7 7 9.23858 7 12C7 14.7614 9.23858 17 12 17C14.7614 17 17 14.7614 17 12C17 9.23858 14.7614 7 12 7Z"></path></svg>‰∏ªÈ¢ò‰∏éÂ§ñËßÇ</h3>
                    <div class="control-item">
                        <strong>È¢úËâ≤‰∏ªÈ¢ò</strong>
                        <div class="color-palette">
                            <button class="color-swatch" data-color="indigo" style="background-color: #4f46e5;" title="ÈùõËìù" aria-label="ÈùõËìù"></button>
                            <button class="color-swatch" data-color="pink" style="background-color: #ec4899;" title="Á≤âËâ≤" aria-label="Á≤âËâ≤"></button>
                            <button class="color-swatch" data-color="teal" style="background-color: #14b8a6;" title="ÈùíËâ≤" aria-label="ÈùíËâ≤"></button>
                            <button class="color-swatch" data-color="orange" style="background-color: #f97316;" title="Ê©ôËâ≤" aria-label="Ê©ôËâ≤"></button>
                            <button class="color-swatch" data-color="green" style="background-color: #22c55e;" title="ÁªøËâ≤" aria-label="ÁªøËâ≤"></button>
                            <button class="color-swatch" data-color="violet" style="background-color: #8b5cf6;" title="Á¥´Ëâ≤" aria-label="Á¥´Ëâ≤"></button>
                        </div>
                    </div>
                    <div class="control-item">
                        <strong>ÁïåÈù¢È£éÊ†º</strong>
                        <select id="theme-switcher-select">
                            <option value="light">Êòé‰∫Æ</option>
                            <option value="dark">ÈªëÊöó</option>
                            <option value="sakura">Â§úÊ®±</option>
                            <option value="evergreen">Â∏∏Èùí</option>
                            <option value="starlight">ÊòüÂÖâ</option>
                            <option value="dusk">ÈªÑÊòè</option>
                            <option value="terra">Ëµ§Âúü</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const CONSTANTS = { API_BASE_URL: '', LOGS_PER_PAGE: 50, HISTORY_LENGTH: 30, DEFAULT_AUTO_REFRESH_INTERVAL: 15, ANIMATION_DURATION: 1000, MOBILE_BREAKPOINT: 768, TOAST_DURATION: 3000, SKELETON_ROWS: 10, TOOLTIP_SHOW_DELAY: 200, TOOLTIP_HIDE_DELAY: 250 };
        let state = { isUpdating: false, isCapturing: false, isMobile: false, isTouchDevice: false, currentLogPage: 1, isLogLoading: false, logPaginationInfo: null, displayedLogs: [], currentLogSearchTerm: '', clientAliases: {}, topDomains: [], topClients: [], slowestQueries: [], domainSetRank: [], shuntColors: {}, logSort: { key: 'query_time', order: 'desc' }, autoRefresh: { enabled: true, intervalId: null, intervalSeconds: CONSTANTS.DEFAULT_AUTO_REFRESH_INTERVAL }, data: { totalQueries: { current: null, previous: null }, avgDuration: { current: null, previous: null } }, history: { totalQueries: [], avgDuration: [] }, lastUpdateTime: null, adguardRules: [], diversionRules: [], };
        const elements = { 
            html: document.documentElement, body: document.body, container: document.querySelector('.container'), initialLoader: document.getElementById('initial-loader'), 
            colorSwatches: document.querySelectorAll('.color-swatch'), 
            themeSwitcher: document.getElementById('theme-switcher-select'),
            mainNav: document.querySelector('.main-nav'), navSlider: document.querySelector('.main-nav-slider'), 
            tabLinks: document.querySelectorAll('.tab-link'), tabContents: document.querySelectorAll('.tab-content'), 
            globalRefreshBtn: document.getElementById('global-refresh-btn'), lastUpdated: document.getElementById('last-updated'), 
            autoRefreshToggle: document.getElementById('auto-refresh-toggle'), autoRefreshIntervalInput: document.getElementById('auto-refresh-interval'), autoRefreshForm: document.getElementById('auto-refresh-form'), 
            totalQueries: document.getElementById('total-queries'), avgDuration: document.getElementById('avg-duration'), 
            totalQueriesChange: document.getElementById('total-queries-change'), avgDurationChange: document.getElementById('avg-duration-change'),
            sparklineTotal: document.getElementById('sparkline-total'), sparklineAvg: document.getElementById('sparkline-avg'), 
            auditStatus: document.getElementById('audit-status'), toggleAuditBtn: document.getElementById('toggle-audit-btn'), clearAuditBtn: document.getElementById('clear-audit-btn'), 
            auditCapacity: document.getElementById('audit-capacity'), capacityForm: document.getElementById('capacity-form'), newCapacityInput: document.getElementById('new-capacity'), 
            clearCacheBtn: document.getElementById('clear-cache-btn'),
            topDomainsBody: document.getElementById('top-domains-body'), topClientsBody: document.getElementById('top-clients-body'), slowestQueriesBody: document.getElementById('slowest-queries-body'), 
            shuntResultsBody: document.getElementById('shunt-results-body'),
            logTable: document.getElementById('log-table'), logTableHead: document.getElementById('log-table-head'), logTableBody: document.getElementById('log-table-body'),
            logSearch: document.getElementById('log-search'), logQueryTableContainer: document.getElementById('log-query-table-container'), logLoader: document.getElementById('log-loader'), 
            searchResultsInfo: document.getElementById('search-results-info'),
            toast: document.getElementById('toast'), 
            tooltip: document.getElementById('answers-tooltip'),
            aliasModal: document.getElementById('alias-modal'), manageAliasesBtn: document.getElementById('manage-aliases-btn'), manageAliasesBtnMobile: document.getElementById('manage-aliases-btn-mobile'), manualAliasForm: document.getElementById('manual-alias-form'), 
            aliasListContainer: document.getElementById('alias-list-container'), importAliasInput: document.getElementById('import-alias-file-input'), saveAllAliasesBtn: document.getElementById('save-all-aliases-btn'), 
            systemControlTabIndicator: document.querySelector('a[data-tab="system-control"] .status-indicator'),
            addAdguardRuleBtn: document.getElementById('add-adguard-rule-btn'),
            checkAdguardUpdatesBtn: document.getElementById('check-adguard-updates-btn'),
            adguardRulesTbody: document.getElementById('adguard-rules-tbody'),
            addDiversionRuleBtn: document.getElementById('add-diversion-rule-btn'),
            diversionRulesTbody: document.getElementById('diversion-rules-tbody'),
            ruleModal: document.getElementById('rule-modal'),
            modalTitle: document.getElementById('modal-title'),
            ruleForm: document.getElementById('rule-form'),
            closeRuleModalBtn: document.getElementById('close-rule-modal'),
            cancelRuleModalBtn: document.getElementById('cancel-rule-modal-btn'),
            saveRuleBtn: document.getElementById('save-rule-btn'),
            ruleMode: document.getElementById('rule-mode'),
            ruleTypeWrapper: document.getElementById('rule-type-wrapper'),
            ruleFilesWrapper: document.getElementById('rule-files-wrapper'),
            rulesSubNavLinks: document.querySelectorAll('.sub-nav-link'),
            rulesSubTabContents: document.querySelectorAll('.sub-tab-content'),
        };
        let toastTimeout;
        
        const debounce = (func, wait) => { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; };

        const api = { fetch: async (url, options = {}) => { try { const response = await fetch(url, { ...options, signal: options.signal }); if (!response.ok) { let errorMsg = `API Error: ${response.status} ${response.statusText}`; try { const errorBody = await response.json(); if (errorBody && errorBody.error) { errorMsg = errorBody.error; } } catch (e) { try { errorMsg = await response.text() || errorMsg; } catch (textErr) {} } if (response.status !== 404) { ui.showToast(errorMsg, 'error'); } throw new Error(errorMsg); } const contentType = response.headers.get('content-type'); if (contentType && contentType.includes('application/json')) return response.json(); return { success: true, message: await response.text() }; } catch (error) { if (error.name !== 'AbortError') { console.error(error); } throw error; } }, getStatus: (signal) => api.fetch(`${CONSTANTS.API_BASE_URL}/api/v1/audit/status`, { signal }), getCapacity: (signal) => api.fetch(`${CONSTANTS.API_BASE_URL}/api/v1/audit/capacity`, { signal }), start: () => api.fetch(`${CONSTANTS.API_BASE_URL}/api/v1/audit/start`, { method: 'POST' }), stop: () => api.fetch(`${CONSTANTS.API_BASE_URL}/api/v1/audit/stop`, { method: 'POST' }), clear: () => api.fetch(`${CONSTANTS.API_BASE_URL}/api/v1/audit/clear`, { method: 'POST' }), setCapacity: (capacity) => api.fetch(`${CONSTANTS.API_BASE_URL}/api/v1/audit/capacity`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ capacity: parseInt(capacity, 10) }) }), cache: { clear: () => api.fetch('/api/v1/cache/clear', { method: 'POST' }) }, v2: { getStats: (signal) => api.fetch(`${CONSTANTS.API_BASE_URL}/api/v2/audit/stats`, { signal }), getTopDomains: (signal, limit = 50) => api.fetch(`${CONSTANTS.API_BASE_URL}/api/v2/audit/rank/domain?limit=${limit}`, { signal }), getTopClients: (signal, limit = 50) => api.fetch(`${CONSTANTS.API_BASE_URL}/api/v2/audit/rank/client?limit=${limit}`, { signal }), getSlowest: (signal, limit = 50) => api.fetch(`${CONSTANTS.API_BASE_URL}/api/v2/audit/rank/slowest?limit=${limit}`, { signal }), getDomainSetRank: (signal, limit = 50) => api.fetch(`${CONSTANTS.API_BASE_URL}/api/v2/audit/rank/domain_set?limit=${limit}`, { signal }), getLogs: (signal, params = {}) => { const queryParams = new URLSearchParams({ page: 1, limit: CONSTANTS.LOGS_PER_PAGE, ...params }); for(let [key, value] of queryParams.entries()){ if(!value) { queryParams.delete(key); } } return api.fetch(`${CONSTANTS.API_BASE_URL}/api/v2/audit/logs?${queryParams}`, { signal }); } } };
        
        const ui = {
            showToast(message, type = 'success') { if (!elements.toast) return; clearTimeout(toastTimeout); const icon = type === 'success' ? `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"></path></svg>`; elements.toast.innerHTML = `${icon}<span>${message}</span>`; elements.toast.className = `show ${type}`; const hideToast = () => { elements.toast.className = elements.toast.className.replace('show', ''); }; elements.toast.onmouseenter = () => clearTimeout(toastTimeout); elements.toast.onmouseleave = () => toastTimeout = setTimeout(hideToast, CONSTANTS.TOAST_DURATION); toastTimeout = setTimeout(hideToast, CONSTANTS.TOAST_DURATION); },
            setLoading(button, isLoading) { if (!button) return; button.disabled = isLoading; button.setAttribute('aria-busy', String(isLoading)); const textSpan = button.querySelector('span'); if (textSpan) { if (!button.dataset.defaultText) { button.dataset.defaultText = textSpan.textContent; } textSpan.textContent = isLoading ? 'Â§ÑÁêÜ‰∏≠...' : button.dataset.defaultText; } },
            updateStatus(isCapturing) { if (!elements.toggleAuditBtn || !elements.auditStatus) return; this.setLoading(elements.toggleAuditBtn, false); const statusIndicator = elements.systemControlTabIndicator; if(statusIndicator) statusIndicator.className = 'status-indicator'; if (typeof isCapturing === 'boolean') { state.isCapturing = isCapturing; elements.auditStatus.textContent = isCapturing ? 'ËøêË°å‰∏≠' : 'Â∑≤ÂÅúÊ≠¢'; elements.auditStatus.style.color = isCapturing ? 'var(--color-success)' : 'var(--color-danger)'; const actionText = isCapturing ? 'ÂÖ≥Èó≠ÂÆ°ËÆ°' : 'ÂºÄÂêØÂÆ°ËÆ°'; elements.toggleAuditBtn.querySelector('span').textContent = actionText; elements.toggleAuditBtn.dataset.defaultText = actionText; elements.toggleAuditBtn.className = `button ${isCapturing ? 'danger' : 'primary'}`; if(statusIndicator) statusIndicator.classList.add(isCapturing ? 'running' : 'stopped'); } else { elements.auditStatus.textContent = 'Êú™Áü•'; elements.auditStatus.style.color = 'var(--color-text-secondary)'; elements.toggleAuditBtn.querySelector('span').textContent = 'Âà∑Êñ∞Áä∂ÊÄÅ'; elements.toggleAuditBtn.dataset.defaultText = 'Âà∑Êñ∞Áä∂ÊÄÅ'; } },
            updateCapacity(capacity) { if (elements.auditCapacity) elements.auditCapacity.textContent = capacity != null ? `${capacity.toLocaleString()} Êù°` : 'Êü•ËØ¢Â§±Ë¥•'; },
            updateOverviewStats() {
                const { totalQueries, avgDuration } = state.data;
                animateValue(elements.totalQueries, totalQueries.previous, totalQueries.current, CONSTANTS.ANIMATION_DURATION);
                animateValue(elements.avgDuration, avgDuration.previous, avgDuration.current, CONSTANTS.ANIMATION_DURATION, 2);
                updateStatChange(elements.totalQueriesChange, totalQueries.previous, totalQueries.current);
                updateStatChange(elements.avgDurationChange, avgDuration.previous, avgDuration.current, true);
                if (elements.sparklineTotal) elements.sparklineTotal.innerHTML = generateSparklineSVG(state.history.totalQueries); 
                if (elements.sparklineAvg) elements.sparklineAvg.innerHTML = generateSparklineSVG(state.history.avgDuration, true);
            },
            renderLogTable(logs, append = false) {
                const tbody = elements.logTableBody;
                if (!tbody) return;
                if (!append) { tbody.innerHTML = ''; state.displayedLogs = []; }
                if (logs.length === 0 && !append) { renderTable(tbody, [], () => {}, 'log-query'); return; }
                const startIndex = state.displayedLogs.length;
                state.displayedLogs.push(...logs);
                const fragment = document.createDocumentFragment();
                logs.forEach((log, i) => { const row = renderLogItemHTML(log, startIndex + i); row.style.animationDelay = `${i * 20}ms`; fragment.appendChild(row); });
                tbody.appendChild(fragment);
            },
            updateSearchResultsInfo(pagination) { if (!elements.searchResultsInfo) return; if (state.currentLogSearchTerm?.query && pagination) { elements.searchResultsInfo.innerHTML = `‰∏∫ÊÇ®ÊâæÂà∞ <strong>${pagination.total_items.toLocaleString()}</strong> Êù°Áõ∏ÂÖ≥ÁªìÊûú`; } else { elements.searchResultsInfo.innerHTML = ''; } },
            openRuleModal(mode, rule = null) {
                const form = elements.ruleForm;
                form.reset();
                elements.ruleMode.value = mode;
                const isDiversion = mode === 'diversion';
                elements.modalTitle.textContent = rule ? `‰øÆÊîπ${isDiversion ? 'ÂàÜÊµÅ' : 'Êã¶Êà™'}ËßÑÂàô` : `Ê∑ªÂä†${isDiversion ? 'ÂàÜÊµÅ' : 'Êã¶Êà™'}ËßÑÂàô`;
                elements.ruleTypeWrapper.style.display = isDiversion ? 'block' : 'none';
                elements.ruleFilesWrapper.style.display = isDiversion ? 'block' : 'none';
                form.elements['type'].required = isDiversion;
                form.elements['files'].required = isDiversion;

                if (rule) {
                    form.elements['id'].value = rule.id ?? rule.name;
                    form.elements['name'].value = rule.name;
                    form.elements['url'].value = rule.url;
                    form.elements['auto_update'].checked = rule.auto_update;
                    form.elements['update_interval_hours'].value = rule.update_interval_hours || 24;
                    if (isDiversion) {
                        form.elements['type'].value = rule.type;
                        form.elements['files'].value = rule.files;
                    }
                } else {
                    form.elements['id'].value = '';
                    form.elements['auto_update'].checked = true;
                    form.elements['update_interval_hours'].value = 24;
                    if (isDiversion) form.elements['type'].value = "";
                }
                
                elements.ruleModal.showModal();
            },
            closeRuleModal() { elements.ruleModal.close(); }
        };

        function updateNavSlider(activeLink) {
            if (!elements.navSlider || !elements.mainNav) return;
            const navRect = elements.mainNav.getBoundingClientRect();
            const linkRect = activeLink.getBoundingClientRect();
            const left = linkRect.left - navRect.left;
            elements.navSlider.style.width = `${linkRect.width}px`;
            elements.navSlider.style.transform = `translateX(${left}px)`;
        }

        const aliasManager = { load: () => { state.clientAliases = JSON.parse(localStorage.getItem('mosdnsClientAliases')) || {}; }, save: () => { localStorage.setItem('mosdnsClientAliases', JSON.stringify(state.clientAliases)); }, getDisplayName: (ip) => state.clientAliases[ip] || ip, getAliasedClientHTML: (ip) => state.clientAliases[ip] ? `<span class="client-alias" title="IP: ${ip}">${state.clientAliases[ip]}</span>` : ip, getIpByAlias: (alias) => { const searchTerm = alias.toLowerCase(); for (const ip in state.clientAliases) { if (state.clientAliases[ip].toLowerCase() === searchTerm) { return ip; } } return null; }, set(ip, name) { if (name) { state.clientAliases[ip] = name; } else { delete state.clientAliases[ip]; } }, async saveAll() { const aliasItems = elements.aliasListContainer.querySelectorAll('.alias-item'); let changed = false; aliasItems.forEach(item => { const ip = item.dataset.ip; const input = item.querySelector('input'); const newValue = input.value.trim(); const originalValue = input.dataset.originalValue; if (newValue !== originalValue) { this.set(ip, newValue); changed = true; } }); if(changed) { this.save(); ui.showToast('ÊâÄÊúâÂà´ÂêçÊõ¥ÊîπÂ∑≤‰øùÂ≠ò', 'success'); await updatePageData(); await this.renderEditableList(); } else { ui.showToast('Ê≤°ÊúâÊ£ÄÊµãÂà∞‰ªª‰ΩïÊõ¥Êîπ'); } }, async renderEditableList() { if (!elements.aliasListContainer) return; elements.aliasListContainer.innerHTML = '<p>Ê≠£Âú®Âä†ËΩΩÂÆ¢Êà∑Á´ØÂàóË°®...</p>'; try { const topClients = await api.v2.getTopClients(null, 200); const uniqueIps = [...new Set(topClients.map(client => client.key))].sort(); if (uniqueIps.length === 0) { elements.aliasListContainer.innerHTML = '<p>Êó•Âøó‰∏≠ÊöÇÊó†ÂÆ¢Êà∑Á´Ø IP ËÆ∞ÂΩï„ÄÇ</p>'; return; } elements.aliasListContainer.innerHTML = ''; uniqueIps.forEach(ip => { const item = document.createElement('div'); item.className = 'alias-item'; item.dataset.ip = ip; const currentAlias = this.getDisplayName(ip); const aliasValue = currentAlias === ip ? '' : currentAlias; item.innerHTML = `<span style="font-weight:600;">${ip}</span> <input type="text" placeholder="ËÆæÁΩÆÂà´Âêç..." value="${aliasValue}" data-original-value="${aliasValue}">`; elements.aliasListContainer.appendChild(item); }); } catch (error) { elements.aliasListContainer.innerHTML = '<p>Âä†ËΩΩÂÆ¢Êà∑Á´ØÂàóË°®Â§±Ë¥•„ÄÇ</p>'; console.error("Failed to fetch clients for alias management:", error); } }, export: () => { const dataStr = JSON.stringify(state.clientAliases, null, 2); const blob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `mosdns-aliases-${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); ui.showToast('ÈÖçÁΩÆÂ∑≤ÂØºÂá∫', 'success'); }, import: (file) => { const reader = new FileReader(); reader.onload = (e) => { try { const newAliases = JSON.parse(e.target.result); if (typeof newAliases !== 'object' || newAliases === null || Array.isArray(newAliases)) throw new Error('Êó†ÊïàÁöÑJSONÂØπË±°Ê†ºÂºè'); state.clientAliases = { ...state.clientAliases, ...newAliases }; this.save(); this.renderEditableList(); updatePageData(); ui.showToast('ÈÖçÁΩÆÂ∑≤ÊàêÂäüÂØºÂÖ•Âπ∂ÂêàÂπ∂', 'success'); } catch (error) { ui.showToast(`ÂØºÂÖ•Â§±Ë¥•: ${error.message}`, 'error'); } }; reader.readAsText(file); }, };
        const historyManager = { load: () => { const saved = JSON.parse(localStorage.getItem('mosdnsHistory')); if (saved) { state.history.totalQueries = saved.totalQueries || []; state.history.avgDuration = saved.avgDuration || []; } }, add(total, avg) { state.history.totalQueries.push(total ?? 0); state.history.avgDuration.push(avg ?? 0); if (state.history.totalQueries.length > CONSTANTS.HISTORY_LENGTH) state.history.totalQueries.shift(); this.save(); }, save: () => { localStorage.setItem('mosdnsHistory', JSON.stringify(state.history)); } };
        const themeManager = { init() { const savedTheme = localStorage.getItem('mosdns-theme') || 'dark'; const savedColor = localStorage.getItem('mosdns-color') || 'indigo'; this.setTheme(savedTheme, false); this.setColor(savedColor, false); elements.themeSwitcher?.addEventListener('change', e => this.setTheme(e.target.value)); elements.colorSwatches.forEach(swatch => { swatch.addEventListener('click', () => this.setColor(swatch.dataset.color)); }); }, setTheme(theme, save = true) { elements.html.setAttribute('data-theme', theme); if (elements.themeSwitcher) { elements.themeSwitcher.value = theme; } if (save) localStorage.setItem('mosdns-theme', theme); }, setColor(color, save = true) { elements.html.setAttribute('data-color-scheme', color); document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active')); document.querySelectorAll(`.color-swatch[data-color="${color}"]`).forEach(s => s.classList.add('active')); if(save) localStorage.setItem('mosdns-color', color); } };
        const animateValue = (element, start, end, duration, decimals = 0) => { if (!element || start === null || end === null) return; if (start === end) { element.textContent = (decimals > 0 ? parseFloat(end).toFixed(decimals) : Math.floor(end).toLocaleString()); return; } let startTimestamp = null; const step = (timestamp) => { if (!startTimestamp) startTimestamp = timestamp; const progress = Math.min((timestamp - startTimestamp) / duration, 1); const current = start + progress * (end - start); element.textContent = (decimals > 0 ? parseFloat(current).toFixed(decimals) : Math.floor(current).toLocaleString()); if (progress < 1) window.requestAnimationFrame(step); }; window.requestAnimationFrame(step); };
        const updateStatChange = (element, prev, curr, isTime = false) => { if (prev === null || curr === null || prev === 0) { element.style.visibility = 'hidden'; return; } const diff = curr - prev; const change = (diff / prev) * 100; if (Math.abs(change) < 0.1) { element.style.visibility = 'hidden'; return; } const direction = isTime ? (diff < 0 ? 'up' : 'down') : (diff > 0 ? 'up' : 'down'); const icon = direction === 'up' ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8L18 14H6L12 8Z"></path></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 16L6 10H18L12 16Z"></path></svg>'; element.className = `stat-change ${direction}`; element.innerHTML = `${icon} ${Math.abs(change).toFixed(1)}%`; element.style.visibility = 'visible'; };
        const setupGlowEffect = () => { elements.container?.addEventListener('mousemove', (e) => { const card = e.target.closest('.card:not(dialog)'); if (card) { const rect = card.getBoundingClientRect(); card.style.setProperty('--glow-x', `${e.clientX - rect.left}px`); card.style.setProperty('--glow-y', `${e.clientY - rect.top}px`); } }); };
        const generateSparklineSVG = (data, isFloat = false, width = 300, height = 60) => { if (!data || data.length < 2) return ''; const numericData = data.map(Number); const maxVal = Math.max(...numericData); const minVal = Math.min(...numericData); const range = maxVal - minVal === 0 ? 1 : maxVal - minVal; const points = numericData.map((d, i) => { const x = (i / (data.length - 1)) * width; const y = height - ((d - minVal) / range) * height; return `${x.toFixed(2)},${y.toFixed(2)}`; }); const pathD = `M ${points.join(' L ')}`; const fillPathD = `${pathD} L ${width},${height} L 0,${height} Z`; return `<svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="none"><defs><linearGradient id="sparkline-gradient" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="var(--color-accent-primary)" stop-opacity="0.5" /><stop offset="100%" stop-color="var(--color-accent-primary)" stop-opacity="0" /></linearGradient></defs><path d="${fillPathD}" fill="url(#sparkline-gradient)" /><path d="${pathD}" class="sparkline-path" fill="none" /></svg>`; };
        const renderTable = (tbody, data, renderRow, tableType) => { if (!tbody) return; tbody.innerHTML = ''; if (!data || data.length === 0) { const isSearchEmpty = tableType === 'log-query' && state.currentLogSearchTerm?.query; const isRuleTable = tableType === 'adguard' || tableType === 'diversion'; let message = 'ËØ∑Á°Æ‰øùÂÆ°ËÆ°ÂäüËÉΩÂ∑≤ÂºÄÂêØ„ÄÇ'; let ctaButton = '<button class="button primary tab-link-action" data-tab="system-control">ÂâçÂæÄÁ≥ªÁªüÊéßÂà∂</button>'; if (isSearchEmpty) { message = `Ê≤°ÊúâÊâæÂà∞‰∏é "<strong>${state.currentLogSearchTerm.query}</strong>" ÂåπÈÖçÁöÑËÆ∞ÂΩï„ÄÇ`; ctaButton = ''; } else if (isRuleTable) { message = 'ÊöÇÊó†ËßÑÂàôÔºåËØ∑ÁÇπÂáª "Ê∑ªÂä†ËßÑÂàô" ÊåâÈíÆÊñ∞Âª∫‰∏Ä‰∏™„ÄÇ'; ctaButton = ''; } const colspan = state.isMobile ? 1 : (tbody.previousElementSibling?.rows[0]?.cells.length || 2); const emptyRow = document.createElement('tr'); emptyRow.className = 'empty-state-row'; emptyRow.innerHTML = `<td colspan="${colspan}"><div class="empty-state-content"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.71,3.29C21.32,2.9,20.69,2.9,20.3,3.29L3.29,20.3c-0.39,0.39-0.39,1.02,0,1.41C3.48,21.9,3.74,22,4,22s0.52-0.1,0.71-0.29L21.71,4.7C22.1,4.31,22.1,3.68,21.71,3.29z M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10,10-4.48,10-10S17.52,2,12,2z M12,20c-4.41,0-8-3.59-8-8c0-2.33,1-4.45,2.65-5.92l11.27,11.27C16.45,19,14.33,20,12,20z"></path></svg><strong>ÊöÇÊó†Êï∞ÊçÆ</strong><p>${message}</p>${ctaButton}</div></td>`; tbody.appendChild(emptyRow); return; } const fragment = document.createDocumentFragment(); data.forEach((item, index) => { const row = renderRow(item, index); row.style.animationDelay = `${index * 20}ms`; fragment.appendChild(row); }); tbody.appendChild(fragment); };
        
        function renderSkeletonRows(tbody, rowCount, colCount) {
            tbody.innerHTML = '';
            const fragment = document.createDocumentFragment();
            for (let i = 0; i < rowCount; i++) {
                const tr = document.createElement('tr');
                tr.className = 'skeleton-row';
                let cells = '';
                for (let j = 0; j < colCount; j++) {
                    cells += '<td><div class="skeleton"></div></td>';
                }
                tr.innerHTML = cells;
                fragment.appendChild(tr);
            }
            tbody.appendChild(fragment);
        }
        
        const renderTopDomains = (data) => renderTable(elements.topDomainsBody, data, (item, index) => { const tr = document.createElement('tr'); tr.dataset.rankIndex = index; tr.dataset.rankSource = 'domain'; tr.innerHTML = `<td><span class="truncate-text" title="${item.key}">${item.key}</span></td><td class="text-right hide-on-mobile"><a href="#log-query" class="clickable-link" data-filter-value="${item.key}">${item.count.toLocaleString()}</a></td>`; return tr; }, 'top-domains');
        const renderTopClients = (data) => renderTable(elements.topClientsBody, data, (item, index) => { const tr = document.createElement('tr'); tr.dataset.rankIndex = index; tr.dataset.rankSource = 'client'; tr.innerHTML = `<td>${aliasManager.getAliasedClientHTML(item.key)}</td><td class="text-right hide-on-mobile"><a href="#log-query" class="clickable-link" data-exact-search="true" data-filter-value="${item.key}">${item.count.toLocaleString()}</a></td>`; return tr; }, 'top-clients');
        const renderSlowestQueries = (data) => renderTable(elements.slowestQueriesBody, data, renderSlowestQueryItemHTML, 'slowest-queries');
        
        const chartColors = ['#6d9dff', '#f778ba', '#2dd4bf', '#fb923c', '#a78bfa', '#fde047', '#ff8c8c'];
        const renderDonutChart = (data) => {
            if (!data || data.length === 0) {
                elements.shuntResultsBody.innerHTML = `<div class="empty-state-content" style="padding: 2rem 0;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.71,3.29C21.32,2.9,20.69,2.9,20.3,3.29L3.29,20.3c-0.39,0.39-0.39,1.02,0,1.41C3.48,21.9,3.74,22,4,22s0.52-0.1,0.71-0.29L21.71,4.7C22.1,4.31,22.1,3.68,21.71,3.29z M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10,10-4.48,10-10S17.52,2,12,2z M12,20c-4.41,0-8-3.59-8-8c0-2.33,1-4.45,2.65-5.92l11.27,11.27C16.45,19,14.33,20,12,20z"></path></svg><strong>ÊöÇÊó†Êï∞ÊçÆ</strong><p>Ê≤°ÊúâÊ£ÄÊµãÂà∞ÂàÜÊµÅÁªìÊûú„ÄÇ</p></div>`;
                return;
            }
            const total = data.reduce((sum, item) => sum + item.count, 0);
            const radius = 72;
            const circumference = 2 * Math.PI * radius;
            let offset = 0;
            
            state.shuntColors = {};

            const paths = data.map((item, index) => {
                const percent = (item.count / total);
                const strokeDashoffset = circumference - (percent * circumference);
                const color = chartColors[index % chartColors.length];
                state.shuntColors[item.key] = color;
                const path = `<circle cx="80" cy="80" r="${radius}" fill="transparent" stroke="${color}" stroke-width="16" stroke-dasharray="${circumference}" stroke-dashoffset="${strokeDashoffset}" transform="rotate(${offset * 360} 80 80)"></circle>`;
                offset += percent;
                return path;
            }).join('');
            
            const legend = data.map((item, index) => {
                const percent = ((item.count / total) * 100).toFixed(1);
                const color = chartColors[index % chartColors.length];
                return `<li class="donut-legend-item">
                            <span class="legend-color-box" style="background-color: ${color};"></span>
                            <span class="legend-label truncate-text" title="${item.key}">${item.key}</span>
                            <span class="legend-value">${item.count.toLocaleString()} (${percent}%)</span>
                        </li>`;
            }).join('');
            
            elements.shuntResultsBody.innerHTML = `
                <div class="donut-chart-wrapper">
                    <div class="donut-chart">
                        <svg viewBox="0 0 160 160">${paths}</svg>
                        <div class="donut-chart-center-text">
                            <div class="total">${total.toLocaleString()}</div>
                            <div class="label">ÊÄªËÆ°</div>
                        </div>
                    </div>
                    <ul class="donut-legend">${legend}</ul>
                </div>`;
        };

        let updateController;
        async function updatePageData() {
            if (state.isUpdating) return;
            state.isUpdating = true;
            if (updateController) updateController.abort();
            updateController = new AbortController();
            const { signal } = updateController;
            elements.globalRefreshBtn.setAttribute('aria-busy', 'true');

            const activeTab = document.querySelector('.tab-link.active')?.dataset.tab;
            if (activeTab === 'overview') {
                renderSkeletonRows(elements.topDomainsBody, CONSTANTS.SKELETON_ROWS, state.isMobile ? 1 : 2);
                renderSkeletonRows(elements.topClientsBody, CONSTANTS.SKELETON_ROWS, state.isMobile ? 1 : 2);
                renderSkeletonRows(elements.slowestQueriesBody, CONSTANTS.SKELETON_ROWS, state.isMobile ? 1 : 3);
            }

            try {
                const [statusRes, capacityRes, statsRes, topDomainsRes, topClientsRes, slowestRes, domainSetRankRes] = await Promise.allSettled([
                    api.getStatus(signal), api.getCapacity(signal), api.v2.getStats(signal),
                    api.v2.getTopDomains(signal, 100), api.v2.getTopClients(signal, 100), api.v2.getSlowest(signal, 100),
                    api.v2.getDomainSetRank(signal, 100)
                ]);
                
                ui.updateStatus(statusRes.status === 'fulfilled' ? statusRes.value?.capturing : null);
                ui.updateCapacity(capacityRes.status === 'fulfilled' ? capacityRes.value?.capacity : null);

                if (statsRes.status === 'fulfilled' && statsRes.value) {
                    const stats = statsRes.value;
                    state.data.totalQueries.previous = state.data.totalQueries.current === null ? stats.total_queries : state.data.totalQueries.current;
                    state.data.avgDuration.previous = state.data.avgDuration.current === null ? stats.average_duration_ms : state.data.avgDuration.current;
                    state.data.totalQueries.current = stats.total_queries;
                    state.data.avgDuration.current = stats.average_duration_ms;
                    ui.updateOverviewStats();
                    historyManager.add(stats.total_queries, stats.average_duration_ms);
                }

                if (topDomainsRes.status === 'fulfilled') { state.topDomains = topDomainsRes.value || []; renderTopDomains(state.topDomains); }
                if (topClientsRes.status === 'fulfilled') { state.topClients = topClientsRes.value || []; renderTopClients(state.topClients); }
                if (slowestRes.status === 'fulfilled') { state.slowestQueries = slowestRes.value || []; renderSlowestQueries(state.slowestQueries); }
                if (domainSetRankRes.status === 'fulfilled') { state.domainSetRank = domainSetRankRes.value || []; renderDonutChart(state.domainSetRank); }
                
                state.lastUpdateTime = new Date();
                updateLastUpdated();

                if (activeTab === 'log-query') {
                    await fetchAndRenderLogs(1, false);
                } else if (activeTab === 'rules') {
                    await Promise.all([adguardManager.load(), diversionManager.load()]);
                }
            } catch (error) { if (error.name !== 'AbortError') console.error("Page update failed:", error); } 
            finally { 
                elements.globalRefreshBtn.setAttribute('aria-busy', 'false'); 
                state.isUpdating = false; 
            }
        }
        
        let logRequestController;
        async function fetchAndRenderLogs(page = 1, append = false) {
            if (state.isLogLoading && !append) return;
            state.isLogLoading = true;
            if (elements.logLoader) elements.logLoader.style.display = 'block';
            
            if (!append) {
                renderSkeletonRows(elements.logTableBody, CONSTANTS.LOGS_PER_PAGE, state.isMobile ? 1 : 5);
            }
            if (!append && logRequestController) logRequestController.abort();
            logRequestController = new AbortController();

            const params = { page, limit: CONSTANTS.LOGS_PER_PAGE, q: state.currentLogSearchTerm.query, exact: state.currentLogSearchTerm.exact };
            try {
                const response = await api.v2.getLogs(logRequestController.signal, params);
                if (!response?.pagination) throw new Error("Invalid response from logs API");
                const { pagination, logs } = response;
                state.logPaginationInfo = pagination;
                state.currentLogPage = pagination.current_page;
                if(!append) ui.updateSearchResultsInfo(pagination);
                ui.renderLogTable(logs || [], append);
            } catch (error) {
                if (error.name !== 'AbortError') { console.error("Failed to fetch logs:", error); ui.showToast('Ëé∑ÂèñÊó•ÂøóÂ§±Ë¥•', 'error'); }
            } finally { 
                state.isLogLoading = false; 
                if (elements.logLoader) elements.logLoader.style.display = 'none'; 
            }
        }
        
        const tableSorter = {
            init() { if (elements.logTableHead) elements.logTableHead.addEventListener('click', this.handleSort.bind(this)); this.updateHeaders(); },
            handleSort(e) { const th = e.target.closest('th[data-sortable]'); if (!th) return; const key = th.dataset.sortKey; if (state.logSort.key === key) { state.logSort.order = state.logSort.order === 'asc' ? 'desc' : 'asc'; } else { state.logSort.key = key; state.logSort.order = 'desc'; } this.sortLogs(); this.updateHeaders(); },
            sortLogs() {
                const { key, order } = state.logSort;
                state.displayedLogs.sort((a, b) => {
                    let valA = a[key], valB = b[key];
                    if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
                    const result = valA < valB ? -1 : valA > valB ? 1 : 0;
                    return order === 'asc' ? result : -result;
                });
                ui.renderLogTable(state.displayedLogs, false);
            },
            updateHeaders() { document.querySelectorAll('#log-table-head th[data-sortable]').forEach(th => { th.classList.remove('sorted'); const indicator = th.querySelector('.sort-indicator'); if(indicator) { if (th.dataset.sortKey === state.logSort.key) { th.classList.add('sorted'); indicator.textContent = state.logSort.order === 'asc' ? '‚ñ≤' : '‚ñº'; } else { indicator.textContent = ' '; } } }); }
        };

        function applyLogFilterAndRender() {
            if (!elements.logSearch) return;
            const rawSearchTerm = elements.logSearch.value.trim();
            let query = rawSearchTerm, exact = false;
            if (rawSearchTerm.startsWith('"') && rawSearchTerm.endsWith('"')) {
                query = rawSearchTerm.slice(1, -1);
                exact = true;
            } else if (!exact) {
                const ipFromAlias = aliasManager.getIpByAlias(query);
                if (ipFromAlias) query = ipFromAlias; 
            }
            state.currentLogSearchTerm = { query, exact };
            fetchAndRenderLogs(1, false);
        }

        function loadMoreLogs() { if (state.isLogLoading || !state.logPaginationInfo || state.currentLogPage >= state.logPaginationInfo.total_pages) return; fetchAndRenderLogs(state.currentLogPage + 1, true); }
        function formatDate(isoString) { return isoString ? new Date(isoString).toLocaleString('zh-CN', { hour12: false, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' }).replace(/\//g, '-') : 'N/A'; }
        function formatRelativeTime(isoString) { if (!isoString) return 'N/A'; const diffInSeconds = Math.max(0, Math.round((new Date() - new Date(isoString)) / 1000)); if (diffInSeconds < 5) return 'ÂàöÂàö'; if (diffInSeconds < 60) return `${diffInSeconds}ÁßíÂâç`; if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}ÂàÜÈíüÂâç`; if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}Â∞èÊó∂Ââç`; if (diffInSeconds < 86400 * 2) return `Êò®Â§©`; return new Date(isoString).toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' }); }
        
        function updateLastUpdated() { 
            if (elements.lastUpdated) {
                if (state.lastUpdateTime) {
                    const relativeTime = formatRelativeTime(state.lastUpdateTime.toISOString());
                    elements.lastUpdated.textContent = state.isMobile ? relativeTime : `‰∏äÊ¨°Êõ¥Êñ∞‰∫é ${relativeTime}`;
                } else {
                    elements.lastUpdated.textContent = '';
                }
            }
        }
        
        const tooltipManager = (() => {
            const tooltip = elements.tooltip;
            let showTimeout, hideTimeout;

            const _display = (targetElement) => {
                const logIndex = targetElement.dataset.logIndex ? parseInt(targetElement.dataset.logIndex, 10) : null;
                const rankIndex = targetElement.dataset.rankIndex ? parseInt(targetElement.dataset.rankIndex, 10) : null;
                const source = targetElement.dataset.logSource || targetElement.dataset.rankSource;
                
                let data;
                if (source === 'slowest' && logIndex !== null) data = state.slowestQueries[logIndex];
                else if (source === 'domain' && rankIndex !== null) data = state.topDomains[rankIndex];
                else if (source === 'client' && rankIndex !== null) data = state.topClients[rankIndex];
                else if (source === 'domain_set' && rankIndex !== null) data = state.domainSetRank[rankIndex];
                else if (logIndex !== null) data = state.displayedLogs[logIndex];
                
                if (!data) return;
                
                tooltip.innerHTML = getTooltipHTML(data, source);
                const targetRect = targetElement.getBoundingClientRect();
                
                tooltip.style.left = '-9999px';
                tooltip.style.top = '-9999px';
                tooltip.classList.add('visible');

                const tooltipRect = tooltip.getBoundingClientRect();
                let top = targetRect.bottom + 10, left = targetRect.left + (targetRect.width / 2) - (tooltipRect.width / 2);

                if (top + tooltipRect.height > window.innerHeight - 10) top = targetRect.top - tooltipRect.height - 10;
                if (left < 10) left = 10;
                else if (left + tooltipRect.width > window.innerWidth - 10) left = window.innerWidth - tooltipRect.width - 10;

                tooltip.style.top = `${top}px`;
                tooltip.style.left = `${left}px`;
            };
            
            const _hide = () => tooltip.classList.remove('visible');
            
            return {
                handleTriggerEnter(targetElement) {
                    clearTimeout(hideTimeout);
                    showTimeout = setTimeout(() => _display(targetElement), CONSTANTS.TOOLTIP_SHOW_DELAY);
                },
                handleTriggerLeave() {
                    clearTimeout(showTimeout);
                    hideTimeout = setTimeout(_hide, CONSTANTS.TOOLTIP_HIDE_DELAY);
                },
                handleTooltipEnter() {
                    clearTimeout(hideTimeout);
                },
                handleTooltipLeave() {
                    hideTimeout = setTimeout(_hide, CONSTANTS.TOOLTIP_HIDE_DELAY);
                },
                show(targetElement) {
                     _display(targetElement);
                },
                hide() {
                    _hide();
                }
            };
        })();

        const getContrastingTextColor = (hexColor) => {
            if (!hexColor || hexColor.length < 4) return '#0f172a';
            let r = parseInt(hexColor.substr(1, 2), 16);
            let g = parseInt(hexColor.substr(3, 2), 16);
            let b = parseInt(hexColor.substr(5, 2), 16);
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return (yiq >= 128) ? '#0f172a' : '#ffffff';
        };
        
        function getRuleTagHTML(log) {
            if (!log || !log.domain_set) return '';
            const ruleName = log.domain_set;
            const bgColor = state.shuntColors[ruleName];
            if (!bgColor) return '';

            const textColor = getContrastingTextColor(bgColor);
            return `<span class="rule-tag" style="background-color: ${bgColor}; color: ${textColor};" title="ÂàÜÊµÅËßÑÂàô: ${ruleName}">${ruleName}</span>`;
        }
        
        function getResponseTagHTML(log) { if (!log) return ''; const code = log.response_code || 'UNKNOWN'; let tagClass = 'other'; if (code === 'NOERROR') tagClass = 'noerror'; else if (code === 'NXDOMAIN') tagClass = 'nxdomain'; else if (code === 'SERVFAIL') tagClass = 'servfail'; else if (code === 'REFUSED') tagClass = 'refused'; return `<span class="response-tag ${tagClass}">${code}</span>`; }
        function getResponseSummary(log) { if (!log) return ''; if (log.response_code !== 'NOERROR') return getResponseTagHTML(log); if (log.answers?.length > 0) { const firstIp = log.answers.find(a => a.type === 'A' || a.type === 'AAAA'); const firstCname = log.answers.find(a => a.type === 'CNAME'); let mainText = firstIp?.data ?? firstCname?.data ?? log.answers[0].data; if (mainText.length > 25) mainText = mainText.substring(0, 22) + '...'; if (log.answers.length > 1) mainText += ` (+${log.answers.length - 1})`; return `<span class="truncate-text">${mainText}</span>`; } return '<span>(empty)</span>'; }
        function renderDomainResponseCellHTML(log) { return `<div class="domain-response-cell"><span class="domain-name truncate-text" title="${log.query_name}">${log.query_name}</span><div class="response-meta"><span class="response-summary">${getResponseSummary(log)}</span>${getRuleTagHTML(log)}</div></div>`; }
        function renderLogItemHTML(log, globalIndex) { const tr = document.createElement('tr'); tr.dataset.logIndex = globalIndex; if (state.isMobile) { tr.innerHTML = `<td><div class="mobile-log-row"><div class="domain" title="${log.query_name}">${log.query_name}</div><div class="time">${formatRelativeTime(log.query_time)}</div><div class="meta"><span class="client">${aliasManager.getDisplayName(log.client_ip)}</span><span class="duration">${log.duration_ms.toFixed(0)}ms</span>${getResponseTagHTML(log)}${getRuleTagHTML(log)}</div></div></td>`; } else { tr.innerHTML = `<td>${formatRelativeTime(log.query_time)}</td><td>${renderDomainResponseCellHTML(log)}</td><td>${log.query_type}</td><td class="text-right">${log.duration_ms.toFixed(2)}</td><td>${aliasManager.getAliasedClientHTML(log.client_ip)}</td>`; } return tr; }
        function renderSlowestQueryItemHTML(log, index) { const tr = document.createElement('tr'); tr.dataset.logIndex = index; tr.dataset.logSource = 'slowest'; if (state.isMobile) { tr.innerHTML = `<td><div class="mobile-log-row"><div class="domain" title="${log.query_name}">${log.query_name}</div><div class="time">${formatRelativeTime(log.query_time)}</div><div class="meta"><span class="client">${aliasManager.getDisplayName(log.client_ip)}</span><span class="duration">${log.duration_ms.toFixed(0)}ms</span>${getResponseTagHTML(log)}${getRuleTagHTML(log)}</div></div></td>`; } else { tr.innerHTML = `<td>${renderDomainResponseCellHTML(log)}</td><td>${aliasManager.getAliasedClientHTML(log.client_ip)}</td><td class="text-right">${log.duration_ms.toFixed(2)}</td>`; } return tr; }
        function getTooltipHTML(data, source) { if (!data) return ''; const queryInfo = {}, responseInfo = {}; let answers = []; const copyIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg>`; if (['domain', 'client', 'domain_set'].includes(source)) { queryInfo['ËØ∑Ê±ÇÊï∞'] = data.count.toLocaleString(); } else { const { ra, aa, tc } = data.response_flags || {}; const flagItems = [ra && 'RA', aa && 'AA', tc && 'TC'].filter(Boolean); queryInfo['ÂÆåÊï¥ÂüüÂêç'] = `<div><small>${data.query_name}</small> <button class="copy-btn" data-copy-value="${data.query_name}" title="Â§çÂà∂ÂüüÂêç">${copyIcon}</button></div>`; queryInfo['Á≤æÁ°ÆÊó∂Èó¥'] = formatDate(data.query_time); queryInfo['ÂÆ¢Êà∑Á´Ø'] = aliasManager.getDisplayName(data.client_ip); queryInfo['Á±ªÂûã'] = data.query_type || 'N/A'; if (data.query_class) queryInfo['Á±ªÂà´'] = data.query_class; if (data.domain_set) queryInfo['ËßÑÂàô'] = data.domain_set; responseInfo['ËÄóÊó∂'] = `${data.duration_ms.toFixed(2)} ms`; responseInfo['Áä∂ÊÄÅ'] = data.response_code || 'N/A'; if (flagItems.length) responseInfo['Ê†áÂøó'] = flagItems.join(', '); if (data.trace_id) { queryInfo['Trace ID'] = `<div><small>${data.trace_id}</small> <button class="copy-btn" data-copy-value="${data.trace_id}" title="Â§çÂà∂Trace ID">${copyIcon}</button></div>`; } answers = data.answers || []; } const buildList = (obj) => Object.entries(obj).map(([key, value]) => `<li><strong>${key}:</strong> ${value}</li>`).join(''); let tooltipHTML = ``; if (Object.keys(queryInfo).length) tooltipHTML += `<h5>Êü•ËØ¢‰ø°ÊÅØ</h5><ul>${buildList(queryInfo)}</ul>`; if (Object.keys(responseInfo).length) tooltipHTML += `<h5 style="margin-top:0.75rem;">ÂìçÂ∫î‰ø°ÊÅØ</h5><ul>${buildList(responseInfo)}</ul>`; if (answers.length) tooltipHTML += `<h5 style="margin-top:0.75rem;">Â∫îÁ≠îËÆ∞ÂΩï (${answers.length})</h5><ul>${answers.map(ans => `<li>[${ans.type}] ${ans.data} <small>(TTL: ${ans.ttl}s)</small></li>`).join('')}</ul>`; return tooltipHTML; }

        const autoRefreshManager = {
            start() { this.stop(); if (state.autoRefresh.enabled && state.autoRefresh.intervalSeconds >= 5) { state.autoRefresh.intervalId = setInterval(updatePageData, state.autoRefresh.intervalSeconds * 1000); } },
            stop() { clearInterval(state.autoRefresh.intervalId); state.autoRefresh.intervalId = null; },
            updateSettings(enabled, seconds) { state.autoRefresh.enabled = enabled; state.autoRefresh.intervalSeconds = Math.max(seconds, 5); localStorage.setItem('mosdnsAutoRefresh', JSON.stringify({ enabled, intervalSeconds: state.autoRefresh.intervalSeconds })); this.start(); ui.showToast(`Ëá™Âä®Âà∑Êñ∞Â∑≤${enabled ? `ÂºÄÂêØ, È¢ëÁéá: ${state.autoRefresh.intervalSeconds}Áßí` : 'ÂÖ≥Èó≠'}`, 'success'); },
            loadSettings() { const saved = JSON.parse(localStorage.getItem('mosdnsAutoRefresh')); if (saved) { state.autoRefresh.enabled = saved.enabled ?? true; state.autoRefresh.intervalSeconds = saved.intervalSeconds || CONSTANTS.DEFAULT_AUTO_REFRESH_INTERVAL; } elements.autoRefreshToggle.checked = state.autoRefresh.enabled; elements.autoRefreshIntervalInput.value = state.autoRefresh.intervalSeconds; elements.autoRefreshIntervalInput.disabled = !state.autoRefresh.enabled; }
        };

        function handleNavigation(targetLink) {
            elements.tabLinks.forEach(link => link.classList.remove('active'));
            targetLink.classList.add('active');
            
            requestAnimationFrame(() => updateNavSlider(targetLink));

            const newHash = targetLink.getAttribute('href');
            if (window.location.hash !== newHash) history.pushState(null, '', newHash);
            
            const activeTabId = targetLink.dataset.tab;
            elements.tabContents.forEach(el => el.classList.toggle('active', el.id === `${activeTabId}-tab`));
            
            if (activeTabId === 'log-query' && state.displayedLogs.length === 0) {
                applyLogFilterAndRender();
            } else if (activeTabId === 'rules') {
                if (state.adguardRules.length === 0) adguardManager.load();
                if (state.diversionRules.length === 0) diversionManager.load();
            }
        }
        
        function handleResize() { 
            const wasMobile = state.isMobile; 
            state.isMobile = window.innerWidth <= CONSTANTS.MOBILE_BREAKPOINT; 
            if (wasMobile !== state.isMobile) { 
                document.getElementById('slowest-queries-table')?.classList.toggle('mobile-card-layout', state.isMobile); 
                elements.logTable?.classList.toggle('mobile-card-layout', state.isMobile); 
                const activeTab = document.querySelector('.tab-link.active')?.dataset.tab; 
                if (activeTab === 'log-query') ui.renderLogTable(state.displayedLogs); 
                else if (activeTab === 'overview') renderSlowestQueries(state.slowestQueries); 
                else if (activeTab === 'rules') { adguardManager.render(); diversionManager.render(); }
                updateLastUpdated(); 
            } 
            if (state.isTouchDevice) elements.body.classList.add('touch'); 
            else elements.body.classList.remove('touch'); 
            requestAnimationFrame(() => { 
                const activeLink = document.querySelector('.tab-link.active'); 
                if (activeLink) updateNavSlider(activeLink); 
            }); 
        }
        
        function renderRuleTable(tbody, rules, mode) { tbody.closest('table').classList.toggle('mobile-rule-card-layout', state.isMobile); const sortedRules = [...rules].sort((a, b) => a.name.localeCompare(b.name)); renderTable(tbody, sortedRules, (rule, index) => { const item = state.isMobile ? renderRuleMobileCard(rule, mode) : renderRuleTableRow(rule, mode); item.dataset.ruleId = mode === 'adguard' ? rule.id : rule.name; if(rule.type) item.dataset.ruleType = rule.type; return item; }, mode); }
        function renderRuleTableRow(rule, mode) { const tr = document.createElement('tr'); const lastUpdated = rule.last_updated && !rule.last_updated.startsWith('0001-01-01') ? new Date(rule.last_updated).toLocaleString('zh-CN', { hour12: false }).replace(/\//g, '-') : '‚Äî'; let html = `<td class="text-center"><label class="switch"><input type="checkbox" class="rule-enabled-toggle" ${rule.enabled ? 'checked' : ''}><span class="slider"></span></label></td><td>${rule.name}</td>`; if (mode === 'diversion') { html += `<td><span class="response-tag other">${rule.type}</span></td>`; } html += `<td><span class="truncate-text" title="${rule.url}">${rule.url}</span></td><td class="text-right">${(rule.rule_count || 0).toLocaleString()}</td><td>${lastUpdated}</td><td class="text-center"><div style="display: inline-flex; gap: 0.5rem; white-space: nowrap;">`; if (mode === 'diversion') { html += `<button class="button secondary rule-update-btn" style="padding: 0.4rem 0.8rem;" title="Êõ¥Êñ∞Ê≠§ËßÑÂàô"><span>Êõ¥Êñ∞</span></button>`; } html += `<button class="button secondary rule-edit-btn" style="padding: 0.4rem 0.8rem;"><span>ÁºñËæë</span></button><button class="button danger rule-delete-btn" style="padding: 0.4rem 0.8rem;"><span>Âà†Èô§</span></button></div></td>`; tr.innerHTML = html; return tr; }
        function renderRuleMobileCard(rule, mode) { const card = document.createElement('div'); card.className = 'rule-card'; const lastUpdated = rule.last_updated && !rule.last_updated.startsWith('0001-01-01') ? formatRelativeTime(rule.last_updated) : '‰ªéÊú™'; let metaHtml = `<span class="url" title="${rule.url}">${rule.url}</span>`; if (mode === 'diversion') { metaHtml += `<span><span class="response-tag other">${rule.type}</span></span>`; } metaHtml += `<span><strong>ËßÑÂàôÊï∞:</strong> ${(rule.rule_count || 0).toLocaleString()}</span><span><strong>Êõ¥Êñ∞‰∫é:</strong> ${lastUpdated}</span>`; let actionsHtml = ''; if (mode === 'diversion') { actionsHtml += `<button class="button secondary rule-update-btn"><span>Êõ¥Êñ∞</span></button>`; } actionsHtml += `<button class="button secondary rule-edit-btn"><span>ÁºñËæë</span></button><button class="button danger rule-delete-btn"><span>Âà†Èô§</span></button>`; card.innerHTML = `<div class="rule-card-toggle"><label class="switch"><input type="checkbox" class="rule-enabled-toggle" ${rule.enabled ? 'checked' : ''}><span class="slider"></span></label></div><div class="rule-card-name">${rule.name}</div><div class="rule-card-meta">${metaHtml}</div><div class="rule-card-actions">${actionsHtml}</div>`; return card; }
        async function handleAdguardUpdateCheck() { ui.setLoading(elements.checkAdguardUpdatesBtn, true); ui.showToast('Â∑≤ÂºÄÂßãÂú®ÂêéÂè∞Êõ¥Êñ∞ÊâÄÊúâÂêØÁî®ÁöÑÊã¶Êà™ËßÑÂàô...'); try { await api.fetch('/plugins/adguard/update', { method: 'POST' }); ui.showToast('Êõ¥Êñ∞ËØ∑Ê±ÇÂ∑≤ÂèëÈÄÅÔºå5ÁßíÂêéËá™Âä®Âà∑Êñ∞ÂàóË°®...', 'success'); await new Promise(resolve => setTimeout(resolve, 5000)); await adguardManager.load(); ui.showToast('Êã¶Êà™ËßÑÂàôÂàóË°®Â∑≤Âà∑Êñ∞ÔºÅ', 'success'); } catch (e) {} finally { ui.setLoading(elements.checkAdguardUpdatesBtn, false); } }
        async function handleRuleTableClick(event, mode) { const target = event.target.closest('button, input.rule-enabled-toggle'); if (!target) return; const itemElement = target.closest('[data-rule-id]'); if (!itemElement) return; const id = itemElement.dataset.ruleId; const rules = mode === 'adguard' ? state.adguardRules : state.diversionRules; const rule = rules.find(r => (mode === 'adguard' ? r.id : r.name) === id); if (!rule) return; if (target.matches('.rule-edit-btn')) { ui.openRuleModal(mode, rule); } else if (target.matches('.rule-delete-btn')) { if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ËßÑÂàô "${rule.name}" ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`)) { ui.setLoading(target, true); try { if (mode === 'adguard') { await api.fetch(`/plugins/adguard/rules/${id}`, { method: 'DELETE' }); } else { await api.fetch(`/plugins/${diversionManager.sdSetInstanceMap[rule.type]}/config/${id}`, { method: 'DELETE' }); } ui.showToast(`ËßÑÂàô "${rule.name}" Â∑≤Âà†Èô§`); await (mode === 'adguard' ? adguardManager.load() : diversionManager.load()); } catch(e) { console.error(`Failed to delete rule ${id}:`, e); } finally { ui.setLoading(target, false); } } } else if (target.matches('.rule-update-btn')) { ui.setLoading(target, true); ui.showToast(`Ê≠£Âú®ÂêéÂè∞Êõ¥Êñ∞ËßÑÂàô "${rule.name}"...`); try { await api.fetch(`/plugins/${diversionManager.sdSetInstanceMap[rule.type]}/update/${id}`, { method: 'POST' }); ui.showToast('Êõ¥Êñ∞ËØ∑Ê±ÇÂ∑≤ÂèëÈÄÅ, 5ÁßíÂêéËá™Âä®Âà∑Êñ∞', 'success'); setTimeout(() => diversionManager.load(), 5000); } catch(e) {} finally { ui.setLoading(target, false); } } else if (target.matches('.rule-enabled-toggle')) { const updatedRule = { ...rule, enabled: target.checked }; target.disabled = true; try { if (mode === 'adguard') await api.fetch(`/plugins/adguard/rules/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(updatedRule) }); else await api.fetch(`/plugins/${diversionManager.sdSetInstanceMap[rule.type]}/config/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(updatedRule) }); rule.enabled = target.checked; ui.showToast(`ËßÑÂàô "${rule.name}" Â∑≤${target.checked ? 'ÂêØÁî®' : 'Á¶ÅÁî®'}`); } catch (error) { target.checked = !target.checked; } finally { target.disabled = false; } } }
        async function handleRuleFormSubmit(event) { event.preventDefault(); ui.setLoading(elements.saveRuleBtn, true); const form = elements.ruleForm; const mode = form.elements['mode'].value; const id = form.elements['id'].value; try { if (mode === 'adguard') { const data = { name: form.elements['name'].value, url: form.elements['url'].value, auto_update: form.elements['auto_update'].checked, update_interval_hours: parseInt(form.elements['update_interval_hours'].value, 10) || 24 }; if (id) { const originalRule = state.adguardRules.find(r => r.id === id); await api.fetch(`/plugins/adguard/rules/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...originalRule, ...data }) }); } else { await api.fetch('/plugins/adguard/rules', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...data, enabled: true }) }); } ui.showToast(`ÂπøÂëäÊã¶Êà™ËßÑÂàô${id ? 'Êõ¥Êñ∞' : 'Ê∑ªÂä†'}ÊàêÂäü`); await adguardManager.load(); } else { const data = { name: form.elements['name'].value, url: form.elements['url'].value, type: form.elements['type'].value, files: form.elements['files'].value, auto_update: form.elements['auto_update'].checked, update_interval_hours: parseInt(form.elements['update_interval_hours'].value, 10) || 24 }; const pluginTag = diversionManager.sdSetInstanceMap[data.type]; if (!pluginTag) throw new Error('Êó†ÊïàÁöÑÂàÜÊµÅËßÑÂàôÁ±ªÂûã'); if (id) { const originalRule = state.diversionRules.find(r => r.name === id); if (data.name !== id) { if (!confirm(`ËßÑÂàôÂêçÁß∞Â∑≤‰ªé "${id}" Êõ¥Êîπ‰∏∫ "${data.name}"„ÄÇ\n\nËøôÂ∞ÜÂà†Èô§ÊóßËßÑÂàôÂπ∂ÂàõÂª∫‰∏Ä‰∏™Êñ∞ËßÑÂàôÔºåÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü`)) throw new Error('User cancelled name change.'); await api.fetch(`/plugins/${diversionManager.sdSetInstanceMap[originalRule.type]}/config/${id}`, { method: 'DELETE' }); await api.fetch(`/plugins/${pluginTag}/config/${data.name}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...data, enabled: originalRule.enabled }) }); } else { await api.fetch(`/plugins/${pluginTag}/config/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...originalRule, ...data }) }); } } else { await api.fetch(`/plugins/${pluginTag}/config/${data.name}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...data, enabled: true }) }); } ui.showToast(`ÂàÜÊµÅËßÑÂàô${id ? 'Êõ¥Êñ∞' : 'Ê∑ªÂä†'}ÊàêÂäü`); await diversionManager.load(); if (!id || (id && data.name !== id)) { ui.showToast('Ê≠£Âú®ÂêéÂè∞Ëé∑ÂèñËßÑÂàôËØ¶ÊÉÖ...'); setTimeout(() => diversionManager.load(), 5000); } } ui.closeRuleModal(); } catch (err) { console.error(`${mode} form submission failed:`, err); } finally { ui.setLoading(elements.saveRuleBtn, false); } }
        const adguardManager = { async load() { try { state.adguardRules = await api.fetch('/plugins/adguard/rules') || []; } catch (error) { state.adguardRules = []; } this.render(); }, render() { renderRuleTable(elements.adguardRulesTbody, state.adguardRules, 'adguard'); }, };
        const diversionManager = { sdSetInstanceMap: { 'geositecn': 'geosite_cn', 'geositenocn': 'geosite_no_cn', 'geoipcn': 'geoip_cn' }, async load() { try { const promises = Object.values(this.sdSetInstanceMap).map(tag => api.fetch(`/plugins/${tag}/config`)); const results = await Promise.allSettled(promises); state.diversionRules = results.filter(r => r.status === 'fulfilled' && Array.isArray(r.value)).flatMap(r => r.value); } catch(e) { state.diversionRules = []; } this.render(); }, render() { renderRuleTable(elements.diversionRulesTbody, state.diversionRules, 'diversion'); }, };

        function setupEventListeners() {
            elements.tabLinks.forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); handleNavigation(link); }));
            window.addEventListener('popstate', () => { const hash = window.location.hash || '#overview'; const targetLink = document.querySelector(`.tab-link[href="${hash}"]`); handleNavigation(targetLink || elements.tabLinks[0]); });
            window.addEventListener('resize', debounce(handleResize, 150));
            elements.globalRefreshBtn?.addEventListener('click', updatePageData);
            setInterval(updateLastUpdated, 5000);
            elements.autoRefreshForm.addEventListener('change', (e) => { if(['checkbox', 'number'].includes(e.target.type)) { const enabled = elements.autoRefreshToggle.checked; const interval = parseInt(elements.autoRefreshIntervalInput.value, 10); elements.autoRefreshIntervalInput.disabled = !enabled; autoRefreshManager.updateSettings(enabled, interval); } });
            document.addEventListener('visibilitychange', () => document.hidden ? autoRefreshManager.stop() : autoRefreshManager.start());
            elements.toggleAuditBtn?.addEventListener('click', async (e) => { ui.setLoading(e.currentTarget, true); try { await (state.isCapturing ? api.stop() : api.start()); } catch (error) { console.error("Êìç‰ΩúÂ§±Ë¥•:", error); } await updatePageData(); });
            elements.clearAuditBtn?.addEventListener('click', async (e) => { if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂÜÖÂ≠òÂÆ°ËÆ°Êó•ÂøóÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ')) { ui.setLoading(e.currentTarget, true); try { await api.clear(); ui.showToast('Êó•ÂøóÂ∑≤Ê∏ÖÁ©∫', 'success'); if (elements.logSearch) elements.logSearch.value = ''; } catch (error) { ui.showToast('Ê∏ÖÁ©∫Êó•ÂøóÂ§±Ë¥•', 'error'); } finally { await updatePageData(); ui.setLoading(e.currentTarget, false); } } });
            elements.capacityForm?.addEventListener('submit', async (e) => { e.preventDefault(); const newCapacity = parseInt(elements.newCapacityInput.value, 10); if (!newCapacity || newCapacity <= 0 || newCapacity > 400000) { ui.showToast('ËØ∑ËæìÂÖ•1Âà∞400000‰πãÈó¥ÁöÑÊúâÊïàÂÆπÈáè', 'error'); return; } if (confirm(`Á°ÆÂÆöË¶ÅÂ∞ÜÂÆπÈáèËÆæÁΩÆ‰∏∫ ${newCapacity.toLocaleString()} ÂêóÔºü\n\nÊ≥®ÊÑèÔºöËøôÂ∞ÜÊ∏ÖÁ©∫ÂΩìÂâçÊâÄÊúâÊó•Âøó„ÄÇ`)) { ui.setLoading(e.currentTarget.querySelector('button'), true); try { await api.setCapacity(newCapacity); ui.showToast(`ÂÆπÈáèÂ∑≤ÊàêÂäüËÆæÁΩÆ‰∏∫ ${newCapacity.toLocaleString()}`, 'success'); elements.newCapacityInput.value = ''; } catch (error) { console.error("Set capacity failed:", error); } finally { await updatePageData(); ui.setLoading(e.currentTarget.querySelector('button'), false); } } });
            elements.clearCacheBtn?.addEventListener('click', async (e) => { if(confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâDNSÁºìÂ≠òÂêóÔºü')) { ui.setLoading(e.currentTarget, true); try { await api.cache.clear(); ui.showToast('ÊâÄÊúâÁºìÂ≠òÂ∑≤Ê∏ÖÁ©∫', 'success'); } catch(err) { ui.showToast('Ê∏ÖÁ©∫ÁºìÂ≠òÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü• Mosdns ÊòØÂê¶ÂåÖÂê´ cache Êèí‰ª∂ÁöÑ clear_cache Êé•Âè£„ÄÇ', 'error'); } finally { ui.setLoading(e.currentTarget, false); } } });
            elements.logSearch?.addEventListener('input', debounce(applyLogFilterAndRender, 300));
            elements.logQueryTableContainer?.addEventListener('scroll', () => { const { scrollTop, scrollHeight, clientHeight } = elements.logQueryTableContainer; if (clientHeight + scrollTop >= scrollHeight - 200) loadMoreLogs(); });
            elements.body.addEventListener('click', e => { const target = e.target.closest('.clickable-link, .tab-link-action, .copy-btn'); if(!target) return; if (target.matches('.copy-btn')) { e.stopPropagation(); navigator.clipboard.writeText(target.dataset.copyValue).then(() => ui.showToast('Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø')).catch(() => ui.showToast('Â§çÂà∂Â§±Ë¥•', 'error')); return; } e.preventDefault(); if (target.matches('.clickable-link')) { if (elements.logSearch) { const value = target.dataset.filterValue; const isExact = target.dataset.exactSearch === 'true'; elements.logSearch.value = isExact ? `"${value}"` : value; } const logQueryLink = document.querySelector('.tab-link[href="#log-query"]'); if (logQueryLink) handleNavigation(logQueryLink); applyLogFilterAndRender(); } else if (target.matches('.tab-link-action')) { const link = document.querySelector(`.tab-link[data-tab="${target.dataset.tab}"]`); if(link) handleNavigation(link); } });
            
            if (state.isTouchDevice) {
                elements.body.addEventListener('click', e => { 
                    const trigger = e.target.closest('[data-log-index], [data-rank-index], [data-rule-id]'); 
                    if (trigger) { tooltipManager.show(trigger); return; } 
                    if (!e.target.closest('#answers-tooltip')) tooltipManager.hide(); 
                });
            } else {
                elements.body.addEventListener('mouseover', e => { 
                    const trigger = e.target.closest('[data-log-index], [data-rank-index], [data-rule-id]'); 
                    if (trigger) tooltipManager.handleTriggerEnter(trigger); 
                });
                elements.body.addEventListener('mouseout', e => { 
                    const trigger = e.target.closest('[data-log-index], [data-rank-index], [data-rule-id]'); 
                    if (trigger) tooltipManager.handleTriggerLeave(); 
                });
                elements.tooltip.addEventListener('mouseenter', () => tooltipManager.handleTooltipEnter());
                elements.tooltip.addEventListener('mouseleave', () => tooltipManager.handleTooltipLeave());
            }

            if (elements.aliasModal) { [elements.manageAliasesBtn, elements.manageAliasesBtnMobile].forEach(btn => btn?.addEventListener('click', async () => { await aliasManager.renderEditableList(); elements.aliasModal.showModal(); })); document.getElementById('close-alias-modal')?.addEventListener('click', () => elements.aliasModal.close()); elements.saveAllAliasesBtn?.addEventListener('click', async () => { ui.setLoading(elements.saveAllAliasesBtn, true); await aliasManager.saveAll(); ui.setLoading(elements.saveAllAliasesBtn, false); }); document.getElementById('export-aliases-btn')?.addEventListener('click', () => aliasManager.export()); document.getElementById('import-aliases-btn')?.addEventListener('click', () => elements.importAliasInput?.click()); elements.importAliasInput?.addEventListener('change', (e) => { if (e.target.files?.length > 0) { aliasManager.import(e.target.files[0]); e.target.value = ''; } }); elements.manualAliasForm.addEventListener('submit', async (e) => { e.preventDefault(); ui.setLoading(e.currentTarget.querySelector('button'), true); const ip = document.getElementById('manual-alias-ip').value.trim(); const name = document.getElementById('manual-alias-name').value.trim(); if(ip && name) { aliasManager.set(ip, name); aliasManager.save(); ui.showToast(`Â∑≤Ê∑ªÂä†Âà´Âêç: ${name} -> ${ip}`); e.target.reset(); await aliasManager.renderEditableList(); await updatePageData(); } else { ui.showToast('IPÂú∞ÂùÄÂíåÂà´ÂêçÂùá‰∏çËÉΩ‰∏∫Á©∫', 'error'); } ui.setLoading(e.currentTarget.querySelector('button'), false); }); }
            elements.ruleForm.addEventListener('submit', handleRuleFormSubmit);
            elements.closeRuleModalBtn.addEventListener('click', () => ui.closeRuleModal());
            elements.cancelRuleModalBtn.addEventListener('click', () => ui.closeRuleModal());
            elements.addAdguardRuleBtn.addEventListener('click', () => ui.openRuleModal('adguard'));
            elements.checkAdguardUpdatesBtn.addEventListener('click', handleAdguardUpdateCheck);
            elements.adguardRulesTbody.addEventListener('click', (e) => handleRuleTableClick(e, 'adguard'));
            elements.addDiversionRuleBtn.addEventListener('click', () => ui.openRuleModal('diversion'));
            elements.diversionRulesTbody.addEventListener('click', (e) => handleRuleTableClick(e, 'diversion'));
            elements.rulesSubNavLinks.forEach(link => { link.addEventListener('click', () => { elements.rulesSubNavLinks.forEach(l => l.classList.remove('active')); link.classList.add('active'); const tabId = link.dataset.subTab; elements.rulesSubTabContents.forEach(content => { content.classList.toggle('active', content.id === `${tabId}-sub-tab`); }); }); });
        }
        
        async function init() {
            state.isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
            themeManager.init();
            aliasManager.load();
            historyManager.load();
            autoRefreshManager.loadSettings();
            tableSorter.init();
            setupEventListeners();
            setupGlowEffect();
            handleResize();
            
            const initialHash = window.location.hash || '#overview';
            const initialLink = document.querySelector(`.tab-link[href="${initialHash}"]`);
            if (initialLink) handleNavigation(initialLink);

            await updatePageData();

            if (document.fonts?.ready) {
                await document.fonts.ready;
            }
            
            requestAnimationFrame(() => {
                 const activeLink = document.querySelector('.tab-link.active');
                 if(activeLink) updateNavSlider(activeLink);
            });
            
            elements.initialLoader.style.opacity = '0';
            elements.initialLoader.addEventListener('transitionend', () => elements.initialLoader.remove());
            
            if (!document.hidden) autoRefreshManager.start();
        }

        init();
    });
    </script>
</body>
</html>
